

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>lightweaver.atmosphere &mdash; Lightweaver  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery-dataframe.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Lightweaver
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../auto_examples/index.html">Lightweaver Examples Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lightweaver-api.html">Lightweaver API Documentation</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Lightweaver</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>lightweaver.atmosphere</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for lightweaver.atmosphere</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">asdict</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span><span class="p">,</span> <span class="n">auto</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">Type</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">.witt</span> <span class="kn">import</span> <span class="n">witt</span>
<span class="kn">import</span> <span class="nn">lightweaver.constants</span> <span class="k">as</span> <span class="nn">Const</span>
<span class="kn">from</span> <span class="nn">numpy.polynomial.legendre</span> <span class="kn">import</span> <span class="n">leggauss</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">ConvergenceError</span><span class="p">,</span> <span class="n">view_flatten</span><span class="p">,</span> <span class="n">get_data_path</span>
<span class="kn">from</span> <span class="nn">.atomic_table</span> <span class="kn">import</span> <span class="n">PeriodicTable</span><span class="p">,</span> <span class="n">AtomicAbundance</span><span class="p">,</span> <span class="n">DefaultAtomicAbundance</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.LwCompiled</span> <span class="kn">import</span> <span class="n">LwSpectrum</span>

<div class="viewcode-block" id="ScaleType"><a class="viewcode-back" href="../../lightweaver-api.html#lightweaver.atmosphere.ScaleType">[docs]</a><span class="k">class</span> <span class="nc">ScaleType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Atmospheric scales used in the definition of 1D atmospheres to allow the</span>
<span class="sd">    correct conversion to a height based system.</span>
<span class="sd">    Options:</span>

<span class="sd">        - `Geometric`</span>

<span class="sd">        - `ColumnMass`</span>

<span class="sd">        - `Tau500`</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">Geometric</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ColumnMass</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">Tau500</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span></div>

<div class="viewcode-block" id="BoundaryCondition"><a class="viewcode-back" href="../../lightweaver-api.html#lightweaver.atmosphere.BoundaryCondition">[docs]</a><span class="k">class</span> <span class="nc">BoundaryCondition</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Base class for boundary conditions.</span>

<span class="sd">    Defines the interface; do not use directly.</span>
<span class="sd">    &#39;&#39;&#39;</span>
<div class="viewcode-block" id="BoundaryCondition.compute_bc"><a class="viewcode-back" href="../../lightweaver-api.html#lightweaver.atmosphere.BoundaryCondition.compute_bc">[docs]</a>    <span class="k">def</span> <span class="nf">compute_bc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atmos</span><span class="p">:</span> <span class="s1">&#39;Atmosphere&#39;</span><span class="p">,</span> <span class="n">spect</span><span class="p">:</span> <span class="s1">&#39;LwSpectrum&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Called when the radiation boundary condition is needed by the backend.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        atmos : Atmosphere</span>
<span class="sd">            The atmospheric object in which to compute the radiation.</span>
<span class="sd">        spect : LwSpectrum</span>
<span class="sd">            The computational spectrum object provided by the Context.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        result : np.ndarray</span>
<span class="sd">            This function needs to return a contiguous array of shape [Nwave,</span>
<span class="sd">            Nrays, Nbc], where Nwave is the number of wavelengths in the</span>
<span class="sd">            wavelength grid, Nrays is the number of rays in the angular</span>
<span class="sd">            quadrature (also including up/down directions) ordered as per</span>
<span class="sd">            [mu[0] down, mu[0] up, mu[1] down...], Nbc is the number of</span>
<span class="sd">            spatial positions the boundary condition needs to be defined at</span>
<span class="sd">            ordered in a flattened [Nz, Ny, Nx] fashion. (dtype: &lt;f8)</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>

<div class="viewcode-block" id="NoBc"><a class="viewcode-back" href="../../lightweaver-api.html#lightweaver.atmosphere.NoBc">[docs]</a><span class="k">class</span> <span class="nc">NoBc</span><span class="p">(</span><span class="n">BoundaryCondition</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Indicates no boundary condition on the axis because it is invalid for the</span>
<span class="sd">    current simulation.</span>
<span class="sd">    Used only by the backend.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="ZeroRadiation"><a class="viewcode-back" href="../../lightweaver-api.html#lightweaver.atmosphere.ZeroRadiation">[docs]</a><span class="k">class</span> <span class="nc">ZeroRadiation</span><span class="p">(</span><span class="n">BoundaryCondition</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Zero radiation boundary condition.</span>
<span class="sd">    Commonly used for coronal situations.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="ThermalisedRadiation"><a class="viewcode-back" href="../../lightweaver-api.html#lightweaver.atmosphere.ThermalisedRadiation">[docs]</a><span class="k">class</span> <span class="nc">ThermalisedRadiation</span><span class="p">(</span><span class="n">BoundaryCondition</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Thermalised radiation (blackbody) boundary condition.</span>
<span class="sd">    Commonly used for photospheric situations.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="PeriodicRadiation"><a class="viewcode-back" href="../../lightweaver-api.html#lightweaver.atmosphere.PeriodicRadiation">[docs]</a><span class="k">class</span> <span class="nc">PeriodicRadiation</span><span class="p">(</span><span class="n">BoundaryCondition</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Periodic boundary condition.</span>
<span class="sd">    Commonly used on the x-axis in 2D simulations.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="get_top_pressure"><a class="viewcode-back" href="../../lightweaver-api.html#lightweaver.atmosphere.get_top_pressure">[docs]</a><span class="k">def</span> <span class="nf">get_top_pressure</span><span class="p">(</span><span class="n">eos</span><span class="p">:</span> <span class="n">witt</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">ne</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Return a pressure for the top of atmosphere.</span>
<span class="sd">    For internal use.</span>

<span class="sd">    In order this is deduced from:</span>
<span class="sd">        - the electron density `ne`, if provided</span>
<span class="sd">        - the mass density `rho`, if provided</span>
<span class="sd">        - the electron pressure present in FALC</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pressure : float</span>
<span class="sd">        pressure IN CGS [dyn cm-2]</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">ne</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pe</span> <span class="o">=</span> <span class="n">ne</span> <span class="o">*</span> <span class="n">Const</span><span class="o">.</span><span class="n">CM_TO_M</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">eos</span><span class="o">.</span><span class="n">BK</span> <span class="o">*</span> <span class="n">temp</span>
        <span class="k">return</span> <span class="n">eos</span><span class="o">.</span><span class="n">pg_from_pe</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">pe</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">rho</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">eos</span><span class="o">.</span><span class="n">pg_from_rho</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">rho</span><span class="p">)</span>

    <span class="n">pgasCgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.70575286</span><span class="p">,</span> <span class="mf">0.59018545</span><span class="p">,</span> <span class="mf">0.51286639</span><span class="p">,</span> <span class="mf">0.43719268</span><span class="p">,</span> <span class="mf">0.37731009</span><span class="p">,</span>
        <span class="mf">0.33516886</span><span class="p">,</span> <span class="mf">0.31342915</span><span class="p">,</span> <span class="mf">0.30604891</span><span class="p">,</span> <span class="mf">0.30059491</span><span class="p">,</span> <span class="mf">0.29207645</span><span class="p">,</span>
        <span class="mf">0.2859011</span> <span class="p">,</span> <span class="mf">0.28119224</span><span class="p">,</span> <span class="mf">0.27893046</span><span class="p">,</span> <span class="mf">0.27949676</span><span class="p">,</span> <span class="mf">0.28299726</span><span class="p">,</span>
        <span class="mf">0.28644693</span><span class="p">,</span> <span class="mf">0.28825946</span><span class="p">,</span> <span class="mf">0.29061192</span><span class="p">,</span> <span class="mf">0.29340255</span><span class="p">,</span> <span class="mf">0.29563072</span><span class="p">,</span>
        <span class="mf">0.29864548</span><span class="p">,</span> <span class="mf">0.30776456</span><span class="p">,</span> <span class="mf">0.31825915</span><span class="p">,</span> <span class="mf">0.32137574</span><span class="p">,</span> <span class="mf">0.3239401</span> <span class="p">,</span>
        <span class="mf">0.32622212</span><span class="p">,</span> <span class="mf">0.32792196</span><span class="p">,</span> <span class="mf">0.3292243</span> <span class="p">,</span> <span class="mf">0.33025437</span><span class="p">,</span> <span class="mf">0.33146736</span><span class="p">,</span>
        <span class="mf">0.3319676</span> <span class="p">,</span> <span class="mf">0.33217821</span><span class="p">,</span> <span class="mf">0.3322355</span> <span class="p">,</span> <span class="mf">0.33217166</span><span class="p">,</span> <span class="mf">0.33210297</span><span class="p">,</span>
        <span class="mf">0.33203833</span><span class="p">,</span> <span class="mf">0.33198508</span><span class="p">])</span>
    <span class="n">tempCoord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>  <span class="mf">7600.</span><span class="p">,</span>   <span class="mf">7780.</span><span class="p">,</span>   <span class="mf">7970.</span><span class="p">,</span>   <span class="mf">8273.</span><span class="p">,</span>   <span class="mf">8635.</span><span class="p">,</span>   <span class="mf">8988.</span><span class="p">,</span>   <span class="mf">9228.</span><span class="p">,</span>
        <span class="mf">9358.</span><span class="p">,</span>   <span class="mf">9458.</span><span class="p">,</span>   <span class="mf">9587.</span><span class="p">,</span>   <span class="mf">9735.</span><span class="p">,</span>   <span class="mf">9983.</span><span class="p">,</span>  <span class="mf">10340.</span><span class="p">,</span>  <span class="mf">10850.</span><span class="p">,</span>
        <span class="mf">11440.</span><span class="p">,</span>  <span class="mf">12190.</span><span class="p">,</span>  <span class="mf">13080.</span><span class="p">,</span>  <span class="mf">14520.</span><span class="p">,</span>  <span class="mf">16280.</span><span class="p">,</span>  <span class="mf">17930.</span><span class="p">,</span>  <span class="mf">20420.</span><span class="p">,</span>
        <span class="mf">24060.</span><span class="p">,</span>  <span class="mf">27970.</span><span class="p">,</span>  <span class="mf">32150.</span><span class="p">,</span>  <span class="mf">36590.</span><span class="p">,</span>  <span class="mf">41180.</span><span class="p">,</span>  <span class="mf">45420.</span><span class="p">,</span>  <span class="mf">49390.</span><span class="p">,</span>
        <span class="mf">53280.</span><span class="p">,</span>  <span class="mf">60170.</span><span class="p">,</span>  <span class="mf">66150.</span><span class="p">,</span>  <span class="mf">71340.</span><span class="p">,</span>  <span class="mf">75930.</span><span class="p">,</span>  <span class="mf">83890.</span><span class="p">,</span>  <span class="mf">90820.</span><span class="p">,</span>
        <span class="mf">95600.</span><span class="p">,</span> <span class="mf">100000.</span><span class="p">])</span>

    <span class="n">ptop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">tempCoord</span><span class="p">,</span> <span class="n">pgasCgs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ptop</span></div>

<div class="viewcode-block" id="Stratifications"><a class="viewcode-back" href="../../lightweaver-api.html#lightweaver.atmosphere.Stratifications">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Stratifications</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Stores the optional derived z-stratifications of an atmospheric model.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    cmass : np.ndarray</span>
<span class="sd">        Column mass [kg m-2].</span>
<span class="sd">    tauRef : np.ndarray</span>
<span class="sd">        Reference optical depth at 500 nm.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">cmass</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">tauRef</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>

<div class="viewcode-block" id="Stratifications.dimensioned_view"><a class="viewcode-back" href="../../lightweaver-api.html#lightweaver.atmosphere.Stratifications.dimensioned_view">[docs]</a>    <span class="k">def</span> <span class="nf">dimensioned_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Stratifications&#39;</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Makes an instance of `Stratifications` reshaped to the provided</span>
<span class="sd">        shape for multi-dimensional atmospheres.</span>
<span class="sd">        For internal use.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        shape : tuple</span>
<span class="sd">            Shape to reform the stratifications, provided by</span>
<span class="sd">            `Layout.dimensioned_shape`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        stratifications : Stratifications</span>
<span class="sd">            Reshaped stratifications.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">cmass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmass</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">tauRef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tauRef</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">strat</span></div>

<div class="viewcode-block" id="Stratifications.unit_view"><a class="viewcode-back" href="../../lightweaver-api.html#lightweaver.atmosphere.Stratifications.unit_view">[docs]</a>    <span class="k">def</span> <span class="nf">unit_view</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Stratifications&#39;</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Makes an instance of `Stratifications`  with the correct `astropy.units`</span>
<span class="sd">        For internal use.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        stratifications : Stratifications</span>
<span class="sd">            The same data with units applied.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">cmass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmass</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">kg</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">tauRef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tauRef</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span>
        <span class="k">return</span> <span class="n">strat</span></div>

<div class="viewcode-block" id="Stratifications.dimensioned_unit_view"><a class="viewcode-back" href="../../lightweaver-api.html#lightweaver.atmosphere.Stratifications.dimensioned_unit_view">[docs]</a>    <span class="k">def</span> <span class="nf">dimensioned_unit_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Stratifications&#39;</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Makes an instance of `Stratifications` reshaped to the provided shape</span>
<span class="sd">        with the correct `astropy.units` for multi-dimensional atmospheres.</span>
<span class="sd">        For internal use.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        shape : tuple</span>
<span class="sd">            Shape to reform the stratifications, provided by</span>
<span class="sd">            `Layout.dimensioned_shape`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        stratifications : Stratifications</span>
<span class="sd">            Reshaped stratifications with units.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensioned_view</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">strat</span><span class="o">.</span><span class="n">unit_view</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="Layout"><a class="viewcode-back" href="../../lightweaver-api.html#lightweaver.atmosphere.Layout">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Layout</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Storage for basic atmospheric parameters whose presence is determined by problem dimensionality, boundary conditions and optional stratifications.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    Ndim : int</span>
<span class="sd">        Number of dimensions in model.</span>

<span class="sd">    x : np.ndarray</span>
<span class="sd">        Ordinates of grid points along the x-axis (present for Ndim &gt;= 2) [m].</span>
<span class="sd">    y : np.ndarray</span>
<span class="sd">        Ordinates of grid points along the y-axis (present for Ndim == 3) [m].</span>
<span class="sd">    z : np.ndarray</span>
<span class="sd">        Ordinates of grid points along the z-axis (present for all Ndim) [m].</span>
<span class="sd">    vx : np.ndarray</span>
<span class="sd">        x component of plasma velocity (present for Ndim &gt;= 2) [m/s].</span>
<span class="sd">    vy : np.ndarray</span>
<span class="sd">        y component of plasma velocity (present for Ndim == 3) [m/s].</span>
<span class="sd">    vz : np.ndarray</span>
<span class="sd">        z component of plasma velocity (present for all Ndim) [m/s]. Aliased to `vlos` when `Ndim==1`</span>
<span class="sd">    xLowerBc : BoundaryCondition</span>
<span class="sd">        Boundary condition for the plane of minimal x-coordinate.</span>
<span class="sd">    xUpperBc : BoundaryCondition</span>
<span class="sd">        Boundary condition for the plane of maximal x-coordinate.</span>
<span class="sd">    yLowerBc : BoundaryCondition</span>
<span class="sd">        Boundary condition for the plane of minimal y-coordinate.</span>
<span class="sd">    yUpperBc : BoundaryCondition</span>
<span class="sd">        Boundary condition for the plane of maximal y-coordinate.</span>
<span class="sd">    zLowerBc : BoundaryCondition</span>
<span class="sd">        Boundary condition for the plane of minimal z-coordinate.</span>
<span class="sd">    zUpperBc : BoundaryCondition</span>
<span class="sd">        Boundary condition for the plane of maximal z-coordinate.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">Ndim</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">z</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">vx</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">vy</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">vz</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">xLowerBc</span><span class="p">:</span> <span class="n">BoundaryCondition</span>
    <span class="n">xUpperBc</span><span class="p">:</span> <span class="n">BoundaryCondition</span>
    <span class="n">yLowerBc</span><span class="p">:</span> <span class="n">BoundaryCondition</span>
    <span class="n">yUpperBc</span><span class="p">:</span> <span class="n">BoundaryCondition</span>
    <span class="n">zLowerBc</span><span class="p">:</span> <span class="n">BoundaryCondition</span>
    <span class="n">zUpperBc</span><span class="p">:</span> <span class="n">BoundaryCondition</span>
    <span class="n">stratifications</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Stratifications</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Layout.make_1d"><a class="viewcode-back" href="../../lightweaver-api.html#lightweaver.atmosphere.Layout.make_1d">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">make_1d</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">vz</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                <span class="n">lowerBc</span><span class="p">:</span> <span class="n">BoundaryCondition</span><span class="p">,</span> <span class="n">upperBc</span><span class="p">:</span> <span class="n">BoundaryCondition</span><span class="p">,</span>
                <span class="n">stratifications</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Stratifications</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Layout&#39;</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Construct 1D Layout.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">Ndim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(()),</span> <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(()),</span>
                   <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">vx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(()),</span> <span class="n">vy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(()),</span>
                   <span class="n">vz</span><span class="o">=</span><span class="n">vz</span><span class="p">,</span> <span class="n">xLowerBc</span><span class="o">=</span><span class="n">NoBc</span><span class="p">(),</span> <span class="n">xUpperBc</span><span class="o">=</span><span class="n">NoBc</span><span class="p">(),</span>
                   <span class="n">yLowerBc</span><span class="o">=</span><span class="n">NoBc</span><span class="p">(),</span> <span class="n">yUpperBc</span><span class="o">=</span><span class="n">NoBc</span><span class="p">(),</span>
                   <span class="n">zLowerBc</span><span class="o">=</span><span class="n">lowerBc</span><span class="p">,</span> <span class="n">zUpperBc</span><span class="o">=</span><span class="n">upperBc</span><span class="p">,</span>
                   <span class="n">stratifications</span><span class="o">=</span><span class="n">stratifications</span><span class="p">)</span></div>

<div class="viewcode-block" id="Layout.make_2d"><a class="viewcode-back" href="../../lightweaver-api.html#lightweaver.atmosphere.Layout.make_2d">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">make_2d</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                <span class="n">vx</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">vz</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                <span class="n">xLowerBc</span><span class="p">:</span> <span class="n">BoundaryCondition</span><span class="p">,</span> <span class="n">xUpperBc</span><span class="p">:</span> <span class="n">BoundaryCondition</span><span class="p">,</span>
                <span class="n">zLowerBc</span><span class="p">:</span> <span class="n">BoundaryCondition</span><span class="p">,</span> <span class="n">zUpperBc</span><span class="p">:</span> <span class="n">BoundaryCondition</span><span class="p">,</span>
                <span class="n">stratifications</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Stratifications</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Layout&#39;</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Construct 2D Layout.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">Bc</span> <span class="o">=</span> <span class="n">BoundaryCondition</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">Ndim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(()),</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span>
                   <span class="n">vx</span><span class="o">=</span><span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(()),</span> <span class="n">vz</span><span class="o">=</span><span class="n">vz</span><span class="p">,</span>
                   <span class="n">xLowerBc</span><span class="o">=</span><span class="n">xLowerBc</span><span class="p">,</span> <span class="n">xUpperBc</span><span class="o">=</span><span class="n">xUpperBc</span><span class="p">,</span>
                   <span class="n">yLowerBc</span><span class="o">=</span><span class="n">NoBc</span><span class="p">(),</span> <span class="n">yUpperBc</span><span class="o">=</span><span class="n">NoBc</span><span class="p">(),</span>
                   <span class="n">zLowerBc</span><span class="o">=</span><span class="n">zLowerBc</span><span class="p">,</span> <span class="n">zUpperBc</span><span class="o">=</span><span class="n">zUpperBc</span><span class="p">,</span>
                   <span class="n">stratifications</span><span class="o">=</span><span class="n">stratifications</span><span class="p">)</span></div>

<div class="viewcode-block" id="Layout.make_3d"><a class="viewcode-back" href="../../lightweaver-api.html#lightweaver.atmosphere.Layout.make_3d">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">make_3d</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                <span class="n">vx</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">vy</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">vz</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                <span class="n">xLowerBc</span><span class="p">:</span> <span class="n">BoundaryCondition</span><span class="p">,</span> <span class="n">xUpperBc</span><span class="p">:</span> <span class="n">BoundaryCondition</span><span class="p">,</span>
                <span class="n">yLowerBc</span><span class="p">:</span> <span class="n">BoundaryCondition</span><span class="p">,</span> <span class="n">yUpperBc</span><span class="p">:</span> <span class="n">BoundaryCondition</span><span class="p">,</span>
                <span class="n">zLowerBc</span><span class="p">:</span> <span class="n">BoundaryCondition</span><span class="p">,</span> <span class="n">zUpperBc</span><span class="p">:</span> <span class="n">BoundaryCondition</span><span class="p">,</span>
                <span class="n">stratifications</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Stratifications</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Layout&#39;</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Construct 3D Layout.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">Ndim</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span>
                   <span class="n">vx</span><span class="o">=</span><span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="o">=</span><span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="o">=</span><span class="n">vz</span><span class="p">,</span>
                   <span class="n">xLowerBc</span><span class="o">=</span><span class="n">xLowerBc</span><span class="p">,</span> <span class="n">xUpperBc</span><span class="o">=</span><span class="n">xUpperBc</span><span class="p">,</span>
                   <span class="n">yLowerBc</span><span class="o">=</span><span class="n">yLowerBc</span><span class="p">,</span> <span class="n">yUpperBc</span><span class="o">=</span><span class="n">yUpperBc</span><span class="p">,</span>
                   <span class="n">zLowerBc</span><span class="o">=</span><span class="n">zLowerBc</span><span class="p">,</span> <span class="n">zUpperBc</span><span class="o">=</span><span class="n">zUpperBc</span><span class="p">,</span>
                   <span class="n">stratifications</span><span class="o">=</span><span class="n">stratifications</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Nx</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Number of grid points along the x-axis.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Ny</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Number of grid points along the y-axis.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Nz</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Number of grid points along the z-axis.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Noutgoing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Number of grid points at which the outgoing radiation is computed.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ny</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vlos</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;vlos is ambiguous when Ndim &gt; 1, use vx, vy, or vz instead.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vz</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Nspace</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Number of spatial points present in the grid.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nz</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nz</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ny</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nz</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid Ndim: </span><span class="si">%d</span><span class="s1">, check geometry initialisation&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ndim</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tauRef</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Alias to `self.stratifications.tauRef`, if computed.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stratifications</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stratifications</span><span class="o">.</span><span class="n">tauRef</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;tauRef not computed for this Atmosphere&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cmass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Alias to `self.stratifications.cmass`, if computed.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stratifications</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stratifications</span><span class="o">.</span><span class="n">cmass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;tauRef not computed for this Atmosphere&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dimensioned_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Tuple defining the shape to which the arrays of atmospheric paramters</span>
<span class="sd">        can be reshaped to be indexed in a 1/2/3D fashion.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nz</span><span class="p">,)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nx</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ny</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unreasonable Ndim (</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ndim</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">shape</span>

<div class="viewcode-block" id="Layout.dimensioned_view"><a class="viewcode-back" href="../../lightweaver-api.html#lightweaver.atmosphere.Layout.dimensioned_view">[docs]</a>    <span class="k">def</span> <span class="nf">dimensioned_view</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span>  <span class="s1">&#39;Layout&#39;</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a view over the contents of Layout reshaped so all data has</span>
<span class="sd">        the correct (1/2/3D) dimensionality for the atmospheric model, as</span>
<span class="sd">        these are all stored under a flat scheme.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">layout</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensioned_shape</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stratifications</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">layout</span><span class="o">.</span><span class="n">stratifications</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stratifications</span><span class="o">.</span><span class="n">dimensioned_view</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vx</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">layout</span><span class="o">.</span><span class="n">vx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vy</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">layout</span><span class="o">.</span><span class="n">vy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vz</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">layout</span><span class="o">.</span><span class="n">vz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vz</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">layout</span></div>

<div class="viewcode-block" id="Layout.unit_view"><a class="viewcode-back" href="../../lightweaver-api.html#lightweaver.atmosphere.Layout.unit_view">[docs]</a>    <span class="k">def</span> <span class="nf">unit_view</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Layout&#39;</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a view over the contents of the Layout with the correct</span>
<span class="sd">        `astropy.units`.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">layout</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">vx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vx</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">vy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vy</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">vz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vz</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stratifications</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">layout</span><span class="o">.</span><span class="n">stratifications</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stratifications</span><span class="o">.</span><span class="n">unit_view</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">layout</span></div>

<div class="viewcode-block" id="Layout.dimensioned_unit_view"><a class="viewcode-back" href="../../lightweaver-api.html#lightweaver.atmosphere.Layout.dimensioned_unit_view">[docs]</a>    <span class="k">def</span> <span class="nf">dimensioned_unit_view</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Layout&#39;</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a view over the contents of Layout reshaped so all data has</span>
<span class="sd">        the correct (1/2/3D) dimensionality for the atmospheric model, and</span>
<span class="sd">        the correct `astropy.units`.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensioned_view</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">layout</span><span class="o">.</span><span class="n">unit_view</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="Atmosphere"><a class="viewcode-back" href="../../lightweaver-api.html#lightweaver.atmosphere.Atmosphere">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Atmosphere</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Storage for all atmospheric data. These arrays will be shared directly</span>
<span class="sd">    with the backend, so a modification here also modifies the data seen by</span>
<span class="sd">    the backend. Be careful to modify these arrays *in place*, as their data</span>
<span class="sd">    is shared by direct memory reference. Use the class methods to construct</span>
<span class="sd">    atmospheres of different dimensionality.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    structure : Layout</span>
<span class="sd">        A layout structure holding the atmospheric stratification, and</span>
<span class="sd">        velocity description.</span>
<span class="sd">    temperature : np.ndarray</span>
<span class="sd">        The atmospheric temperature structure.</span>
<span class="sd">    vturb : np.ndarray</span>
<span class="sd">        The atmospheric microturbulent velocity structure.</span>
<span class="sd">    ne : np.ndarray</span>
<span class="sd">        The electron density structure in the atmosphere.</span>
<span class="sd">    nHTot : np.ndarray</span>
<span class="sd">        The total hydrogen number density distribution throughout the</span>
<span class="sd">        atmosphere.</span>
<span class="sd">    B : np.ndarray, optional</span>
<span class="sd">        The magnitude of the stratified magnetic field throughout the</span>
<span class="sd">        atmosphere (Tesla).</span>
<span class="sd">    gammaB : np.ndarray, optional</span>
<span class="sd">        Co-altitude of magnetic field vector (radians) throughout the</span>
<span class="sd">        atmosphere from the local vertical.</span>
<span class="sd">    chiB : np.ndarray, optional</span>
<span class="sd">        Azimuth of magnetic field vector (radians) in the x-y plane, measured</span>
<span class="sd">        from the x-axis.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">structure</span><span class="p">:</span> <span class="n">Layout</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">vturb</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">ne</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">nHTot</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">B</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">gammaB</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">chiB</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Ndim</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Ndim : int</span>
<span class="sd">            The dimensionality (1, 2, or 3) of the atmospheric model.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">Ndim</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Nx</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Nx : int</span>
<span class="sd">            The number of points in the x-direction discretisation.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">Nx</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Ny</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Ny : int</span>
<span class="sd">            The number of points in the y-direction discretisation.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">Ny</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Nz</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Nz : int</span>
<span class="sd">            The number of points in the y-direction discretisation.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">Nz</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Noutgoing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Noutgoing : int</span>
<span class="sd">            The number of cells at the top of the atmosphere (that each produce a</span>
<span class="sd">            spectrum).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">Noutgoing</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vx</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        vx : np.ndarray</span>
<span class="sd">            x component of plasma velocity (present for Ndim &gt;= 2) [m/s].</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">vx</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        vy : np.ndarray</span>
<span class="sd">            y component of plasma velocity (present for Ndim == 3) [m/s].</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">vy</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vz</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        vz : np.ndarray</span>
<span class="sd">            z component of plasma velocity (present for all Ndim) [m/s]. Aliased</span>
<span class="sd">            to `vlos` when `Ndim==1`</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">vz</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vlos</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        vz : np.ndarray</span>
<span class="sd">            z component of plasma velocity (present for all Ndim) [m/s]. Only</span>
<span class="sd">            available when Ndim==1`.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">vlos</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cmass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        cmass : np.ndarray</span>
<span class="sd">            Column mass [kg m-2].</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">cmass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tauRef</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        tauRef : np.ndarray</span>
<span class="sd">            Reference optical depth at 500 nm.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">tauRef</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">height</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">z</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        x : np.ndarray</span>
<span class="sd">            Ordinates of grid points along the x-axis (present for Ndim &gt;= 2) [m].</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">x</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        y : np.ndarray</span>
<span class="sd">            Ordinates of grid points along the y-axis (present for Ndim == 3) [m].</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">y</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">z</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        z : np.ndarray</span>
<span class="sd">            Ordinates of grid points along the z-axis (present for all Ndim) [m].</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">z</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">zLowerBc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BoundaryCondition</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        zLowerBc : BoundaryCondition</span>
<span class="sd">            Boundary condition for the plane of minimal z-coordinate.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">zLowerBc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">zUpperBc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BoundaryCondition</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        zUpperBc : BoundaryCondition</span>
<span class="sd">            Boundary condition for the plane of maximal z-coordinate.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">zUpperBc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">yLowerBc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BoundaryCondition</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        yLowerBc : BoundaryCondition</span>
<span class="sd">            Boundary condition for the plane of minimal y-coordinate.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">yLowerBc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">yUpperBc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BoundaryCondition</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        yUpperBc : BoundaryCondition</span>
<span class="sd">            Boundary condition for the plane of maximal y-coordinate.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">yUpperBc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xLowerBc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BoundaryCondition</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        xLowerBc : BoundaryCondition</span>
<span class="sd">            Boundary condition for the plane of minimal x-coordinate.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">xLowerBc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xUpperBc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BoundaryCondition</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        xUpperBc : BoundaryCondition</span>
<span class="sd">            Boundary condition for the plane of maximal x-coordinate.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">xUpperBc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Nspace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Nspace : int</span>
<span class="sd">            Total number of points in the atmospheric spatial discretistaion.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">Nspace</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Nrays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Nrays : int</span>
<span class="sd">            Number of rays in angular discretisation used.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">muz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Nrays not set, call atmos.rays or .quadrature first&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">muz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<div class="viewcode-block" id="Atmosphere.dimensioned_view"><a class="viewcode-back" href="../../lightweaver-api.html#lightweaver.atmosphere.Atmosphere.dimensioned_view">[docs]</a>    <span class="k">def</span> <span class="nf">dimensioned_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a view over the contents of Layout reshaped so all data has</span>
<span class="sd">        the correct (1/2/3D) dimensionality for the atmospheric model, as</span>
<span class="sd">        these are all stored under a flat scheme.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">dimensioned_shape</span>
        <span class="n">atmos</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">atmos</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">dimensioned_view</span><span class="p">()</span>
        <span class="n">atmos</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">atmos</span><span class="o">.</span><span class="n">vturb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vturb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">atmos</span><span class="o">.</span><span class="n">ne</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ne</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">atmos</span><span class="o">.</span><span class="n">nHTot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nHTot</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">atmos</span><span class="o">.</span><span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">atmos</span><span class="o">.</span><span class="n">chiB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chiB</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">atmos</span><span class="o">.</span><span class="n">gammaB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gammaB</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">atmos</span></div>

<div class="viewcode-block" id="Atmosphere.unit_view"><a class="viewcode-back" href="../../lightweaver-api.html#lightweaver.atmosphere.Atmosphere.unit_view">[docs]</a>    <span class="k">def</span> <span class="nf">unit_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a view over the contents of the Layout with the correct</span>
<span class="sd">        `astropy.units`.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">atmos</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">atmos</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">unit_view</span><span class="p">()</span>
        <span class="n">atmos</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span>
        <span class="n">atmos</span><span class="o">.</span><span class="n">vturb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vturb</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span>
        <span class="n">atmos</span><span class="o">.</span><span class="n">ne</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ne</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">atmos</span><span class="o">.</span><span class="n">nHTot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nHTot</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">atmos</span><span class="o">.</span><span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">T</span>
            <span class="n">atmos</span><span class="o">.</span><span class="n">chiB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chiB</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span>
            <span class="n">atmos</span><span class="o">.</span><span class="n">gammaB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gammaB</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span>
        <span class="k">return</span> <span class="n">atmos</span></div>

<div class="viewcode-block" id="Atmosphere.dimensioned_unit_view"><a class="viewcode-back" href="../../lightweaver-api.html#lightweaver.atmosphere.Atmosphere.dimensioned_unit_view">[docs]</a>    <span class="k">def</span> <span class="nf">dimensioned_unit_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a view over the contents of Layout reshaped so all data has</span>
<span class="sd">        the correct (1/2/3D) dimensionality for the atmospheric model, and</span>
<span class="sd">        the correct `astropy.units`.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">atmos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensioned_view</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">atmos</span><span class="o">.</span><span class="n">unit_view</span><span class="p">()</span></div>

<div class="viewcode-block" id="Atmosphere.make_1d"><a class="viewcode-back" href="../../lightweaver-api.html#lightweaver.atmosphere.Atmosphere.make_1d">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">make_1d</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">scale</span><span class="p">:</span> <span class="n">ScaleType</span><span class="p">,</span> <span class="n">depthScale</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                <span class="n">temperature</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">vlos</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                <span class="n">vturb</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ne</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">hydrogenPops</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">nHTot</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">B</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">gammaB</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">chiB</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">lowerBc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BoundaryCondition</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">upperBc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BoundaryCondition</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">convertScales</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">abundance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AtomicAbundance</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">logG</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">2.44</span><span class="p">,</span>
                <span class="n">Pgas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">Pe</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">Ptop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">PeTop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Constructor for 1D Atmosphere objects. Optionally will use an</span>
<span class="sd">        equation of state (EOS) to estimate missing parameters.</span>

<span class="sd">        If sufficient information is provided (i.e. all required parameters</span>
<span class="sd">        and ne and (hydrogenPops or nHTot)) then the EOS is not invoked to</span>
<span class="sd">        estimate any thermodynamic properties. If both of nHTot and</span>
<span class="sd">        hydrogenPops are omitted, then the electron pressure will be used</span>
<span class="sd">        with the Wittmann equation of state to estimate the mass density, and</span>
<span class="sd">        the hydrogen number density will be inferred from this and the</span>
<span class="sd">        abundances. If, instead, ne is omitted, then the mass density will be</span>
<span class="sd">        used with the Wittmann EOS to estimate the electron pressure.</span>
<span class="sd">        If both of these are omitted then the EOS will be used to estimate</span>
<span class="sd">        both. If:</span>

<span class="sd">            - Pgas is provided, then this gas pressure will define the</span>
<span class="sd">              atmospheric stratification and will be used with the EOS.</span>

<span class="sd">            - Pe is provided, then this electron pressure will define the</span>
<span class="sd">              atmospheric stratification and will be used with the EOS.</span>

<span class="sd">            - Ptop is provided, then this gas pressure at the top of the</span>
<span class="sd">              atmosphere will be used with the log gravitational acceleration</span>
<span class="sd">              logG, and the EOS to estimate the missing parameters assuming</span>
<span class="sd">              hydrostatic equilibrium.</span>

<span class="sd">            - PeTop is provided, then this electron pressure at the top of</span>
<span class="sd">              the atmosphere will be used with the log gravitational</span>
<span class="sd">              acceleration logG, and the EOS to estimate the missing parameters</span>
<span class="sd">              assuming hydrostatic equilibrium.</span>

<span class="sd">            - If all of Pgas, Pe, Ptop, PeTop are omitted then Ptop will be</span>
<span class="sd">              estimated from the gas pressure in the FALC model at the</span>
<span class="sd">              temperature at the top boundary. The hydrostatic reconstruction</span>
<span class="sd">              will then continue as usual.</span>

<span class="sd">        convertScales will substantially slow down this function due to the</span>
<span class="sd">        slow calculation of background opacities used to compute tauRef. If</span>
<span class="sd">        an atmosphere is constructed with a Geometric stratification, and an</span>
<span class="sd">        estimate of tauRef is not required before running the main RT module,</span>
<span class="sd">        then this can be set to False.</span>
<span class="sd">        All of these parameters can be provided as astropy Quantities, and</span>
<span class="sd">        will be converted in the constructor.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scale : ScaleType</span>
<span class="sd">            The type of stratification used along the z-axis.</span>
<span class="sd">        depthScale : np.ndarray</span>
<span class="sd">            The z-coordinates used along the chosen stratification. The</span>
<span class="sd">            stratification is expected to start at the top of the atmosphere</span>
<span class="sd">            (closest to the observer), and descend along the observer&#39;s line</span>
<span class="sd">            of sight.</span>
<span class="sd">        temperature : np.ndarray</span>
<span class="sd">            Temperature structure of the atmosphere [K].</span>
<span class="sd">        vlos : np.ndarray</span>
<span class="sd">            Velocity structure of the atmosphere along z [m/s].</span>
<span class="sd">        vturb : np.ndarray</span>
<span class="sd">            Microturbulent velocity structure of the atmosphere [m/s].</span>
<span class="sd">        ne : np.ndarray</span>
<span class="sd">            Electron density structure of the atmosphere [m-3].</span>
<span class="sd">        hydrogenPops : np.ndarray, optional</span>
<span class="sd">            Detailed (per level) hydrogen number density structure of the</span>
<span class="sd">            atmosphere [m-3], 2D array [Nlevel, Nspace].</span>
<span class="sd">        nHTot : np.ndarray, optional</span>
<span class="sd">            Total hydrogen number density structure of the atmosphere [m-3]</span>
<span class="sd">        B : np.ndarray, optional.</span>
<span class="sd">            Magnetic field strength [T].</span>
<span class="sd">        gammaB : np.ndarray, optional</span>
<span class="sd">            Co-altitude of magnetic field vector [radians].</span>
<span class="sd">        chiB : np.ndarray, optional</span>
<span class="sd">            Azimuth of magnetic field vector (in x-y plane, from x) [radians].</span>
<span class="sd">        lowerBc : BoundaryCondition, optional</span>
<span class="sd">            Boundary condition for incoming radiation at the minimal z</span>
<span class="sd">            coordinate (default: ThermalisedRadiation).</span>
<span class="sd">        upperBc : BoundaryCondition, optional</span>
<span class="sd">            Boundary condition for incoming radiation at the maximal z</span>
<span class="sd">            coordinate (default: ZeroRadiation).</span>
<span class="sd">        convertScales : bool, optional</span>
<span class="sd">            Whether to automatically compute tauRef and cmass for an</span>
<span class="sd">            atmosphere given in a stratification of m (default: True).</span>
<span class="sd">        abundance: AtomicAbundance, optional</span>
<span class="sd">            An instance of AtomicAbundance giving the abundances of each</span>
<span class="sd">            atomic species in the given atmosphere, only used if the EOS is</span>
<span class="sd">            invoked. (default: DefaultAtomicAbundance)</span>
<span class="sd">        logG: float, optional</span>
<span class="sd">            The log10 of the magnitude of gravitational acceleration [m/s2]</span>
<span class="sd">            (default: 2.44).</span>
<span class="sd">        Pgas: np.ndarray, optional</span>
<span class="sd">            The gas pressure stratification of the atmosphere [Pa],</span>
<span class="sd">            optionally used by the EOS.</span>
<span class="sd">        Pe: np.ndarray, optional</span>
<span class="sd">            The electron pressure stratification of the atmosphere [Pa],</span>
<span class="sd">            optionally used by the EOS.</span>
<span class="sd">        Ptop: np.ndarray, optional</span>
<span class="sd">            The gas pressure at the top of the atmosphere [Pa], optionally</span>
<span class="sd">            used by the EOS for a hydrostatic reconstruction.</span>
<span class="sd">        Petop: np.ndarray, optional</span>
<span class="sd">            The electron pressure at the top of the atmosphere [Pa],</span>
<span class="sd">            optionally used by the EOS for a hydrostatic reconstruction.</span>
<span class="sd">        verbose: bool, optional</span>
<span class="sd">            Explain decisions made with the EOS to estimate missing</span>
<span class="sd">            parameters (if invoked) through print calls (default: False).</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            if incorrect arguments or unable to construct estimate missing</span>
<span class="sd">            parameters.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="n">ScaleType</span><span class="o">.</span><span class="n">Geometric</span><span class="p">:</span>
            <span class="n">depthScale</span> <span class="o">=</span> <span class="p">(</span><span class="n">depthScale</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">elif</span> <span class="n">scale</span> <span class="o">==</span> <span class="n">ScaleType</span><span class="o">.</span><span class="n">ColumnMass</span><span class="p">:</span>
            <span class="n">depthScale</span> <span class="o">=</span> <span class="p">(</span><span class="n">depthScale</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">kg</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="p">(</span><span class="n">temperature</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">vlos</span> <span class="o">=</span> <span class="p">(</span><span class="n">vlos</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">vturb</span> <span class="o">=</span> <span class="p">(</span><span class="n">vturb</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">ne</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ne</span> <span class="o">=</span> <span class="p">(</span><span class="n">ne</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">hydrogenPops</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hydrogenPops</span> <span class="o">=</span> <span class="p">(</span><span class="n">hydrogenPops</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">nHTot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nHTot</span> <span class="o">=</span> <span class="p">(</span><span class="n">nHTot</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">B</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">B</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">gammaB</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gammaB</span> <span class="o">=</span> <span class="p">(</span><span class="n">gammaB</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">chiB</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">chiB</span> <span class="o">=</span> <span class="p">(</span><span class="n">chiB</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

        <span class="k">if</span> <span class="n">lowerBc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lowerBc</span> <span class="o">=</span> <span class="n">ThermalisedRadiation</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lowerBc</span><span class="p">,</span> <span class="n">PeriodicRadiation</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot set periodic boundary conditions for 1D atmosphere&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">upperBc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">upperBc</span> <span class="o">=</span> <span class="n">ZeroRadiation</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">upperBc</span><span class="p">,</span> <span class="n">PeriodicRadiation</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot set periodic boundary conditions for 1D atmosphere&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">scale</span> <span class="o">!=</span> <span class="n">ScaleType</span><span class="o">.</span><span class="n">Geometric</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">convertScales</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Height scale must be provided if scale conversion is not applied&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nHTot</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">hydrogenPops</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nHTot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hydrogenPops</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">temperature</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">):</span>
            <span class="c1"># NOTE(cmo): Minimum value was decreased in NICOLE so should be safe</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Minimum temperature too low for EOS (&lt; 2000 K)&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">abundance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">abundance</span> <span class="o">=</span> <span class="n">DefaultAtomicAbundance</span>

        <span class="n">wittAbundances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">abundance</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">PeriodicTable</span><span class="o">.</span><span class="n">elements</span><span class="p">])</span>
        <span class="n">eos</span> <span class="o">=</span> <span class="n">witt</span><span class="p">(</span><span class="n">abund_init</span><span class="o">=</span><span class="n">wittAbundances</span><span class="p">)</span>

        <span class="n">Nspace</span> <span class="o">=</span> <span class="n">depthScale</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">nHTot</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ne</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting nHTot from electron pressure.&#39;</span><span class="p">)</span>
            <span class="n">pe</span> <span class="o">=</span> <span class="n">ne</span> <span class="o">*</span> <span class="n">Const</span><span class="o">.</span><span class="n">CM_TO_M</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">eos</span><span class="o">.</span><span class="n">BK</span> <span class="o">*</span> <span class="n">temperature</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nspace</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nspace</span><span class="p">):</span>
                <span class="n">rho</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">rho_from_pe</span><span class="p">(</span><span class="n">temperature</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">pe</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="n">nHTot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">rho</span> <span class="o">/</span> <span class="p">(</span><span class="n">Const</span><span class="o">.</span><span class="n">CM_TO_M</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span> <span class="n">Const</span><span class="o">.</span><span class="n">G_TO_KG</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Const</span><span class="o">.</span><span class="n">Amu</span> <span class="o">*</span> <span class="n">abundance</span><span class="o">.</span><span class="n">massPerH</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">ne</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nHTot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting ne from mass density.&#39;</span><span class="p">)</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="n">Const</span><span class="o">.</span><span class="n">Amu</span> <span class="o">*</span> <span class="n">abundance</span><span class="o">.</span><span class="n">massPerH</span> <span class="o">*</span> <span class="n">nHTot</span> <span class="o">*</span> <span class="n">Const</span><span class="o">.</span><span class="n">CM_TO_M</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span> <span class="n">Const</span><span class="o">.</span><span class="n">G_TO_KG</span>
            <span class="n">pe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nspace</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nspace</span><span class="p">):</span>
                <span class="n">pe</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">pe_from_rho</span><span class="p">(</span><span class="n">temperature</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">rho</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="n">ne</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pe</span> <span class="o">/</span> <span class="p">(</span><span class="n">eos</span><span class="o">.</span><span class="n">BK</span> <span class="o">*</span> <span class="n">temperature</span><span class="p">)</span> <span class="o">/</span> <span class="n">Const</span><span class="o">.</span><span class="n">CM_TO_M</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ne</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nHTot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Pgas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Pgas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">Nspace</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Dimensions of Pgas do not match atmospheric depth&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">Pe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Pe</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">Nspace</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Dimensions of Pe do not match atmospheric depth&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">Pgas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Pe</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting ne, nHTot from provided gas pressure.&#39;</span><span class="p">)</span>
                <span class="c1"># Convert to cgs for eos</span>
                <span class="n">pgas</span> <span class="o">=</span> <span class="n">Pgas</span> <span class="o">*</span> <span class="p">(</span><span class="n">Const</span><span class="o">.</span><span class="n">CM_TO_M</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">Const</span><span class="o">.</span><span class="n">G_TO_KG</span><span class="p">)</span>
                <span class="n">pe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nspace</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nspace</span><span class="p">):</span>
                    <span class="n">pe</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">pe_from_pg</span><span class="p">(</span><span class="n">temperature</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">pgas</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">Pe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Pgas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting ne, nHTot from provided electron pressure.&#39;</span><span class="p">)</span>
                <span class="c1"># Convert to cgs for eos</span>
                <span class="n">pe</span> <span class="o">=</span> <span class="n">Pe</span> <span class="o">*</span> <span class="p">(</span><span class="n">Const</span><span class="o">.</span><span class="n">CM_TO_M</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">Const</span><span class="o">.</span><span class="n">G_TO_KG</span><span class="p">)</span>
                <span class="n">pgas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nspace</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nspace</span><span class="p">):</span>
                    <span class="n">pgas</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">pg_from_pe</span><span class="p">(</span><span class="n">temperature</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">pe</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">Pgas</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Pe</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Doing Hydrostatic Eq. based here on NICOLE implementation</span>
                <span class="n">gravAcc</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">logG</span> <span class="o">/</span> <span class="n">Const</span><span class="o">.</span><span class="n">CM_TO_M</span>
                <span class="n">Avog</span> <span class="o">=</span> <span class="mf">6.022045e23</span> <span class="c1"># Avogadro&#39;s Number</span>
                <span class="k">if</span> <span class="n">Ptop</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">PeTop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting ne, nHTot to hydrostatic equilibrium (logG=</span><span class="si">%f</span><span class="s1">) from provided top electron pressure.&#39;</span> <span class="o">%</span> <span class="n">logG</span><span class="p">)</span>
                    <span class="n">PeTop</span> <span class="o">*=</span> <span class="p">(</span><span class="n">Const</span><span class="o">.</span><span class="n">CM_TO_M</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">Const</span><span class="o">.</span><span class="n">G_TO_KG</span><span class="p">)</span>
                    <span class="n">Ptop</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">pg_from_pe</span><span class="p">(</span><span class="n">temperature</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">PeTop</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">Ptop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">PeTop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting ne, nHTot to hydrostatic equilibrium (logG=</span><span class="si">%f</span><span class="s1">) from provided top gas pressure.&#39;</span> <span class="o">%</span> <span class="n">logG</span><span class="p">)</span>
                    <span class="n">Ptop</span> <span class="o">*=</span> <span class="p">(</span><span class="n">Const</span><span class="o">.</span><span class="n">CM_TO_M</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">Const</span><span class="o">.</span><span class="n">G_TO_KG</span><span class="p">)</span>
                    <span class="n">PeTop</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">pe_from_pg</span><span class="p">(</span><span class="n">temperature</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Ptop</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">Ptop</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">PeTop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting ne, nHTot to hydrostatic equilibrium (logG=</span><span class="si">%f</span><span class="s1">) from FALC gas pressure at upper boundary temperature.&#39;</span> <span class="o">%</span> <span class="n">logG</span><span class="p">)</span>
                    <span class="n">Ptop</span> <span class="o">=</span> <span class="n">get_top_pressure</span><span class="p">(</span><span class="n">eos</span><span class="p">,</span> <span class="n">temperature</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">PeTop</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">pe_from_pg</span><span class="p">(</span><span class="n">temperature</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Ptop</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot set both Ptop and PeTop&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="n">ScaleType</span><span class="o">.</span><span class="n">Tau500</span><span class="p">:</span>
                    <span class="n">tau</span> <span class="o">=</span> <span class="n">depthScale</span>
                <span class="k">elif</span> <span class="n">scale</span> <span class="o">==</span> <span class="n">ScaleType</span><span class="o">.</span><span class="n">Geometric</span><span class="p">:</span>
                    <span class="n">height</span> <span class="o">=</span> <span class="n">depthScale</span> <span class="o">/</span> <span class="n">Const</span><span class="o">.</span><span class="n">CM_TO_M</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cmass</span> <span class="o">=</span> <span class="n">depthScale</span> <span class="o">/</span> <span class="n">Const</span><span class="o">.</span><span class="n">G_TO_KG</span> <span class="o">*</span> <span class="n">Const</span><span class="o">.</span><span class="n">CM_TO_M</span><span class="o">**</span><span class="mi">2</span>

                <span class="c1"># NOTE(cmo): Compute HSE following the NICOLE method.</span>
                <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nspace</span><span class="p">)</span>
                <span class="n">chi_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nspace</span><span class="p">)</span>
                <span class="n">pgas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nspace</span><span class="p">)</span>
                <span class="n">pe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nspace</span><span class="p">)</span>
                <span class="n">pgas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ptop</span>
                <span class="n">pe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">PeTop</span>
                <span class="n">chi_c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">contOpacity</span><span class="p">(</span><span class="n">temperature</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pgas</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">5000.0</span><span class="p">]))</span>
                <span class="n">avg_mol_weight</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">abundance</span><span class="o">.</span><span class="n">massPerH</span> <span class="o">/</span> <span class="p">(</span><span class="n">abundance</span><span class="o">.</span><span class="n">totalAbundance</span> <span class="o">+</span> <span class="n">pe</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">/</span> <span class="n">pgas</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="n">rho</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ptop</span> <span class="o">*</span> <span class="n">avg_mol_weight</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">Avog</span> <span class="o">/</span> <span class="n">eos</span><span class="o">.</span><span class="n">BK</span> <span class="o">/</span> <span class="n">temperature</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">chi_c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="n">rho</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nspace</span><span class="p">):</span>
                    <span class="n">chi_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">chi_c</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">rho</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">200</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="n">ScaleType</span><span class="o">.</span><span class="n">Tau500</span><span class="p">:</span>
                            <span class="n">dtau</span> <span class="o">=</span> <span class="n">tau</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">tau</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">pgas</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">pgas</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">gravAcc</span> <span class="o">*</span> <span class="n">dtau</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi_c</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">chi_c</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
                        <span class="k">elif</span> <span class="n">scale</span> <span class="o">==</span> <span class="n">ScaleType</span><span class="o">.</span><span class="n">Geometric</span><span class="p">:</span>
                            <span class="n">pgas</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">pgas</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">gravAcc</span> <span class="o">/</span> <span class="n">Avog</span> <span class="o">/</span> <span class="n">eos</span><span class="o">.</span><span class="n">BK</span> <span class="o">*</span> <span class="n">avg_mol_weight</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">temperature</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">temperature</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">height</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">height</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">pgas</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">gravAcc</span> <span class="o">*</span> <span class="n">cmass</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

                        <span class="n">pe</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">pe_from_pg</span><span class="p">(</span><span class="n">temperature</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">pgas</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="n">prevChi</span> <span class="o">=</span> <span class="n">chi_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="n">chi_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">contOpacity</span><span class="p">(</span><span class="n">temperature</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">pgas</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">pe</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">5000.0</span><span class="p">]))</span>
                        <span class="n">rho</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">pgas</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">avg_mol_weight</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="n">Avog</span> <span class="o">/</span> <span class="n">eos</span><span class="o">.</span><span class="n">BK</span> <span class="o">/</span> <span class="n">temperature</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="n">chi_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">/=</span> <span class="n">rho</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

                        <span class="n">change</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">prevChi</span> <span class="o">-</span> <span class="n">chi_c</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">prevChi</span> <span class="o">+</span> <span class="n">chi_c</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">change</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ConvergenceError</span><span class="p">(</span><span class="s1">&#39;No convergence in HSE at depth point </span><span class="si">%d</span><span class="s1">, last change </span><span class="si">%2.4e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">change</span><span class="p">))</span>
            <span class="n">nHTot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">rho</span> <span class="o">/</span> <span class="p">(</span><span class="n">Const</span><span class="o">.</span><span class="n">CM_TO_M</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span> <span class="n">Const</span><span class="o">.</span><span class="n">G_TO_KG</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Const</span><span class="o">.</span><span class="n">Amu</span> <span class="o">*</span> <span class="n">abundance</span><span class="o">.</span><span class="n">massPerH</span><span class="p">))</span>
            <span class="n">ne</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pe</span> <span class="o">/</span> <span class="p">(</span><span class="n">eos</span><span class="o">.</span><span class="n">BK</span> <span class="o">*</span> <span class="n">temperature</span><span class="p">)</span> <span class="o">/</span> <span class="n">Const</span><span class="o">.</span><span class="n">CM_TO_M</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># NOTE(cmo): Compute final pgas, pe from EOS that will be used for</span>
        <span class="c1"># background opacity.</span>
        <span class="n">rhoSI</span> <span class="o">=</span> <span class="n">Const</span><span class="o">.</span><span class="n">Amu</span> <span class="o">*</span> <span class="n">abundance</span><span class="o">.</span><span class="n">massPerH</span> <span class="o">*</span> <span class="n">nHTot</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">Const</span><span class="o">.</span><span class="n">Amu</span> <span class="o">*</span> <span class="n">abundance</span><span class="o">.</span><span class="n">massPerH</span> <span class="o">*</span> <span class="n">nHTot</span> <span class="o">*</span> <span class="n">Const</span><span class="o">.</span><span class="n">CM_TO_M</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span> <span class="n">Const</span><span class="o">.</span><span class="n">G_TO_KG</span>
        <span class="n">pgas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">depthScale</span><span class="p">)</span>
        <span class="n">pe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">depthScale</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nspace</span><span class="p">):</span>
            <span class="n">pgas</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">pg_from_rho</span><span class="p">(</span><span class="n">temperature</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">rho</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="n">pe</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">pe_from_rho</span><span class="p">(</span><span class="n">temperature</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">rho</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="n">chi_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">depthScale</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">depthScale</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">chi_c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">contOpacity</span><span class="p">(</span><span class="n">temperature</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">pgas</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">pe</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">5000.0</span><span class="p">]))</span> <span class="o">/</span> <span class="n">Const</span><span class="o">.</span><span class="n">CM_TO_M</span>

        <span class="c1"># NOTE(cmo): We should now have a uniform minimum set of data (other</span>
        <span class="c1"># than the scale type), allowing us to simply convert between the</span>
        <span class="c1"># scales we do have!</span>
        <span class="k">if</span> <span class="n">convertScales</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="n">ScaleType</span><span class="o">.</span><span class="n">ColumnMass</span><span class="p">:</span>
                <span class="n">height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">depthScale</span><span class="p">)</span>
                <span class="n">tau_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">depthScale</span><span class="p">)</span>
                <span class="n">cmass</span> <span class="o">=</span> <span class="n">depthScale</span>

                <span class="n">height</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">tau_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">chi_c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">rhoSI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">cmass</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmass</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">height</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">height</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">cmass</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">cmass</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">rhoSI</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rhoSI</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="n">tau_ref</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">tau_ref</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi_c</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">chi_c</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">height</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">height</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

                <span class="n">hTau1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">tau_ref</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
                <span class="n">height</span> <span class="o">-=</span> <span class="n">hTau1</span>
            <span class="k">elif</span> <span class="n">scale</span> <span class="o">==</span> <span class="n">ScaleType</span><span class="o">.</span><span class="n">Geometric</span><span class="p">:</span>
                <span class="n">cmass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nspace</span><span class="p">)</span>
                <span class="n">tau_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nspace</span><span class="p">)</span>
                <span class="n">height</span> <span class="o">=</span> <span class="n">depthScale</span>

                <span class="n">cmass</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">nHTot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">abundance</span><span class="o">.</span><span class="n">massPerH</span> <span class="o">+</span> <span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">Const</span><span class="o">.</span><span class="n">KBoltzmann</span> <span class="o">*</span> <span class="n">temperature</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span><span class="o">**</span><span class="n">logG</span><span class="p">)</span>
                <span class="n">tau_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">chi_c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">height</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">height</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">tau_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                    <span class="n">tau_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nspace</span><span class="p">):</span>
                    <span class="n">cmass</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmass</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">rhoSI</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rhoSI</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">height</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">height</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="n">tau_ref</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">tau_ref</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi_c</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">chi_c</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">height</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">height</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">scale</span> <span class="o">==</span> <span class="n">ScaleType</span><span class="o">.</span><span class="n">Tau500</span><span class="p">:</span>
                <span class="n">cmass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nspace</span><span class="p">)</span>
                <span class="n">height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nspace</span><span class="p">)</span>
                <span class="n">tau_ref</span> <span class="o">=</span> <span class="n">depthScale</span>

                <span class="n">cmass</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tau_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">chi_c</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">rhoSI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nspace</span><span class="p">):</span>
                    <span class="n">height</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">height</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">tau_ref</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">tau_ref</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">chi_c</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">chi_c</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="n">cmass</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmass</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi_c</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">chi_c</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">height</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">height</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

                <span class="n">hTau1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">tau_ref</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
                <span class="n">height</span> <span class="o">-=</span> <span class="n">hTau1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Other scales not handled yet&quot;</span><span class="p">)</span>

            <span class="n">stratifications</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Stratifications</span><span class="p">]</span> <span class="o">=</span> <span class="n">Stratifications</span><span class="p">(</span><span class="n">cmass</span><span class="o">=</span><span class="n">cmass</span><span class="p">,</span> <span class="n">tauRef</span><span class="o">=</span><span class="n">tau_ref</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">stratifications</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">layout</span> <span class="o">=</span> <span class="n">Layout</span><span class="o">.</span><span class="n">make_1d</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">height</span><span class="p">,</span> <span class="n">vz</span><span class="o">=</span><span class="n">vlos</span><span class="p">,</span>
                                <span class="n">lowerBc</span><span class="o">=</span><span class="n">lowerBc</span><span class="p">,</span> <span class="n">upperBc</span><span class="o">=</span><span class="n">upperBc</span><span class="p">,</span>
                                <span class="n">stratifications</span><span class="o">=</span><span class="n">stratifications</span><span class="p">)</span>
        <span class="n">atmos</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">layout</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span> <span class="n">vturb</span><span class="o">=</span><span class="n">vturb</span><span class="p">,</span>
                    <span class="n">ne</span><span class="o">=</span><span class="n">ne</span><span class="p">,</span> <span class="n">nHTot</span><span class="o">=</span><span class="n">nHTot</span><span class="p">,</span> <span class="n">B</span><span class="o">=</span><span class="n">B</span><span class="p">,</span> <span class="n">gammaB</span><span class="o">=</span><span class="n">gammaB</span><span class="p">,</span> <span class="n">chiB</span><span class="o">=</span><span class="n">chiB</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">atmos</span></div>

<div class="viewcode-block" id="Atmosphere.make_2d"><a class="viewcode-back" href="../../lightweaver-api.html#lightweaver.atmosphere.Atmosphere.make_2d">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">make_2d</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                <span class="n">temperature</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">vx</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                <span class="n">vz</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">vturb</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                <span class="n">ne</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">nHTot</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">B</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">gammaB</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">chiB</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">xUpperBc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BoundaryCondition</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">xLowerBc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BoundaryCondition</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">zUpperBc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BoundaryCondition</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">zLowerBc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BoundaryCondition</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">abundance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AtomicAbundance</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Constructor for 2D Atmosphere objects.</span>

<span class="sd">        No provision for estimating parameters using hydrostatic equilibrium</span>
<span class="sd">        is provided, but one of ne, or nHTot can be omitted and inferred by</span>
<span class="sd">        use of the Wittmann equation of state.</span>
<span class="sd">        The atmosphere must be defined on a geometric stratification.</span>
<span class="sd">        All atmospheric parameters are expected in a 2D [z, x] array.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        height : np.ndarray</span>
<span class="sd">            The z-coordinates of the atmospheric grid. The stratification is</span>
<span class="sd">            expected to start at the top of the atmosphere (closest to the</span>
<span class="sd">            observer), and descend along the observer&#39;s line of sight.</span>
<span class="sd">        x : np.ndarray</span>
<span class="sd">            The (horizontal) x-coordinates of the atmospheric grid.</span>
<span class="sd">        temperature : np.ndarray</span>
<span class="sd">            Temperature structure of the atmosphere [K].</span>
<span class="sd">        vx : np.ndarray</span>
<span class="sd">            x-component of the atmospheric velocity [m/s].</span>
<span class="sd">        vz : np.ndarray</span>
<span class="sd">            z-component of the atmospheric velocity [m/s].</span>
<span class="sd">        vturb : np.ndarray</span>
<span class="sd">            Microturbulent velocity structure [m/s].</span>
<span class="sd">        ne : np.ndarray</span>
<span class="sd">            Electron density structure of the atmosphere [m-3].</span>
<span class="sd">        nHTot : np.ndarray, optional</span>
<span class="sd">            Total hydrogen number density structure of the atmosphere [m-3].</span>
<span class="sd">        B : np.ndarray, optional.</span>
<span class="sd">            Magnetic field strength [T].</span>
<span class="sd">        gammaB : np.ndarray, optional</span>
<span class="sd">            Co-altitude of magnetic field vector [radians].</span>
<span class="sd">        chiB : np.ndarray, optional</span>
<span class="sd">            Azimuth of magnetic field vector (in x-y plane, from x) [radians].</span>
<span class="sd">        xLowerBc : BoundaryCondition, optional</span>
<span class="sd">            Boundary condition for incoming radiation at the minimal x</span>
<span class="sd">            coordinate (default: PeriodicRadiation).</span>
<span class="sd">        xUpperBc : BoundaryCondition, optional</span>
<span class="sd">            Boundary condition for incoming radiation at the maximal x</span>
<span class="sd">            coordinate (default: PeriodicRadiation).</span>
<span class="sd">        zLowerBc : BoundaryCondition, optional</span>
<span class="sd">            Boundary condition for incoming radiation at the minimal z</span>
<span class="sd">            coordinate (default: ThermalisedRadiation).</span>
<span class="sd">        zUpperBc : BoundaryCondition, optional</span>
<span class="sd">            Boundary condition for incoming radiation at the maximal z</span>
<span class="sd">            coordinate (default: ZeroRadiation).</span>
<span class="sd">        convertScales : bool, optional</span>
<span class="sd">            Whether to automatically compute tauRef and cmass for an</span>
<span class="sd">            atmosphere given in a stratification of m (default: True).</span>
<span class="sd">        abundance: AtomicAbundance, optional</span>
<span class="sd">            An instance of AtomicAbundance giving the abundances of each</span>
<span class="sd">            atomic species in the given atmosphere, only used if the EOS is</span>
<span class="sd">            invoked. (default: DefaultAtomicAbundance)</span>
<span class="sd">        verbose: bool, optional</span>
<span class="sd">            Explain decisions made with the EOS to estimate missing</span>
<span class="sd">            parameters (if invoked) through print calls (default: False).</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            if incorrect arguments or unable to construct estimate missing</span>
<span class="sd">            parameters.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">height</span> <span class="o">=</span> <span class="p">(</span><span class="n">height</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="p">(</span><span class="n">temperature</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">vx</span> <span class="o">=</span> <span class="p">(</span><span class="n">vx</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">vz</span> <span class="o">=</span> <span class="p">(</span><span class="n">vz</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">vturb</span> <span class="o">=</span> <span class="p">(</span><span class="n">vturb</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">ne</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ne</span> <span class="o">=</span> <span class="p">(</span><span class="n">ne</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">nHTot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nHTot</span> <span class="o">=</span> <span class="p">(</span><span class="n">nHTot</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">B</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">B</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">flatB</span> <span class="o">=</span> <span class="n">view_flatten</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flatB</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">gammaB</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gammaB</span> <span class="o">=</span> <span class="p">(</span><span class="n">gammaB</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">flatGammaB</span> <span class="o">=</span> <span class="n">view_flatten</span><span class="p">(</span><span class="n">gammaB</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flatGammaB</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">chiB</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">chiB</span> <span class="o">=</span> <span class="p">(</span><span class="n">chiB</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">flatChiB</span> <span class="o">=</span> <span class="n">view_flatten</span><span class="p">(</span><span class="n">chiB</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flatChiB</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">zLowerBc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">zLowerBc</span> <span class="o">=</span> <span class="n">ThermalisedRadiation</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">zLowerBc</span><span class="p">,</span> <span class="n">PeriodicRadiation</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot set periodic boundary conditions for z-axis.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">zUpperBc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">zUpperBc</span> <span class="o">=</span> <span class="n">ZeroRadiation</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">zUpperBc</span><span class="p">,</span> <span class="n">PeriodicRadiation</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot set periodic boundary conditions for z-axis.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xUpperBc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xUpperBc</span> <span class="o">=</span> <span class="n">PeriodicRadiation</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">xLowerBc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xLowerBc</span> <span class="o">=</span> <span class="n">PeriodicRadiation</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">abundance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">abundance</span> <span class="o">=</span> <span class="n">DefaultAtomicAbundance</span>

        <span class="n">wittAbundances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">abundance</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">PeriodicTable</span><span class="o">.</span><span class="n">elements</span><span class="p">])</span>
        <span class="n">eos</span> <span class="o">=</span> <span class="n">witt</span><span class="p">(</span><span class="n">abund_init</span><span class="o">=</span><span class="n">wittAbundances</span><span class="p">)</span>

        <span class="n">flatHeight</span> <span class="o">=</span> <span class="n">view_flatten</span><span class="p">(</span><span class="n">height</span><span class="p">)</span>
        <span class="n">flatTemperature</span> <span class="o">=</span> <span class="n">view_flatten</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span>
        <span class="n">Nspace</span> <span class="o">=</span> <span class="n">flatHeight</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">nHTot</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ne</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting nHTot from electron pressure.&#39;</span><span class="p">)</span>
            <span class="n">flatNe</span> <span class="o">=</span> <span class="n">view_flatten</span><span class="p">(</span><span class="n">ne</span><span class="p">)</span>
            <span class="n">pe</span> <span class="o">=</span> <span class="n">flatNe</span> <span class="o">*</span> <span class="n">Const</span><span class="o">.</span><span class="n">CM_TO_M</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">eos</span><span class="o">.</span><span class="n">BK</span> <span class="o">*</span> <span class="n">flatTemperature</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nspace</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nspace</span><span class="p">):</span>
                <span class="n">rho</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">rho_from_pe</span><span class="p">(</span><span class="n">flatTemperature</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">pe</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="n">nHTot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">rho</span> <span class="o">/</span> <span class="p">(</span><span class="n">Const</span><span class="o">.</span><span class="n">CM_TO_M</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span> <span class="n">Const</span><span class="o">.</span><span class="n">G_TO_KG</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Const</span><span class="o">.</span><span class="n">Amu</span> <span class="o">*</span> <span class="n">abundance</span><span class="o">.</span><span class="n">massPerH</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">ne</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nHTot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting ne from mass density.&#39;</span><span class="p">)</span>
            <span class="n">flatNHTot</span> <span class="o">=</span> <span class="n">view_flatten</span><span class="p">(</span><span class="n">nHTot</span><span class="p">)</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="n">Const</span><span class="o">.</span><span class="n">Amu</span> <span class="o">*</span> <span class="n">abundance</span><span class="o">.</span><span class="n">massPerH</span> <span class="o">*</span> <span class="n">flatNHTot</span> <span class="o">*</span> <span class="n">Const</span><span class="o">.</span><span class="n">CM_TO_M</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span> <span class="n">Const</span><span class="o">.</span><span class="n">G_TO_KG</span>
            <span class="n">pe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nspace</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nspace</span><span class="p">):</span>
                <span class="n">pe</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">pe_from_rho</span><span class="p">(</span><span class="n">flatTemperature</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">rho</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="n">ne</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pe</span> <span class="o">/</span> <span class="p">(</span><span class="n">eos</span><span class="o">.</span><span class="n">BK</span> <span class="o">*</span> <span class="n">flatTemperature</span><span class="p">)</span> <span class="o">/</span> <span class="n">Const</span><span class="o">.</span><span class="n">CM_TO_M</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ne</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nHTot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot omit both ne and nHTot (currently).&#39;</span><span class="p">)</span>
        <span class="n">flatX</span> <span class="o">=</span> <span class="n">view_flatten</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">flatNHTot</span> <span class="o">=</span> <span class="n">view_flatten</span><span class="p">(</span><span class="n">nHTot</span><span class="p">)</span>
        <span class="n">flatNe</span> <span class="o">=</span> <span class="n">view_flatten</span><span class="p">(</span><span class="n">ne</span><span class="p">)</span>
        <span class="n">flatVx</span> <span class="o">=</span> <span class="n">view_flatten</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span>
        <span class="n">flatVz</span> <span class="o">=</span> <span class="n">view_flatten</span><span class="p">(</span><span class="n">vz</span><span class="p">)</span>
        <span class="n">flatVturb</span> <span class="o">=</span> <span class="n">view_flatten</span><span class="p">(</span><span class="n">vturb</span><span class="p">)</span>

        <span class="n">layout</span> <span class="o">=</span> <span class="n">Layout</span><span class="o">.</span><span class="n">make_2d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">flatX</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">flatHeight</span><span class="p">,</span> <span class="n">vx</span><span class="o">=</span><span class="n">flatVx</span><span class="p">,</span> <span class="n">vz</span><span class="o">=</span><span class="n">flatVz</span><span class="p">,</span>
                                <span class="n">xLowerBc</span><span class="o">=</span><span class="n">xLowerBc</span><span class="p">,</span> <span class="n">xUpperBc</span><span class="o">=</span><span class="n">xUpperBc</span><span class="p">,</span>
                                <span class="n">zLowerBc</span><span class="o">=</span><span class="n">zLowerBc</span><span class="p">,</span> <span class="n">zUpperBc</span><span class="o">=</span><span class="n">zUpperBc</span><span class="p">,</span>
                                <span class="n">stratifications</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">atmos</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">layout</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">flatTemperature</span><span class="p">,</span>
                    <span class="n">vturb</span><span class="o">=</span><span class="n">flatVturb</span><span class="p">,</span> <span class="n">ne</span><span class="o">=</span><span class="n">flatNe</span><span class="p">,</span> <span class="n">nHTot</span><span class="o">=</span><span class="n">flatNHTot</span><span class="p">,</span> <span class="n">B</span><span class="o">=</span><span class="n">flatB</span><span class="p">,</span>
                    <span class="n">gammaB</span><span class="o">=</span><span class="n">flatGammaB</span><span class="p">,</span> <span class="n">chiB</span><span class="o">=</span><span class="n">flatChiB</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">atmos</span></div>


<div class="viewcode-block" id="Atmosphere.quadrature"><a class="viewcode-back" href="../../lightweaver-api.html#lightweaver.atmosphere.Atmosphere.quadrature">[docs]</a>    <span class="k">def</span> <span class="nf">quadrature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Nrays</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">mu</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">wmu</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compute the angular quadrature for solving the RTE and Kinetic</span>
<span class="sd">        Equilibrium in a given atmosphere.</span>

<span class="sd">        Procedure varies with dimensionality.</span>

<span class="sd">        1D:</span>
<span class="sd">            If a number of rays is given (typically 3 or 5), then the</span>
<span class="sd">            Gauss-Legendre quadrature for this set is used.</span>
<span class="sd">            If mu and wmu are instead given then these will be validated and</span>
<span class="sd">            used.</span>

<span class="sd">        2+D:</span>
<span class="sd">            If the number of rays selected is in the list of near optimal</span>
<span class="sd">            quadratures for unpolarised radiation provided by Stepan et al</span>
<span class="sd">            2020 (A&amp;A, 646 A24), then this is used. Otherwise an exception is</span>
<span class="sd">            raised.</span>

<span class="sd">            The available quadratures are:</span>

<span class="sd">            +--------+-------+</span>
<span class="sd">            | Points | Order |</span>
<span class="sd">            +========+=======+</span>
<span class="sd">            |   1    |  3    |</span>
<span class="sd">            +--------+-------+</span>
<span class="sd">            |   3    |  7    |</span>
<span class="sd">            +--------+-------+</span>
<span class="sd">            |   6    |  9    |</span>
<span class="sd">            +--------+-------+</span>
<span class="sd">            |   7    |  11   |</span>
<span class="sd">            +--------+-------+</span>
<span class="sd">            |   10   |  13   |</span>
<span class="sd">            +--------+-------+</span>
<span class="sd">            |   11   |  15   |</span>
<span class="sd">            +--------+-------+</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Nrays : int, optional</span>
<span class="sd">            The number of rays to use in the quadrature. See notes above.</span>
<span class="sd">        mu : sequence of float, optional</span>
<span class="sd">            The cosine of the angle made between the between each of the set</span>
<span class="sd">            of rays and the z axis, only used in 1D.</span>
<span class="sd">        wmu : sequence of float, optional</span>
<span class="sd">            The integration weights for each mu, must be provided if mu is provided.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            on incorrect input.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Nrays</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">Nrays</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">leggauss</span><span class="p">(</span><span class="n">Nrays</span><span class="p">)</span>
                    <span class="n">mid</span><span class="p">,</span> <span class="n">halfWidth</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">+</span> <span class="n">halfWidth</span> <span class="o">*</span> <span class="n">x</span>
                    <span class="n">w</span> <span class="o">*=</span> <span class="n">halfWidth</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">muz</span> <span class="o">=</span> <span class="n">x</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wmu</span> <span class="o">=</span> <span class="n">w</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unsupported Nrays=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">Nrays</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">Nrays</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">wmu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must provide wmu when providing mu&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">Nrays</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;mu must be Nrays long if Nrays is provided&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wmu</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;mu and wmu must be the same shape&#39;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">muz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wmu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">wmu</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">muy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muz</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">muz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">get_data_path</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;Quadratures.pickle&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pkl</span><span class="p">:</span>
                <span class="n">quads</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pkl</span><span class="p">)</span>

            <span class="n">rays</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]):</span> <span class="n">q</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">quads</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">Nrays</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rays</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;For multidimensional cases Nrays must be in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">rays</span><span class="p">))</span>

            <span class="n">quad</span> <span class="o">=</span> <span class="n">quads</span><span class="p">[</span><span class="n">rays</span><span class="p">[</span><span class="n">Nrays</span><span class="p">]]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">Nrays</span> <span class="o">*=</span> <span class="mi">2</span>
                <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">quad</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">chi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">quad</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
                <span class="c1"># polar coords:</span>
                <span class="c1"># x = sin theta cos chi</span>
                <span class="c1"># y = sin theta sin chi</span>
                <span class="c1"># z = cos theta</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nrays</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mux</span><span class="p">[:</span><span class="n">Nrays</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">chi</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mux</span><span class="p">[</span><span class="n">Nrays</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">chi</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">muz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nrays</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">muz</span><span class="p">[:</span><span class="n">Nrays</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">muz</span><span class="p">[</span><span class="n">Nrays</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wmu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nrays</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wmu</span><span class="p">[:</span><span class="n">Nrays</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">quad</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wmu</span><span class="p">[</span><span class="n">Nrays</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="n">quad</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wmu</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wmu</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">muy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mux</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">muz</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="Atmosphere.rays"><a class="viewcode-back" href="../../lightweaver-api.html#lightweaver.atmosphere.Atmosphere.rays">[docs]</a>    <span class="k">def</span> <span class="nf">rays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">muz</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
             <span class="n">mux</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">muy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">wmu</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set up the rays on the Atmosphere for computing the intensity in a</span>
<span class="sd">        particular direction (or set of directions).</span>

<span class="sd">        If only the z angle is set then the ray is assumed in the x-z plane.</span>
<span class="sd">        If either muz or muy is omitted then this angle is inferred by</span>
<span class="sd">        normalisation of the projection.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        muz : float or sequence of float, optional</span>
<span class="sd">            The angular projections along the z axis.</span>
<span class="sd">        mux : float or sequence of float, optional</span>
<span class="sd">            The angular projections along the x axis.</span>
<span class="sd">        muy : float or sequence of float, optional</span>
<span class="sd">            The angular projections along the y axis.</span>
<span class="sd">        wmu : float or sequence of float, optional</span>
<span class="sd">            The integration weights for the given ray if J is to be</span>
<span class="sd">            integrated for angle set.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            if the angular projections or integration weights are incorrectly</span>
<span class="sd">            normalised.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">muz</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">muz</span> <span class="o">=</span> <span class="p">[</span><span class="n">muz</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mux</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">mux</span> <span class="o">=</span> <span class="p">[</span><span class="n">mux</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">muy</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">muy</span> <span class="o">=</span> <span class="p">[</span><span class="n">muy</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">mux</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">muy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">muz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">muz</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wmu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muz</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">muy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muz</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">muz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">muy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">muz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">muz</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wmu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muz</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mux</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">muy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muz</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mux</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">mux</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">muz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">muz</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wmu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muz</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">muy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">muy</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muz</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">muy</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">muz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">muz</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mux</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">muy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">muy</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wmu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">muz</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muz</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mux</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">muy</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;mux**2 + muy**2 + muz**2 != 1.0&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">wmu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wmu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">wmu</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wmu</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="mf">1.0</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;sum of wmus is not 1.0&#39;</span><span class="p">)</span></div></div>


<span class="c1"># @dataclass</span>
<span class="c1"># class MagneticAtmosphere(Atmosphere):</span>
<span class="c1">#     B: np.ndarray</span>
<span class="c1">#     gammaB: np.ndarray</span>
<span class="c1">#     chiB: np.ndarray</span>

<span class="c1">#     @classmethod</span>
<span class="c1">#     def from_atmos(cls, atmos: Atmosphere, B: np.ndarray, gammaB: np.ndarray, chiB: np.ndarray):</span>
<span class="c1">#         return cls(**asdict(atmos), B=B, gammaB=gammaB, chiB=chiB)</span>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, C. Osborne

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>