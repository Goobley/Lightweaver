

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>lightweaver.witt &mdash; Lightweaver  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery-dataframe.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery-rendered-html.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Lightweaver
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../auto_examples/index.html">Lightweaver Examples Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lightweaver-api.html">Lightweaver API Documentation</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Lightweaver</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>lightweaver.witt</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for lightweaver.witt</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Simple EOS and background opacity package</span>
<span class="sd">Coded in python by J. de la Cruz Rodriguez (ISP-SU 2017)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">xdrlib</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">njit</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">get_data_path</span>


<span class="k">class</span> <span class="nc">dum</span><span class="p">:</span> <span class="c1"># Just a container for the PF</span>
    <span class="n">nstage</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">npi</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pf</span>  <span class="o">=</span> <span class="mi">0</span>
    <span class="n">eion</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<span class="c1"># ----------------------------------------------------------------------------------------</span>


<div class="viewcode-block" id="witt"><a class="viewcode-back" href="../../lightweaver-api.html#lightweaver.witt.witt">[docs]</a><span class="k">class</span> <span class="nc">witt</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    EOS described in Mihalas (1970) &quot;Stellar atmospheres&quot;</span>
<span class="sd">    It considers in detail H, H+, H- and H2, no other molecules.</span>

<span class="sd">    This particular implementation was taken from Wittmann&#39;s routines.</span>
<span class="sd">    Partition functions from Kurucz.</span>

<span class="sd">    Coded in python by J. de la Cruz Rodriguez (ISP-SU 2017)</span>
<span class="sd">    Messed with by C. Osborne (University of Glasgow 2019-2020)</span>

<span class="sd">    Don&#39;t blame Jaime for EOS bugs in Lightweaver!</span>
<span class="sd">    **N.B. Everything in here is CGS.**</span>

<span class="sd">    Dependencies: pf_Kurucz.input containing the partition function data.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Some definitions (from NIST)</span>

    <span class="n">BK</span> <span class="o">=</span> <span class="mf">1.3806488E-16</span>          <span class="c1"># Boltzmann [erg K]</span>
    <span class="n">EE</span> <span class="o">=</span> <span class="mf">4.80320441E-10</span>         <span class="c1"># Electron charge</span>
    <span class="n">HH</span> <span class="o">=</span> <span class="mf">6.62606957E-27</span>         <span class="c1"># Planck [erg s]</span>
    <span class="n">PI</span> <span class="o">=</span> <span class="mf">3.14159265358979323846</span> <span class="c1"># PI number</span>
    <span class="n">CC</span> <span class="o">=</span> <span class="mf">2.99792458E10</span>          <span class="c1"># Speed of light [cm/s]</span>
    <span class="n">AMU</span> <span class="o">=</span> <span class="mf">1.660538921E-24</span>       <span class="c1"># Atomic mass unit</span>
    <span class="n">EV</span> <span class="o">=</span> <span class="mf">1.602176565E-12</span>        <span class="c1"># Electron Volt to erg</span>
    <span class="n">CM1_TO_EV</span> <span class="o">=</span> <span class="n">HH</span><span class="o">*</span><span class="n">CC</span><span class="o">/</span><span class="n">EV</span>        <span class="c1"># CM^-1 to eV</span>
    <span class="n">ME</span> <span class="o">=</span> <span class="mf">9.10938188E-28</span>         <span class="c1"># mass of electron</span>

    <span class="n">saha_fac</span> <span class="o">=</span>  <span class="p">((</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">PI</span> <span class="o">*</span> <span class="n">ME</span> <span class="o">*</span> <span class="n">BK</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">HH</span><span class="o">*</span><span class="n">HH</span><span class="p">))</span><span class="o">**</span><span class="mf">1.5</span>

    <span class="c1"># Default abundances</span>

    <span class="n">ABUND</span> <span class="o">=</span> <span class="mf">10.0</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.04048</span><span class="p">,</span><span class="o">-</span><span class="mf">1.07</span><span class="p">,</span><span class="o">-</span><span class="mf">10.95</span><span class="p">,</span><span class="o">-</span><span class="mf">10.89</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.44</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.48</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.99</span><span class="p">,</span>
                               <span class="o">-</span><span class="mf">3.11</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.48</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.95</span><span class="p">,</span>  <span class="o">-</span><span class="mf">5.71</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.46</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.57</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.49</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.59</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.83</span><span class="p">,</span>
                               <span class="o">-</span><span class="mf">6.54</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.48</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.82</span><span class="p">,</span>  <span class="o">-</span><span class="mf">5.68</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.94</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.05</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.04</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.37</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.65</span><span class="p">,</span>
                               <span class="o">-</span><span class="mf">4.50</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.12</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.79</span><span class="p">,</span>  <span class="o">-</span><span class="mf">7.83</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.44</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.16</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.63</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.67</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.69</span><span class="p">,</span>
                               <span class="o">-</span><span class="mf">9.41</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.81</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.44</span><span class="p">,</span>  <span class="o">-</span><span class="mf">9.14</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.80</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.54</span><span class="p">,</span><span class="o">-</span><span class="mf">10.62</span><span class="p">,</span><span class="o">-</span><span class="mf">10.12</span><span class="p">,</span><span class="o">-</span><span class="mf">20.00</span><span class="p">,</span>
                               <span class="o">-</span><span class="mf">10.20</span><span class="p">,</span><span class="o">-</span><span class="mf">10.92</span><span class="p">,</span><span class="o">-</span><span class="mf">10.35</span><span class="p">,</span> <span class="o">-</span><span class="mf">11.10</span><span class="p">,</span><span class="o">-</span><span class="mf">10.18</span><span class="p">,</span><span class="o">-</span><span class="mf">10.58</span><span class="p">,</span><span class="o">-</span><span class="mf">10.04</span><span class="p">,</span><span class="o">-</span><span class="mf">11.04</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.80</span><span class="p">,</span>
                               <span class="o">-</span><span class="mf">10.53</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.81</span><span class="p">,</span><span class="o">-</span><span class="mf">10.92</span><span class="p">,</span>  <span class="o">-</span><span class="mf">9.91</span><span class="p">,</span><span class="o">-</span><span class="mf">10.82</span><span class="p">,</span><span class="o">-</span><span class="mf">10.49</span><span class="p">,</span><span class="o">-</span><span class="mf">11.33</span><span class="p">,</span><span class="o">-</span><span class="mf">10.54</span><span class="p">,</span><span class="o">-</span><span class="mf">20.00</span><span class="p">,</span>
                               <span class="o">-</span><span class="mf">11.04</span><span class="p">,</span><span class="o">-</span><span class="mf">11.53</span><span class="p">,</span><span class="o">-</span><span class="mf">10.92</span><span class="p">,</span> <span class="o">-</span><span class="mf">11.94</span><span class="p">,</span><span class="o">-</span><span class="mf">10.94</span><span class="p">,</span><span class="o">-</span><span class="mf">11.78</span><span class="p">,</span><span class="o">-</span><span class="mf">11.11</span><span class="p">,</span><span class="o">-</span><span class="mf">12.04</span><span class="p">,</span><span class="o">-</span><span class="mf">10.96</span><span class="p">,</span>
                               <span class="o">-</span><span class="mf">11.28</span><span class="p">,</span><span class="o">-</span><span class="mf">11.16</span><span class="p">,</span><span class="o">-</span><span class="mf">11.91</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.93</span><span class="p">,</span><span class="o">-</span><span class="mf">11.77</span><span class="p">,</span><span class="o">-</span><span class="mf">10.59</span><span class="p">,</span><span class="o">-</span><span class="mf">10.69</span><span class="p">,</span><span class="o">-</span><span class="mf">10.24</span><span class="p">,</span><span class="o">-</span><span class="mf">11.03</span><span class="p">,</span>
                               <span class="o">-</span><span class="mf">10.95</span><span class="p">,</span><span class="o">-</span><span class="mf">11.14</span><span class="p">,</span><span class="o">-</span><span class="mf">10.19</span><span class="p">,</span> <span class="o">-</span><span class="mf">11.33</span><span class="p">,</span><span class="o">-</span><span class="mf">20.00</span><span class="p">,</span><span class="o">-</span><span class="mf">20.00</span><span class="p">,</span><span class="o">-</span><span class="mf">20.00</span><span class="p">,</span><span class="o">-</span><span class="mf">20.00</span><span class="p">,</span><span class="o">-</span><span class="mf">20.00</span><span class="p">,</span>
                               <span class="o">-</span><span class="mf">20.00</span><span class="p">,</span><span class="o">-</span><span class="mf">11.92</span><span class="p">,</span><span class="o">-</span><span class="mf">20.00</span><span class="p">,</span> <span class="o">-</span><span class="mf">12.51</span><span class="p">,</span><span class="o">-</span><span class="mf">20.00</span><span class="p">,</span><span class="o">-</span><span class="mf">20.00</span><span class="p">,</span><span class="o">-</span><span class="mf">20.00</span><span class="p">,</span><span class="o">-</span><span class="mf">20.00</span><span class="p">,</span><span class="o">-</span><span class="mf">20.00</span><span class="p">,</span>
                               <span class="o">-</span><span class="mf">20.00</span><span class="p">,</span><span class="o">-</span><span class="mf">20.00</span><span class="p">])</span>


    <span class="n">AMASS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">([</span><span class="mf">1.008</span><span class="p">,</span>  <span class="mf">4.003</span><span class="p">,</span>  <span class="mf">6.941</span><span class="p">,</span>  <span class="mf">9.012</span><span class="p">,</span> <span class="mf">10.811</span><span class="p">,</span> <span class="mf">12.011</span><span class="p">,</span> <span class="mf">14.007</span><span class="p">,</span> <span class="mf">15.999</span><span class="p">,</span>
                        <span class="mf">18.998</span><span class="p">,</span> <span class="mf">20.179</span><span class="p">,</span> <span class="mf">22.990</span><span class="p">,</span> <span class="mf">24.305</span><span class="p">,</span> <span class="mf">26.982</span><span class="p">,</span> <span class="mf">28.086</span><span class="p">,</span> <span class="mf">30.974</span><span class="p">,</span> <span class="mf">32.060</span><span class="p">,</span>
                        <span class="mf">35.453</span><span class="p">,</span> <span class="mf">39.948</span><span class="p">,</span> <span class="mf">39.102</span><span class="p">,</span> <span class="mf">40.080</span><span class="p">,</span> <span class="mf">44.956</span><span class="p">,</span> <span class="mf">47.900</span><span class="p">,</span> <span class="mf">50.941</span><span class="p">,</span> <span class="mf">51.996</span><span class="p">,</span>
                        <span class="mf">54.938</span><span class="p">,</span> <span class="mf">55.847</span><span class="p">,</span> <span class="mf">58.933</span><span class="p">,</span> <span class="mf">58.710</span><span class="p">,</span> <span class="mf">63.546</span><span class="p">,</span> <span class="mf">65.370</span><span class="p">,</span> <span class="mf">69.720</span><span class="p">,</span> <span class="mf">72.590</span><span class="p">,</span>
                        <span class="mf">74.922</span><span class="p">,</span> <span class="mf">78.960</span><span class="p">,</span> <span class="mf">79.904</span><span class="p">,</span> <span class="mf">83.800</span><span class="p">,</span> <span class="mf">85.468</span><span class="p">,</span> <span class="mf">87.620</span><span class="p">,</span> <span class="mf">88.906</span><span class="p">,</span> <span class="mf">91.220</span><span class="p">,</span>
                        <span class="mf">92.906</span><span class="p">,</span> <span class="mf">95.940</span><span class="p">,</span> <span class="mf">98.906</span><span class="p">,</span><span class="mf">101.070</span><span class="p">,</span><span class="mf">102.905</span><span class="p">,</span><span class="mf">106.400</span><span class="p">,</span><span class="mf">107.868</span><span class="p">,</span><span class="mf">112.400</span><span class="p">,</span>
                        <span class="mf">114.820</span><span class="p">,</span><span class="mf">118.690</span><span class="p">,</span><span class="mf">121.750</span><span class="p">,</span><span class="mf">127.600</span><span class="p">,</span><span class="mf">126.905</span><span class="p">,</span><span class="mf">131.300</span><span class="p">,</span><span class="mf">132.905</span><span class="p">,</span><span class="mf">137.340</span><span class="p">,</span>
                        <span class="mf">138.906</span><span class="p">,</span><span class="mf">140.120</span><span class="p">,</span><span class="mf">140.908</span><span class="p">,</span><span class="mf">144.240</span><span class="p">,</span><span class="mf">146.000</span><span class="p">,</span><span class="mf">150.400</span><span class="p">,</span><span class="mf">151.960</span><span class="p">,</span><span class="mf">157.250</span><span class="p">,</span>
                        <span class="mf">158.925</span><span class="p">,</span><span class="mf">162.500</span><span class="p">,</span><span class="mf">164.930</span><span class="p">,</span><span class="mf">167.260</span><span class="p">,</span><span class="mf">168.934</span><span class="p">,</span><span class="mf">170.040</span><span class="p">,</span><span class="mf">174.970</span><span class="p">,</span><span class="mf">178.490</span><span class="p">,</span>
                        <span class="mf">180.948</span><span class="p">,</span><span class="mf">183.850</span><span class="p">,</span><span class="mf">186.200</span><span class="p">,</span><span class="mf">190.200</span><span class="p">,</span><span class="mf">192.200</span><span class="p">,</span><span class="mf">195.090</span><span class="p">,</span><span class="mf">196.967</span><span class="p">,</span><span class="mf">200.590</span><span class="p">,</span>
                        <span class="mf">204.370</span><span class="p">,</span><span class="mf">207.190</span><span class="p">,</span><span class="mf">208.981</span><span class="p">,</span><span class="mf">210.000</span><span class="p">,</span><span class="mf">210.000</span><span class="p">,</span><span class="mf">222.000</span><span class="p">,</span><span class="mf">223.000</span><span class="p">,</span><span class="mf">226.025</span><span class="p">,</span>
                        <span class="mf">227.000</span><span class="p">,</span><span class="mf">232.038</span><span class="p">,</span><span class="mf">230.040</span><span class="p">,</span><span class="mf">238.029</span><span class="p">,</span><span class="mf">237.048</span><span class="p">,</span><span class="mf">242.000</span><span class="p">,</span><span class="mf">242.000</span><span class="p">,</span><span class="mf">245.000</span><span class="p">,</span>
                        <span class="mf">248.000</span><span class="p">,</span><span class="mf">252.000</span><span class="p">,</span><span class="mf">253.000</span><span class="p">])</span>


    <span class="c1"># Energy of a 6 level H atom in erg and corresponding g-values</span>

    <span class="n">eH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">((</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">82258.211</span><span class="p">,</span> <span class="mf">97491.219</span><span class="p">,</span> <span class="mf">102822.76</span><span class="p">,</span> <span class="mf">105290.508</span><span class="p">,</span> <span class="mf">109677.617</span><span class="p">))</span> <span class="o">*</span> <span class="n">HH</span> <span class="o">*</span> <span class="n">CC</span>
    <span class="n">gH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">((</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">,</span> <span class="mf">18.0</span><span class="p">,</span> <span class="mf">32.0</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
    <span class="c1"># ----------------------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">init_pf_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ifile</span><span class="p">,</span> <span class="n">to_EV</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1">#</span>
        <span class="c1"># Reads Kurucz&#39;s partition functions and ionization potentials from a file</span>
        <span class="c1"># Taken from RH (Uitenbroek 2001)</span>
        <span class="c1">#</span>

        <span class="n">ff</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ifile</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">ff</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">xdrlib</span><span class="o">.</span><span class="n">Unpacker</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">npf</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">unpack_uint</span><span class="p">()</span>

        <span class="n">nelem</span> <span class="o">=</span> <span class="mi">99</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tpf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">unpack_farray</span><span class="p">(</span><span class="n">npf</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">unpack_double</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">el</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">nelem</span>

        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nelem</span><span class="p">):</span>
            <span class="n">pti</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">unpack_uint</span><span class="p">()</span>
            <span class="n">nstage</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">unpack_uint</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">dum</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">pf</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">unpack_farray</span><span class="p">(</span><span class="n">npf</span><span class="o">*</span><span class="n">nstage</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">unpack_double</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nstage</span><span class="p">,</span> <span class="n">npf</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">eion</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">unpack_farray</span><span class="p">(</span><span class="n">nstage</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">unpack_double</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">HH</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">CC</span>


            <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">nstage</span> <span class="o">=</span> <span class="n">nstage</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">npf</span> <span class="o">=</span> <span class="n">pti</span>

            <span class="k">if</span><span class="p">(</span><span class="n">to_EV</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">eion</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EV</span>

    <span class="c1"># ----------------------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">acota</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">):</span>

        <span class="k">if</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">x0</span><span class="p">):</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x0</span>
        <span class="k">if</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">x1</span><span class="p">):</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x1</span>

        <span class="k">return</span> <span class="n">x</span>

    <span class="c1"># ----------------------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">acotasig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acota</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acota</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span>

    <span class="c1"># ----------------------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">b</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>

    <span class="c1"># ----------------------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">abund_init</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">prec</span> <span class="o">=</span> <span class="mf">1.e-5</span><span class="p">,</span> <span class="n">pf_file</span><span class="o">=</span><span class="s1">&#39;pf_Kurucz.input&#39;</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prec</span> <span class="o">=</span> <span class="mf">1.e-5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncontr</span> <span class="o">=</span> <span class="mi">28</span> <span class="c1"># number of species contributing as electron donnors (sorted)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float64&#39;</span>

        <span class="c1"># Replace default abundances ?</span>
        <span class="n">nabund</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">abund_init</span><span class="p">)</span>

        <span class="k">if</span><span class="p">(</span><span class="n">nabund</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ABUND</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nabund</span><span class="p">]</span> <span class="o">=</span> <span class="n">abund_init</span>
            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;witt::__init__: replacing default abundances with user provided values&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">abtot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ABUND</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ABUND</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abtot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abtot</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ab_others</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ABUND</span><span class="p">[</span><span class="mi">1</span><span class="p">::]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ABUND</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">avw</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ABUND</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">AMASS</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">muH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avw</span><span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">AMASS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ABUND</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho_from_H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">muH</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">AMASS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">AMU</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">BK</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">avw</span> <span class="o">*=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">AMU</span>

        <span class="c1"># init arrays for later</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alfai</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncontr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chi1</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncontr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chi2</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncontr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u0</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncontr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u1</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncontr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u2</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncontr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="c1"># Init PF</span>

        <span class="n">DATA_PATH</span> <span class="o">=</span> <span class="n">get_data_path</span><span class="p">()</span> <span class="o">+</span> <span class="n">pf_file</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_pf_data</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>



    <span class="c1"># ----------------------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">nsaha</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">xne</span><span class="p">,</span> <span class="n">u0</span><span class="p">,</span> <span class="n">u1</span><span class="p">,</span> <span class="n">eion</span><span class="p">):</span>
        <span class="c1"># operates with t, xne and eion in EV</span>
        <span class="k">return</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">saha_fac</span> <span class="o">*</span> <span class="p">(</span><span class="n">u1</span> <span class="o">/</span> <span class="n">u0</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span><span class="o">**</span><span class="mf">1.5</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">eion</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">EV</span> <span class="o">/</span> <span class="p">(</span><span class="n">t</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">BK</span><span class="p">))</span> <span class="o">/</span> <span class="n">xne</span>

    <span class="c1"># ----------------------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">saha</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">eion</span><span class="p">,</span> <span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">pe</span><span class="p">):</span>
        <span class="c1"># Operates with theta, eion in eV and pe</span>
        <span class="k">return</span> <span class="n">u2</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="mf">2.302585093</span><span class="o">*</span><span class="p">(</span><span class="mf">9.0804625434325867</span><span class="o">-</span><span class="n">theta</span><span class="o">*</span><span class="n">eion</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">u1</span><span class="o">*</span><span class="n">pe</span><span class="o">*</span><span class="n">theta</span><span class="o">**</span><span class="mf">2.5</span><span class="p">)</span>

    <span class="c1"># ----------------------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">init_pe_from_pg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">pg</span><span class="p">):</span>

        <span class="c1"># Assume that only H is a electron donnor</span>

        <span class="n">nu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ABUND</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">saha</span> <span class="o">=</span> <span class="mf">10.0</span><span class="o">**</span><span class="p">(</span> <span class="o">-</span><span class="mf">0.4771</span><span class="o">+</span><span class="mf">2.5</span><span class="o">*</span><span class="n">log10</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">-</span><span class="n">log10</span><span class="p">(</span><span class="n">pg</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="mf">13.6</span><span class="o">*</span><span class="mf">5040.0</span><span class="o">/</span><span class="n">t</span><span class="p">))</span>
        <span class="n">aaa</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">saha</span>
        <span class="n">bbb</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">nu</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">saha</span>
        <span class="n">ccc</span> <span class="o">=</span> <span class="o">-</span><span class="n">saha</span><span class="o">*</span><span class="n">nu</span>
        <span class="n">ybh</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">bbb</span><span class="o">+</span><span class="n">sqrt</span><span class="p">(</span><span class="n">bbb</span><span class="o">*</span><span class="n">bbb</span><span class="o">-</span><span class="mf">4.</span><span class="o">*</span><span class="n">aaa</span><span class="o">*</span><span class="n">ccc</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">aaa</span><span class="p">)</span>
        <span class="n">pe</span><span class="o">=</span><span class="n">pg</span><span class="o">*</span><span class="n">ybh</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">ybh</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pe</span>

    <span class="c1"># ----------------------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">pe_from_pg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">pg</span><span class="p">,</span> <span class="n">get_fe</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>

        <span class="n">dif</span> <span class="o">=</span> <span class="mf">1.1</span>
        <span class="n">pe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_pe_from_pg</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">pg</span><span class="p">)</span> <span class="c1"># Init Pe assuming only H and increase it 10%</span>
        <span class="n">ope</span> <span class="o">=</span> <span class="n">pe</span>
        <span class="n">it</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">dif</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">prec</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">it</span> <span class="o">&lt;</span> <span class="mi">250</span><span class="p">)):</span>
            <span class="n">pe</span> <span class="o">=</span> <span class="p">(</span><span class="n">ope</span> <span class="o">+</span> <span class="n">pe</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span>
            <span class="n">ope</span> <span class="o">=</span> <span class="n">pe</span>

            <span class="n">pe</span><span class="p">,</span><span class="n">fe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pe_pg</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">pg</span><span class="p">,</span> <span class="n">get_fe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">dif</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pe</span><span class="o">-</span><span class="n">ope</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">pe</span><span class="o">+</span><span class="n">ope</span><span class="p">)</span>
            <span class="n">it</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;witt::pe_from_pg: convergence niter = </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">it</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span><span class="p">(</span><span class="n">get_fe</span><span class="p">):</span> <span class="k">return</span> <span class="n">pe</span><span class="p">,</span> <span class="n">fe</span>
        <span class="k">return</span> <span class="n">pe</span>

    <span class="c1"># ----------------------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">pe_from_rho</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">rho</span><span class="p">):</span>

        <span class="c1"># fraction of atoms</span>

        <span class="n">xna</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">avw</span>
        <span class="n">BKT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BK</span> <span class="o">*</span> <span class="n">t</span>

        <span class="c1"># now estimate Pgas and iterate</span>

        <span class="k">if</span><span class="p">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="mi">8000</span><span class="p">):</span> <span class="n">a</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">;</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="mi">4000</span><span class="p">):</span> <span class="n">a</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">):</span> <span class="n">a</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">;</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">a</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">;</span>

        <span class="n">xne</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">xna</span> <span class="o">/</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span>
        <span class="n">Pgas</span> <span class="o">=</span> <span class="p">(</span><span class="n">xna</span><span class="o">+</span><span class="n">xne</span><span class="p">)</span><span class="o">*</span><span class="n">BKT</span>


        <span class="c1"># Iterate</span>

        <span class="n">it</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">dif</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="k">while</span><span class="p">((</span><span class="n">it</span> <span class="o">&lt;</span> <span class="mi">250</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">dif</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">prec</span><span class="p">)):</span>
            <span class="n">oPgas</span> <span class="o">=</span> <span class="n">Pgas</span>
            <span class="n">Pe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pe_from_pg</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Pgas</span><span class="p">)</span>
            <span class="n">xna_guessed</span> <span class="o">=</span> <span class="p">(</span><span class="n">Pgas</span><span class="o">-</span><span class="n">Pe</span><span class="p">)</span><span class="o">/</span><span class="n">BKT</span>
            <span class="n">dif</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xna</span><span class="o">-</span><span class="n">xna_guessed</span><span class="p">)</span><span class="o">/</span><span class="n">xna</span>

            <span class="n">Pgas</span>  <span class="o">*=</span> <span class="n">xna</span><span class="o">/</span><span class="n">xna_guessed</span>

        <span class="k">return</span> <span class="n">Pe</span><span class="c1">#, Pgas</span>

    <span class="c1"># ----------------------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">pg_from_rho</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">rho</span><span class="p">):</span>

        <span class="n">xna</span> <span class="o">=</span> <span class="p">(</span><span class="n">rho</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">avw</span><span class="p">)</span>

        <span class="k">if</span><span class="p">(</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="mi">8000</span><span class="p">):</span> <span class="n">a</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">;</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="mi">4000</span><span class="p">):</span> <span class="n">a</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">):</span> <span class="n">a</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">;</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">a</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">;</span>

        <span class="n">xne</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">xna</span> <span class="o">/</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span>
        <span class="n">pgas</span> <span class="o">=</span> <span class="p">(</span><span class="n">xna</span><span class="o">+</span><span class="n">xne</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">BK</span><span class="o">*</span><span class="n">temp</span>

        <span class="n">Pe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pe_from_pg</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">pgas</span><span class="p">)</span>
        <span class="n">irho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_from_pe</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">Pe</span><span class="p">)</span>

        <span class="n">dif</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">it</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span><span class="p">((</span><span class="n">dif</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prec</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">it</span><span class="o">&lt;</span><span class="mi">100</span><span class="p">)):</span>
            <span class="n">Pe</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">rho</span> <span class="o">/</span> <span class="n">irho</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span>
            <span class="n">irho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_from_pe</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">Pe</span><span class="p">)</span>
            <span class="n">dif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">irho</span> <span class="o">-</span> <span class="n">rho</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">rho</span><span class="p">))</span>
            <span class="n">it</span><span class="o">+=</span><span class="mi">1</span>

        <span class="n">pgas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pg_from_pe</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">Pe</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pgas</span>

    <span class="c1"># ----------------------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">rho_from_pe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">temp</span><span class="p">,</span> <span class="n">pe</span><span class="p">):</span>

        <span class="n">pg</span><span class="p">,</span> <span class="n">fe_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pg_from_pe</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">pe</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_from_H</span> <span class="o">/</span> <span class="p">(</span><span class="n">fe_out</span> <span class="o">*</span> <span class="n">temp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rho</span>

    <span class="c1"># ----------------------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">rho_from_pg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">temp</span><span class="p">,</span> <span class="n">pg</span><span class="p">):</span>

        <span class="n">pe</span><span class="p">,</span> <span class="n">fe_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pe_from_pg</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">pg</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">pe</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_from_H</span> <span class="o">/</span> <span class="p">(</span><span class="n">fe_out</span> <span class="o">*</span> <span class="n">temp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rho</span>
    <span class="c1"># ----------------------------------------------------------------------------------------</span>


    <span class="k">def</span> <span class="nf">molecb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">);</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=-</span><span class="mf">11.206998</span><span class="o">+</span><span class="n">X</span><span class="o">*</span><span class="p">(</span><span class="mf">2.7942767</span><span class="o">+</span><span class="n">X</span><span class="o">*</span><span class="p">(</span><span class="mf">7.9196803E-2</span><span class="o">-</span><span class="n">X</span><span class="o">*</span><span class="mf">2.4790744E-2</span><span class="p">))</span> <span class="c1"># H2</span>
        <span class="n">Y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=-</span><span class="mf">12.533505</span><span class="o">+</span><span class="n">X</span><span class="o">*</span><span class="p">(</span><span class="mf">4.9251644</span><span class="o">+</span><span class="n">X</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">5.6191273E-2</span><span class="o">+</span><span class="n">X</span><span class="o">*</span><span class="mf">3.2687661E-3</span><span class="p">))</span> <span class="c1"># H</span>
        <span class="n">dx</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">X</span><span class="o">*</span><span class="n">X</span><span class="p">)</span><span class="o">/</span><span class="mf">5040.</span>

        <span class="n">dy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">dx</span><span class="o">*</span><span class="p">(</span><span class="mf">2.7942767</span><span class="o">+</span><span class="n">X</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="mf">7.9196803e-2</span><span class="o">-</span><span class="n">X</span><span class="o">*</span><span class="mi">3</span><span class="o">*</span><span class="mf">2.4790744e-2</span><span class="p">))</span>
        <span class="n">dy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">dx</span><span class="o">*</span><span class="p">(</span><span class="mf">4.9251644</span><span class="o">+</span><span class="n">X</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="mf">5.6191273e-2</span><span class="o">-</span><span class="n">X</span><span class="o">*</span><span class="mi">3</span><span class="o">*</span><span class="mf">3.2687661e-3</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">Y</span><span class="p">,</span> <span class="n">dy</span>

    <span class="c1"># ----------------------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">pe_pg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">pgas</span><span class="p">,</span> <span class="n">get_fe</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="n">g1</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span> <span class="n">theta</span> <span class="o">=</span> <span class="mf">5040.0</span><span class="o">/</span><span class="n">t</span>


        <span class="c1"># Init some values</span>

        <span class="k">if</span><span class="p">(</span><span class="n">pe</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">):</span>
            <span class="n">pe</span> <span class="o">=</span> <span class="mf">1.e-15</span>
            <span class="n">g4</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">g5</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmol</span><span class="p">,</span> <span class="n">dcmol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecb</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
            <span class="n">cmol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acota</span><span class="p">(</span><span class="n">cmol</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mf">30.</span><span class="p">,</span> <span class="mf">30.</span><span class="p">)</span>
            <span class="n">cmol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acota</span><span class="p">(</span><span class="n">cmol</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mf">30.</span><span class="p">,</span> <span class="mf">30.</span><span class="p">)</span>

            <span class="n">g4</span> <span class="o">=</span> <span class="n">pe</span> <span class="o">*</span> <span class="mf">10.0</span><span class="o">**</span><span class="n">cmol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">g5</span> <span class="o">=</span> <span class="n">pe</span> <span class="o">*</span> <span class="mf">10.0</span><span class="o">**</span><span class="n">cmol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1">#</span>
        <span class="c1"># H first</span>
        <span class="c1">#</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">partition_f</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">only</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">g2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saha</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">eion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pe</span><span class="p">)</span> <span class="c1"># p(h+)/p(h)</span>
        <span class="n">g3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saha</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="mf">0.754</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pe</span><span class="p">)</span>        <span class="c1"># p(h)/p(h-)</span>
        <span class="n">g3</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">acota</span><span class="p">(</span><span class="n">g3</span><span class="p">,</span> <span class="mf">1.e-30</span><span class="p">,</span> <span class="mf">1.0e30</span><span class="p">)</span>


        <span class="c1">#</span>
        <span class="c1"># Now count electrons contributed by the first</span>
        <span class="c1"># two ionized stages of all contributing atoms</span>
        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncontr</span><span class="p">):</span>
            <span class="n">alfai</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ABUND</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ABUND</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># relative to H abundance</span>
            <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">partition_f</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">only</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saha</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">eion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pe</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saha</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">eion</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">pe</span><span class="p">)</span>

            <span class="n">c</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">+</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">b</span><span class="p">)</span>
            <span class="n">g1</span> <span class="o">+=</span> <span class="n">alfai</span><span class="o">/</span><span class="n">c</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">b</span><span class="p">)</span>


        <span class="c1"># All the math...</span>

        <span class="n">a</span><span class="o">=</span><span class="mf">1.</span><span class="o">+</span><span class="n">g2</span><span class="o">+</span><span class="n">g3</span>
        <span class="n">b</span><span class="o">=</span><span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">g2</span><span class="o">/</span><span class="n">g5</span><span class="o">*</span><span class="n">g4</span><span class="p">)</span>
        <span class="n">c</span><span class="o">=</span><span class="n">g5</span>
        <span class="n">d</span><span class="o">=</span><span class="n">g2</span><span class="o">-</span><span class="n">g3</span>
        <span class="n">e</span><span class="o">=</span><span class="n">g2</span><span class="o">/</span><span class="n">g5</span><span class="o">*</span><span class="n">g4</span>

        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acotasig</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mf">1.e-15</span><span class="p">,</span> <span class="mf">1.e15</span><span class="p">);</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acotasig</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mf">1.e-15</span><span class="p">,</span> <span class="mf">1.e15</span><span class="p">);</span>

        <span class="n">c1</span><span class="o">=</span><span class="n">c</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="n">b</span><span class="o">+</span><span class="n">a</span><span class="o">*</span><span class="n">d</span><span class="o">*</span><span class="n">b</span><span class="o">-</span><span class="n">e</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">a</span>
        <span class="n">c2</span><span class="o">=</span><span class="mf">2.0</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">e</span><span class="o">-</span><span class="n">d</span><span class="o">*</span><span class="n">b</span><span class="o">+</span><span class="n">a</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="n">g1</span>
        <span class="n">c3</span><span class="o">=-</span><span class="p">(</span><span class="n">e</span><span class="o">+</span><span class="n">b</span><span class="o">*</span><span class="n">g1</span><span class="p">)</span>
        <span class="n">f1</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">c2</span><span class="o">/</span><span class="n">c1</span>
        <span class="n">f1</span><span class="o">=-</span><span class="n">f1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="n">c1</span><span class="p">)</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">f1</span><span class="o">*</span><span class="n">f1</span><span class="o">-</span><span class="n">c3</span><span class="o">/</span><span class="n">c1</span><span class="p">)</span>
        <span class="n">f5</span><span class="o">=</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">f1</span><span class="p">)</span><span class="o">/</span><span class="n">b</span>
        <span class="n">f4</span><span class="o">=</span><span class="n">e</span><span class="o">*</span><span class="n">f5</span>
        <span class="n">f3</span><span class="o">=</span><span class="n">g3</span><span class="o">*</span><span class="n">f1</span>
        <span class="n">f2</span><span class="o">=</span><span class="n">g2</span><span class="o">*</span><span class="n">f1</span>
        <span class="n">fe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acota</span><span class="p">(</span><span class="n">f2</span><span class="o">-</span><span class="n">f3</span><span class="o">+</span><span class="n">f4</span><span class="o">+</span><span class="n">g1</span><span class="p">,</span> <span class="mf">1.e-30</span><span class="p">,</span> <span class="mf">1.e30</span><span class="p">)</span>
        <span class="n">phtot</span> <span class="o">=</span> <span class="n">pe</span><span class="o">/</span><span class="n">fe</span>

        <span class="c1"># Refinement by Wittmann, not sure this is needed in</span>
        <span class="c1"># double prec.</span>

        <span class="k">if</span><span class="p">(</span><span class="n">f5</span> <span class="o">&lt;=</span> <span class="mf">1.e-4</span><span class="p">):</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span> <span class="n">const6</span><span class="o">=</span><span class="n">g5</span><span class="o">/</span><span class="n">pe</span><span class="o">*</span><span class="n">f1</span><span class="o">*</span><span class="n">f1</span><span class="p">;</span> <span class="n">const7</span><span class="o">=</span><span class="n">f2</span><span class="o">-</span><span class="n">f3</span><span class="o">+</span><span class="n">g1</span><span class="p">;</span> <span class="n">it</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">while</span><span class="p">((</span><span class="n">diff</span> <span class="o">&gt;</span> <span class="mf">1.e-5</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">it</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)):</span>
                <span class="n">of5</span> <span class="o">=</span> <span class="n">f5</span>
                <span class="n">f5</span><span class="o">=</span><span class="n">phtot</span><span class="o">*</span><span class="n">const6</span>
                <span class="n">f4</span><span class="o">=</span><span class="n">e</span><span class="o">*</span><span class="n">f5</span>
                <span class="n">fe</span><span class="o">=</span><span class="n">const7</span><span class="o">+</span><span class="n">f4</span>
                <span class="n">phtot</span><span class="o">=</span><span class="n">pe</span><span class="o">/</span><span class="n">fe</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">fabs</span><span class="p">(</span><span class="n">f5</span><span class="o">-</span><span class="n">of5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">f5</span> <span class="o">+</span> <span class="n">of5</span><span class="p">)</span>
                <span class="n">it</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Recompute pe</span>

        <span class="n">pe</span> <span class="o">=</span> <span class="n">pgas</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="p">(</span><span class="n">f1</span><span class="o">+</span><span class="n">f2</span><span class="o">+</span><span class="n">f3</span><span class="o">+</span><span class="n">f4</span><span class="o">+</span><span class="n">f5</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ab_others</span><span class="p">)</span><span class="o">/</span><span class="n">fe</span><span class="p">)</span>

        <span class="k">if</span><span class="p">(</span><span class="n">pe</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">):</span>
            <span class="n">pe</span> <span class="o">=</span> <span class="mf">1.e-15</span>

        <span class="k">if</span><span class="p">(</span><span class="n">get_fe</span><span class="p">):</span> <span class="k">return</span> <span class="n">pe</span><span class="p">,</span> <span class="n">fe</span>
        <span class="k">return</span> <span class="n">pe</span>


    <span class="c1"># ----------------------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">Boltzmann</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">glow</span><span class="p">,</span> <span class="n">e_pot</span><span class="p">):</span>
        <span class="c1"># Gives the ratio between the total population of a ionization stage and a given level</span>
        <span class="c1"># The energy levels must be in Erg.</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">glow</span> <span class="o">/</span> <span class="n">u</span><span class="p">)</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">e_pot</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BK</span><span class="o">*</span><span class="n">t</span><span class="p">))</span>

    <span class="c1"># ----------------------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">getH6pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">pgas</span><span class="p">,</span> <span class="n">pe</span><span class="p">):</span>


        <span class="c1"># Solve ionization for H</span>

        <span class="n">n</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getXparts</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">pgas</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">divide_by_u</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">return_u</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>


        <span class="c1"># Define output array</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
        <span class="n">res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># number of protons</span>

        <span class="n">ratios</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>

        <span class="c1"># Solve level populations for the 5 first levels of H</span>

        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">ratios</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Boltzmann</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">gH</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">eH</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>


        <span class="c1"># particle conservation (with 6 levels in H this line has no effect)</span>

        <span class="c1">#ratios /= ratios.sum()</span>


        <span class="c1"># Multiply the neutral H population by the ratios of level populations</span>

        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ratios</span>


        <span class="k">return</span> <span class="n">res</span>


    <span class="c1"># ----------------------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">_itep1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Linear interpolation routine</span>
<span class="sd">        input:</span>
<span class="sd">             x: array of input x values</span>
<span class="sd">             y: array of input y values</span>
<span class="sd">             xx: scalar x value where the interpolated value of &quot;y must be calculated</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span><span class="p">(</span><span class="n">xx</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> <span class="k">return</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">xx</span> <span class="o">&gt;=</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span> <span class="k">return</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="o">&gt;</span><span class="n">xx</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="n">p0</span><span class="o">-</span><span class="mi">1</span>

            <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="n">p0</span><span class="p">]</span>
            <span class="n">u1</span> <span class="o">=</span> <span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="n">p0</span><span class="p">])</span> <span class="o">/</span> <span class="n">dx</span>
            <span class="n">u0</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">u1</span>

            <span class="k">return</span> <span class="n">u0</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="n">p0</span><span class="p">]</span> <span class="o">+</span> <span class="n">u1</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span>


    <span class="c1"># ----------------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="witt.partition_f"><a class="viewcode-back" href="../../lightweaver-api.html#lightweaver.witt.witt.partition_f">[docs]</a>    <span class="k">def</span> <span class="nf">partition_f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">only</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the partition function of element &quot;n&quot; for a given temperature</span>

<span class="sd">        input:</span>
<span class="sd">             n: Atomic number of the atom -1 (H is 0).</span>
<span class="sd">             t: Temperature in K.</span>
<span class="sd">        Keywords:</span>
<span class="sd">             only: (=int) only return this number first levels of the atom.</span>
<span class="sd">                   The default is to return all the levels</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">nstage</span>

        <span class="k">if</span><span class="p">(</span><span class="n">only</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">nn</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="n">only</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">only</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nn</span><span class="p">):</span>
            <span class="n">res</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_itep1</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">tpf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">pf</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">t</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span></div>

    <span class="c1"># ----------------------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">pg_from_pe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">get_fe</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="n">pg</span><span class="p">,</span> <span class="n">dum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gasc</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">pe</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">get_fe</span><span class="p">):</span> <span class="k">return</span> <span class="n">pg</span><span class="p">,</span> <span class="n">dum</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">pg</span>

    <span class="c1"># ----------------------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">gasc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">pe</span><span class="p">):</span>

        <span class="n">pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncontr</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="n">theta</span> <span class="o">=</span> <span class="mf">5040.</span> <span class="o">/</span> <span class="n">t</span>
        <span class="n">cmol</span><span class="p">,</span> <span class="n">dmol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecb</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>

        <span class="n">g4</span> <span class="o">=</span> <span class="mf">10.0</span><span class="o">**</span><span class="n">cmol</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">g5</span> <span class="o">=</span> <span class="mf">10.0</span><span class="o">**</span><span class="n">cmol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>


        <span class="c1"># First H</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">partition_f</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">g2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saha</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">eion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pe</span><span class="p">)</span> <span class="c1"># p(h+)/p(h)</span>
        <span class="n">g3</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">saha</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="mf">0.754</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pe</span><span class="p">)</span>        <span class="c1"># p(h)/p(h-)</span>
        <span class="n">g1</span> <span class="o">=</span> <span class="mf">0.0</span>


        <span class="c1"># Other contributions</span>

        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncontr</span><span class="p">):</span>
            <span class="n">alfai</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ABUND</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ABUND</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># relative to H abundance</span>
            <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">partition_f</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">only</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saha</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">eion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pe</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saha</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">eion</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">pe</span><span class="p">)</span>

            <span class="n">c</span><span class="o">=</span><span class="mf">1.</span><span class="o">+</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">b</span><span class="p">)</span> <span class="c1"># fraction of n0/ntot</span>

            <span class="n">pp</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">=</span><span class="n">alfai</span><span class="o">/</span><span class="n">c</span> <span class="c1"># abund /ntot (partial pressure of neutral species ii)</span>

            <span class="c1"># 1*n1 + 2*n2 + ... j*n_j so we count how many electrons</span>
            <span class="c1"># come from each ionized species</span>

            <span class="n">g1</span> <span class="o">+=</span> <span class="n">pp</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">b</span><span class="p">)</span>


        <span class="n">a</span><span class="o">=</span><span class="mf">1.</span><span class="o">+</span><span class="n">g2</span><span class="o">+</span><span class="n">g3</span>
        <span class="n">e</span><span class="o">=</span><span class="n">g2</span><span class="o">/</span><span class="n">g5</span><span class="o">*</span><span class="n">g4</span>
        <span class="n">b</span><span class="o">=</span><span class="mf">2.0</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">c</span><span class="o">=</span><span class="n">g5</span>
        <span class="n">d</span><span class="o">=</span><span class="n">g2</span><span class="o">-</span><span class="n">g3</span>
        <span class="n">c1</span><span class="o">=</span><span class="n">c</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="n">b</span><span class="o">+</span><span class="n">a</span><span class="o">*</span><span class="n">d</span><span class="o">*</span><span class="n">b</span><span class="o">-</span><span class="n">e</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">a</span>
        <span class="n">c2</span><span class="o">=</span><span class="mf">2.</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">e</span><span class="o">-</span><span class="n">d</span><span class="o">*</span><span class="n">b</span><span class="o">+</span><span class="n">a</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="n">g1</span>
        <span class="n">c3</span><span class="o">=-</span><span class="p">(</span><span class="n">e</span><span class="o">+</span><span class="n">b</span><span class="o">*</span><span class="n">g1</span><span class="p">)</span>
        <span class="n">f1</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">c2</span><span class="o">/</span><span class="n">c1</span>
        <span class="n">f1</span><span class="o">=-</span><span class="n">f1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="n">c1</span><span class="p">)</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">f1</span><span class="o">*</span><span class="n">f1</span><span class="o">-</span><span class="n">c3</span><span class="o">/</span><span class="n">c1</span><span class="p">)</span>
        <span class="n">f5</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">f1</span><span class="p">)</span><span class="o">/</span><span class="n">b</span>

        <span class="n">f4</span><span class="o">=</span><span class="n">e</span><span class="o">*</span><span class="n">f5</span>
        <span class="n">f3</span><span class="o">=</span><span class="n">g3</span><span class="o">*</span><span class="n">f1</span>
        <span class="n">f2</span><span class="o">=</span><span class="n">g2</span><span class="o">*</span><span class="n">f1</span>
        <span class="n">fe</span><span class="o">=</span><span class="n">f2</span><span class="o">-</span><span class="n">f3</span><span class="o">+</span><span class="n">f4</span><span class="o">+</span><span class="n">g1</span>
        <span class="n">phtot</span><span class="o">=</span><span class="n">pe</span><span class="o">/</span><span class="n">fe</span>

        <span class="c1"># Refinement by Wittmann</span>
        <span class="k">if</span><span class="p">(</span><span class="n">f5</span> <span class="o">&lt;=</span> <span class="mf">1.e-5</span><span class="p">):</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span> <span class="n">const6</span><span class="o">=</span><span class="n">g5</span><span class="o">/</span><span class="n">pe</span><span class="o">*</span><span class="n">f1</span><span class="o">*</span><span class="n">f1</span><span class="p">;</span> <span class="n">const7</span><span class="o">=</span><span class="n">f2</span><span class="o">-</span><span class="n">f3</span><span class="o">+</span><span class="n">g1</span><span class="p">;</span> <span class="n">it</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">while</span><span class="p">((</span><span class="n">diff</span> <span class="o">&gt;</span> <span class="mf">1.e-5</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">it</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)):</span>
                <span class="n">of5</span> <span class="o">=</span> <span class="n">f5</span>
                <span class="n">f5</span><span class="o">=</span><span class="n">phtot</span><span class="o">*</span><span class="n">const6</span>
                <span class="n">f4</span><span class="o">=</span><span class="n">e</span><span class="o">*</span><span class="n">f5</span>
                <span class="n">fe</span><span class="o">=</span><span class="n">const7</span><span class="o">+</span><span class="n">f4</span>
                <span class="n">phtot</span><span class="o">=</span><span class="n">pe</span><span class="o">/</span><span class="n">fe</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">fabs</span><span class="p">(</span><span class="n">f5</span><span class="o">-</span><span class="n">of5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">f5</span> <span class="o">+</span> <span class="n">of5</span><span class="p">)</span>
                <span class="n">it</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">pg</span><span class="o">=</span><span class="n">pe</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">+</span><span class="p">(</span><span class="n">f1</span><span class="o">+</span><span class="n">f2</span><span class="o">+</span><span class="n">f3</span><span class="o">+</span><span class="n">f4</span><span class="o">+</span><span class="n">f5</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ab_others</span><span class="p">)</span><span class="o">/</span><span class="n">fe</span><span class="p">)</span>

        <span class="c1"># Store the partial pressures of H too</span>

        <span class="n">pp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ncontr</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">f1</span>    <span class="c1">#  p(h)/p(h&#39;)</span>
        <span class="n">pp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ncontr</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">f2</span>    <span class="c1">#  p(h+)/p(h&#39;)</span>
        <span class="n">pp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ncontr</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">f5</span>    <span class="c1">#  p(h2)/p(h&#39;)</span>
        <span class="n">pp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ncontr</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">f3</span>    <span class="c1">#  p(h-)/p(h&#39;)</span>
        <span class="n">pp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ncontr</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">phtot</span> <span class="c1">#  p(h&#39;) (total hydrogen!)</span>
        <span class="n">pp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ncontr</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">fe</span> <span class="c1">#  p(h&#39;) (total hydrogen!)</span>


        <span class="k">return</span> <span class="n">pg</span><span class="p">,</span> <span class="n">pp</span>

    <span class="c1"># ----------------------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">getXparts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iatom</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">pg</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">divide_by_u</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">only</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">return_u</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>

        <span class="c1"># Precompute partial densities of atoms, electrons</span>
        <span class="c1"># and partial density of iatom with the abundance</span>

        <span class="n">TBK</span> <span class="o">=</span> <span class="n">t</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">BK</span><span class="p">;</span> <span class="n">xna</span> <span class="o">=</span> <span class="p">(</span><span class="n">pg</span><span class="o">-</span><span class="n">pe</span><span class="p">)</span> <span class="o">/</span> <span class="n">TBK</span><span class="p">;</span> <span class="n">xne</span> <span class="o">=</span> <span class="n">pe</span> <span class="o">/</span> <span class="n">TBK</span>
        <span class="n">n_tot</span> <span class="o">=</span> <span class="n">xna</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ABUND</span><span class="p">[</span><span class="n">iatom</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">abtot</span>



        <span class="c1"># Partition function</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">partition_f</span><span class="p">(</span><span class="n">iatom</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">only</span><span class="o">=</span><span class="n">only</span><span class="p">)</span>
        <span class="n">nLev</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">size</span>


        <span class="c1"># Solve saha and get the partial density of each ionized stage</span>

        <span class="n">xpa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nLev</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
        <span class="n">xpa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nLev</span><span class="p">):</span>
            <span class="n">xpa</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsaha</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">xne</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">el</span><span class="p">[</span><span class="n">iatom</span><span class="p">]</span><span class="o">.</span><span class="n">eion</span><span class="p">[</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nLev</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">xpa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">xpa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">xpa</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>

        <span class="n">xpa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">xpa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nLev</span><span class="p">):</span>
            <span class="n">xpa</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*=</span> <span class="n">xpa</span><span class="p">[</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


        <span class="c1"># Now that we have the ratios between ionized stages, multiply by the partial</span>
        <span class="c1"># density of iatom. Divide by the partition function if needed</span>

        <span class="k">if</span><span class="p">(</span><span class="n">divide_by_u</span><span class="p">):</span>
            <span class="n">xpa</span><span class="p">[:]</span> <span class="o">*=</span> <span class="n">n_tot</span> <span class="o">/</span> <span class="n">u</span><span class="p">[:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xpa</span> <span class="o">*=</span> <span class="n">n_tot</span>

        <span class="k">if</span><span class="p">(</span><span class="n">return_u</span><span class="p">):</span> <span class="k">return</span> <span class="n">xpa</span><span class="p">,</span> <span class="n">u</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">xpa</span>

    <span class="c1"># ----------------------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">getBackgroundPartials</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">pg</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">divide_by_u</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>

        <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
        <span class="n">tbk</span> <span class="o">=</span> <span class="n">t</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">BK</span>

        <span class="c1"># --- He/He+/He++ ---</span>

        <span class="n">xpa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getXparts</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">pg</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">divide_by_u</span> <span class="o">=</span> <span class="n">divide_by_u</span><span class="p">)</span>
        <span class="n">n</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">xpa</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">n</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">xpa</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">n</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">xpa</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># --- C ---</span>

        <span class="n">xpa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getXparts</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">pg</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">divide_by_u</span> <span class="o">=</span> <span class="n">divide_by_u</span><span class="p">)</span>
        <span class="n">n</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">xpa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


        <span class="c1"># --- Al ---</span>

        <span class="n">xpa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getXparts</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">pg</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">divide_by_u</span> <span class="o">=</span> <span class="n">divide_by_u</span><span class="p">)</span>
        <span class="n">n</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">xpa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


        <span class="c1"># --- Si/Si+ ---</span>

        <span class="n">xpa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getXparts</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">pg</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">divide_by_u</span> <span class="o">=</span> <span class="n">divide_by_u</span><span class="p">)</span>
        <span class="n">n</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">xpa</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">n</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">xpa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>


        <span class="c1"># --- Ca/Ca+ ---</span>

        <span class="n">xpa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getXparts</span><span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">pg</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">divide_by_u</span> <span class="o">=</span> <span class="n">divide_by_u</span><span class="p">)</span>
        <span class="n">n</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">xpa</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">n</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">xpa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>


        <span class="c1"># --- Mg/Mg+ ---</span>

        <span class="n">xpa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getXparts</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">pg</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">divide_by_u</span> <span class="o">=</span> <span class="n">divide_by_u</span><span class="p">)</span>
        <span class="n">n</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">xpa</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">n</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">xpa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>


        <span class="c1"># --- Fe ---</span>

        <span class="n">xpa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getXparts</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">pg</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">divide_by_u</span> <span class="o">=</span> <span class="n">divide_by_u</span><span class="p">)</span>
        <span class="n">n</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">xpa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


        <span class="c1"># --- N ---</span>

        <span class="n">xpa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getXparts</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">pg</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">divide_by_u</span> <span class="o">=</span> <span class="n">divide_by_u</span><span class="p">)</span>
        <span class="n">n</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">xpa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


        <span class="c1"># --- O ---</span>

        <span class="n">xpa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getXparts</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">pg</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">divide_by_u</span> <span class="o">=</span> <span class="n">divide_by_u</span><span class="p">)</span>
        <span class="n">n</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">xpa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


        <span class="c1"># Get H- and other H densities</span>

        <span class="k">if</span><span class="p">(</span><span class="n">divide_by_u</span><span class="p">):</span> <span class="n">pfH</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">pfH</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="n">dum</span><span class="p">,</span> <span class="n">pp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gasc</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">pe</span><span class="p">)</span>
        <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ncontr</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">pp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ncontr</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span> <span class="o">/</span> <span class="n">tbk</span> <span class="o">*</span> <span class="n">pfH</span> <span class="c1"># H / pf[H]</span>
        <span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ncontr</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">pp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ncontr</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span> <span class="o">/</span> <span class="n">tbk</span>       <span class="c1"># H+/ 1.0</span>
        <span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ncontr</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">pp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ncontr</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span> <span class="o">/</span> <span class="n">tbk</span>       <span class="c1"># H-/ 1.0</span>


        <span class="k">return</span> <span class="n">n</span>

    <span class="c1"># ----------------------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">contOpacity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iT</span><span class="p">,</span> <span class="n">Pgas</span><span class="p">,</span> <span class="n">Pe</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>

        <span class="c1"># Some definitions</span>

        <span class="n">TK</span> <span class="o">=</span> <span class="n">iT</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">BK</span><span class="p">;</span> <span class="n">TKEV</span> <span class="o">=</span> <span class="n">TK</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">EV</span>
        <span class="n">HTK</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HH</span><span class="o">/</span><span class="n">TK</span><span class="p">;</span> <span class="n">TLOG</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="n">iT</span><span class="p">);</span>
        <span class="n">xna</span> <span class="o">=</span> <span class="p">(</span><span class="n">Pgas</span><span class="o">-</span><span class="n">Pe</span><span class="p">)</span> <span class="o">/</span> <span class="n">TK</span><span class="p">;</span> <span class="n">xne</span> <span class="o">=</span> <span class="n">Pe</span> <span class="o">/</span> <span class="n">TK</span>


        <span class="c1"># Partial densities of background absorvers,</span>
        <span class="c1"># divided by the partition functions</span>

        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBackgroundPartials</span><span class="p">(</span><span class="n">iT</span><span class="p">,</span> <span class="n">Pgas</span><span class="p">,</span> <span class="n">Pe</span><span class="p">,</span> <span class="n">divide_by_u</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>


        <span class="c1"># get background opacity</span>

        <span class="n">opac</span><span class="p">,</span> <span class="n">scat</span> <span class="o">=</span> <span class="n">cop</span><span class="p">(</span><span class="n">iT</span><span class="p">,</span>  <span class="n">TKEV</span><span class="p">,</span> <span class="n">TK</span><span class="p">,</span> <span class="n">HTK</span><span class="p">,</span> <span class="n">TLOG</span><span class="p">,</span> <span class="n">xna</span><span class="p">,</span> <span class="n">xne</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                              <span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">n</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span>
                              <span class="n">n</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">15</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">opac</span></div>




<span class="c1"># ----------------------------------------------------------------------------------------</span>
<span class="c1">#</span>
<span class="c1"># All the following functions are used to compute background opacities.</span>
<span class="c1"># The main call is done to function &quot;cop&quot;, that calls all the other auxiliary</span>
<span class="c1"># functions.</span>
<span class="c1">#</span>
<span class="c1"># ----------------------------------------------------------------------------------------</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">SEATON</span><span class="p">(</span><span class="n">FREQ0</span><span class="p">,</span> <span class="n">XSECT</span><span class="p">,</span> <span class="n">POWER</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">FREQ</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">XSECT</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="o">+</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">A</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">FREQ0</span><span class="o">/</span><span class="n">FREQ</span><span class="p">))</span><span class="o">*</span> <span class="p">(</span><span class="n">FREQ0</span><span class="o">/</span><span class="n">FREQ</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">POWER</span><span class="o">+</span><span class="mf">0.01</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="p">)</span>

<span class="c1"># ----------------------------------------------------------------------------------------</span>

<span class="n">Z4LOG</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">((</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.20412</span><span class="p">,</span><span class="mf">1.90849</span><span class="p">,</span><span class="mf">2.40824</span><span class="p">,</span><span class="mf">2.79588</span><span class="p">,</span><span class="mf">3.11261</span><span class="p">))</span>
<span class="n">A0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">((</span>
    <span class="mf">5.53</span><span class="p">,</span><span class="mf">5.49</span><span class="p">,</span><span class="mf">5.46</span><span class="p">,</span><span class="mf">5.43</span><span class="p">,</span><span class="mf">5.40</span><span class="p">,</span><span class="mf">5.25</span><span class="p">,</span><span class="mf">5.00</span><span class="p">,</span><span class="mf">4.69</span><span class="p">,</span><span class="mf">4.48</span><span class="p">,</span><span class="mf">4.16</span><span class="p">,</span><span class="mf">3.85</span><span class="p">,</span>
    <span class="mf">4.91</span><span class="p">,</span><span class="mf">4.87</span><span class="p">,</span><span class="mf">4.84</span><span class="p">,</span><span class="mf">4.80</span><span class="p">,</span><span class="mf">4.77</span><span class="p">,</span><span class="mf">4.63</span><span class="p">,</span><span class="mf">4.40</span><span class="p">,</span><span class="mf">4.13</span><span class="p">,</span><span class="mf">3.87</span><span class="p">,</span><span class="mf">3.52</span><span class="p">,</span><span class="mf">3.27</span><span class="p">,</span>
    <span class="mf">4.29</span><span class="p">,</span><span class="mf">4.25</span><span class="p">,</span><span class="mf">4.22</span><span class="p">,</span><span class="mf">4.18</span><span class="p">,</span><span class="mf">4.15</span><span class="p">,</span><span class="mf">4.02</span><span class="p">,</span><span class="mf">3.80</span><span class="p">,</span><span class="mf">3.57</span><span class="p">,</span><span class="mf">3.27</span><span class="p">,</span><span class="mf">2.98</span><span class="p">,</span><span class="mf">2.70</span><span class="p">,</span>
    <span class="mf">3.64</span><span class="p">,</span><span class="mf">3.61</span><span class="p">,</span><span class="mf">3.59</span><span class="p">,</span><span class="mf">3.56</span><span class="p">,</span><span class="mf">3.54</span><span class="p">,</span><span class="mf">3.41</span><span class="p">,</span><span class="mf">3.22</span><span class="p">,</span><span class="mf">2.97</span><span class="p">,</span><span class="mf">2.70</span><span class="p">,</span><span class="mf">2.45</span><span class="p">,</span><span class="mf">2.20</span><span class="p">,</span>
    <span class="mf">3.00</span><span class="p">,</span><span class="mf">2.98</span><span class="p">,</span><span class="mf">2.97</span><span class="p">,</span><span class="mf">2.95</span><span class="p">,</span><span class="mf">2.94</span><span class="p">,</span><span class="mf">2.81</span><span class="p">,</span><span class="mf">2.65</span><span class="p">,</span><span class="mf">2.44</span><span class="p">,</span><span class="mf">2.21</span><span class="p">,</span><span class="mf">2.01</span><span class="p">,</span><span class="mf">1.81</span><span class="p">,</span>
    <span class="mf">2.41</span><span class="p">,</span><span class="mf">2.41</span><span class="p">,</span><span class="mf">2.41</span><span class="p">,</span><span class="mf">2.41</span><span class="p">,</span><span class="mf">2.41</span><span class="p">,</span><span class="mf">2.32</span><span class="p">,</span><span class="mf">2.19</span><span class="p">,</span><span class="mf">2.02</span><span class="p">,</span><span class="mf">1.84</span><span class="p">,</span><span class="mf">1.67</span><span class="p">,</span><span class="mf">1.50</span><span class="p">,</span>
    <span class="mf">1.87</span><span class="p">,</span><span class="mf">1.89</span><span class="p">,</span><span class="mf">1.91</span><span class="p">,</span><span class="mf">1.93</span><span class="p">,</span><span class="mf">1.95</span><span class="p">,</span><span class="mf">1.90</span><span class="p">,</span><span class="mf">1.80</span><span class="p">,</span><span class="mf">1.68</span><span class="p">,</span><span class="mf">1.52</span><span class="p">,</span><span class="mf">1.41</span><span class="p">,</span><span class="mf">1.30</span><span class="p">,</span>
    <span class="mf">1.33</span><span class="p">,</span><span class="mf">1.39</span><span class="p">,</span><span class="mf">1.44</span><span class="p">,</span><span class="mf">1.49</span><span class="p">,</span><span class="mf">1.55</span><span class="p">,</span><span class="mf">1.56</span><span class="p">,</span><span class="mf">1.51</span><span class="p">,</span><span class="mf">1.42</span><span class="p">,</span><span class="mf">1.33</span><span class="p">,</span><span class="mf">1.25</span><span class="p">,</span><span class="mf">1.17</span><span class="p">,</span>
    <span class="mf">0.90</span><span class="p">,</span><span class="mf">0.95</span><span class="p">,</span><span class="mf">1.00</span><span class="p">,</span><span class="mf">1.08</span><span class="p">,</span><span class="mf">1.17</span><span class="p">,</span><span class="mf">1.30</span><span class="p">,</span><span class="mf">1.32</span><span class="p">,</span><span class="mf">1.30</span><span class="p">,</span><span class="mf">1.20</span><span class="p">,</span><span class="mf">1.15</span><span class="p">,</span><span class="mf">1.11</span><span class="p">,</span>
    <span class="mf">0.55</span><span class="p">,</span><span class="mf">0.58</span><span class="p">,</span><span class="mf">0.62</span><span class="p">,</span><span class="mf">0.70</span><span class="p">,</span><span class="mf">0.85</span><span class="p">,</span><span class="mf">1.01</span><span class="p">,</span><span class="mf">1.15</span><span class="p">,</span><span class="mf">1.18</span><span class="p">,</span><span class="mf">1.15</span><span class="p">,</span><span class="mf">1.11</span><span class="p">,</span><span class="mf">1.08</span><span class="p">,</span>
    <span class="mf">0.33</span><span class="p">,</span><span class="mf">0.36</span><span class="p">,</span><span class="mf">0.39</span><span class="p">,</span><span class="mf">0.46</span><span class="p">,</span><span class="mf">0.59</span><span class="p">,</span><span class="mf">0.76</span><span class="p">,</span><span class="mf">0.97</span><span class="p">,</span><span class="mf">1.09</span><span class="p">,</span><span class="mf">1.13</span><span class="p">,</span><span class="mf">1.10</span><span class="p">,</span><span class="mf">1.08</span><span class="p">,</span>
    <span class="mf">0.19</span><span class="p">,</span><span class="mf">0.21</span><span class="p">,</span><span class="mf">0.24</span><span class="p">,</span><span class="mf">0.28</span><span class="p">,</span><span class="mf">0.38</span><span class="p">,</span><span class="mf">0.53</span><span class="p">,</span><span class="mf">0.76</span><span class="p">,</span><span class="mf">0.96</span><span class="p">,</span><span class="mf">1.08</span><span class="p">,</span><span class="mf">1.09</span><span class="p">,</span><span class="mf">1.09</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">12</span><span class="p">,</span><span class="mi">11</span><span class="p">))</span>


<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">COULFF</span><span class="p">(</span><span class="n">TLOG</span><span class="p">,</span> <span class="n">FREQLG</span><span class="p">,</span> <span class="n">NZ</span><span class="p">):</span>
    <span class="n">GAMLOG</span><span class="o">=</span><span class="mf">10.39638</span><span class="o">-</span><span class="n">TLOG</span><span class="o">/</span><span class="mf">1.15129</span><span class="o">+</span><span class="n">Z4LOG</span><span class="p">[</span><span class="n">NZ</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">IGAM</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">GAMLOG</span><span class="o">+</span><span class="mf">7.</span><span class="p">),</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">IGAM</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">):</span> <span class="n">IGAM</span><span class="o">=</span><span class="mi">1</span>

    <span class="c1">#  HVKTLG=2*log10(HVKT) #</span>

    <span class="n">HVKTLG</span><span class="o">=</span><span class="p">(</span><span class="n">FREQLG</span><span class="o">-</span><span class="n">TLOG</span><span class="p">)</span><span class="o">/</span><span class="mf">1.15129</span><span class="o">-</span><span class="mf">20.63764</span>
    <span class="n">IHVKT</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">HVKTLG</span><span class="o">+</span><span class="mf">9.</span><span class="p">),</span><span class="mi">11</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">IHVKT</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">):</span> <span class="n">IHVKT</span><span class="o">=</span><span class="mi">1</span>

    <span class="n">P</span><span class="o">=</span><span class="n">GAMLOG</span><span class="o">-</span><span class="p">(</span><span class="n">IGAM</span><span class="o">-</span><span class="mi">7</span><span class="p">);</span>
    <span class="n">Q</span><span class="o">=</span><span class="n">HVKTLG</span><span class="o">-</span><span class="p">(</span><span class="n">IHVKT</span><span class="o">-</span><span class="mi">9</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">P</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="mf">1.</span><span class="o">-</span><span class="n">Q</span><span class="p">)</span><span class="o">*</span><span class="n">A0</span><span class="p">[</span><span class="n">IHVKT</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">IGAM</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">Q</span><span class="o">*</span><span class="n">A0</span><span class="p">[</span><span class="n">IHVKT</span><span class="p">,</span> <span class="n">IGAM</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="n">P</span><span class="o">*</span><span class="p">((</span><span class="mf">1.</span><span class="o">-</span><span class="n">Q</span><span class="p">)</span><span class="o">*</span><span class="n">A0</span><span class="p">[</span><span class="n">IHVKT</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">IGAM</span><span class="p">]</span><span class="o">+</span><span class="n">Q</span><span class="o">*</span><span class="n">A0</span><span class="p">[</span><span class="n">IHVKT</span><span class="p">,</span><span class="n">IGAM</span><span class="p">])</span>


<span class="c1"># ----------------------------------------------------------------------------------------</span>

<span class="n">A1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">((</span><span class="mf">0.9916</span><span class="p">,</span><span class="mf">1.105</span><span class="p">,</span><span class="mf">1.101</span><span class="p">,</span><span class="mf">1.101</span><span class="p">,</span><span class="mf">1.102</span><span class="p">,</span><span class="mf">1.0986</span><span class="p">))</span>
<span class="n">B1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">((</span><span class="mf">2.719e3</span><span class="p">,</span><span class="o">-</span><span class="mf">2.375e4</span><span class="p">,</span><span class="o">-</span><span class="mf">9.863e3</span><span class="p">,</span><span class="o">-</span><span class="mf">5.765e3</span><span class="p">,</span><span class="o">-</span><span class="mf">3.909e3</span><span class="p">,</span><span class="o">-</span><span class="mf">2.704e3</span><span class="p">))</span>
<span class="n">C1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">((</span><span class="o">-</span><span class="mf">2.268e10</span><span class="p">,</span><span class="mf">4.077e8</span><span class="p">,</span><span class="mf">1.035e8</span><span class="p">,</span><span class="mf">4.593e7</span><span class="p">,</span><span class="mf">2.371e7</span><span class="p">,</span><span class="mf">1.229e7</span><span class="p">))</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">COULX</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">Z</span><span class="p">):</span>
    <span class="n">n</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mf">1.0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">if</span><span class="p">(</span><span class="n">freq</span><span class="o">&gt;=</span><span class="p">(</span><span class="n">Z</span><span class="o">*</span><span class="n">Z</span><span class="o">*</span><span class="mf">3.28805e15</span><span class="o">/</span><span class="n">n</span><span class="p">)):</span>
        <span class="n">FREQ1</span><span class="o">=</span><span class="n">freq</span><span class="o">*</span><span class="mf">1.e-10</span>
        <span class="n">CLX</span><span class="o">=</span><span class="mf">0.2815</span><span class="o">/</span><span class="n">FREQ1</span><span class="o">/</span><span class="n">FREQ1</span><span class="o">/</span><span class="n">FREQ1</span><span class="o">/</span><span class="n">n</span><span class="o">/</span><span class="n">n</span><span class="o">/</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mf">1.0</span><span class="p">)</span><span class="o">*</span><span class="n">Z</span><span class="o">*</span><span class="n">Z</span><span class="o">*</span><span class="n">Z</span><span class="o">*</span><span class="n">Z</span>

        <span class="k">if</span><span class="p">(</span><span class="n">N</span><span class="o">&gt;=</span><span class="mi">6</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">CLX</span>

        <span class="n">CLX</span><span class="o">*=</span><span class="p">(</span><span class="n">A1</span><span class="p">[</span><span class="n">N</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">B1</span><span class="p">[</span><span class="n">N</span><span class="p">]</span><span class="o">+</span><span class="n">C1</span><span class="p">[</span><span class="n">N</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">Z</span><span class="o">*</span><span class="n">Z</span><span class="o">/</span><span class="n">FREQ1</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">Z</span><span class="o">*</span><span class="n">Z</span><span class="o">/</span><span class="n">FREQ1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">CLX</span>

    <span class="k">return</span> <span class="mf">0.0</span>

<span class="c1"># ----------------------------------------------------------------------------------------</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">HOP</span><span class="p">(</span> <span class="n">XNE</span><span class="p">,</span>  <span class="n">XH1</span><span class="p">,</span>  <span class="n">XH2</span><span class="p">,</span>  <span class="n">FREQ</span><span class="p">,</span>  <span class="n">FREQLG</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span>  <span class="n">TLOG</span><span class="p">,</span>  <span class="n">TKEV</span><span class="p">,</span>  <span class="n">STIM</span><span class="p">,</span>  <span class="n">EHVKT</span><span class="p">):</span>

    <span class="n">CONT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">BOLT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>

    <span class="n">FREQ3</span><span class="o">=</span><span class="p">(</span><span class="n">FREQ</span><span class="o">*</span><span class="mf">1.E-10</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span>
    <span class="n">CFREE</span><span class="o">=</span><span class="mf">3.6919E-22</span><span class="o">/</span><span class="n">FREQ3</span>

    <span class="n">n1</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="mf">1.0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">BOLT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">13.595</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="n">n1</span><span class="p">)</span><span class="o">/</span><span class="n">TKEV</span><span class="p">)</span><span class="o">*</span><span class="mf">2.</span><span class="o">*</span><span class="n">n1</span><span class="o">*</span><span class="n">XH1</span>


    <span class="n">FREET</span><span class="o">=</span><span class="n">XNE</span><span class="o">*</span><span class="n">CFREE</span><span class="o">*</span><span class="n">XH2</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
    <span class="n">XR</span><span class="o">=</span><span class="n">XH1</span><span class="o">/</span><span class="mf">13.595</span><span class="o">*</span><span class="n">TKEV</span>
    <span class="n">BOLTEX</span><span class="o">=</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">13.427</span><span class="o">/</span><span class="n">TKEV</span><span class="p">)</span><span class="o">*</span><span class="n">XR</span>
    <span class="n">EXLIM</span><span class="o">=</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">13.595</span><span class="o">/</span><span class="n">TKEV</span><span class="p">)</span><span class="o">*</span><span class="n">XR</span>

    <span class="k">for</span> <span class="n">N</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">CONT</span><span class="p">[</span><span class="n">N</span><span class="p">]</span><span class="o">=</span><span class="n">COULX</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">FREQ</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="n">C</span><span class="o">=</span><span class="mf">0.2815</span><span class="o">/</span><span class="n">FREQ3</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">FREQ</span> <span class="o">&lt;</span> <span class="mf">4.05933E13</span><span class="p">):</span>
        <span class="n">BOLTEX</span><span class="o">=</span><span class="n">EXLIM</span><span class="o">/</span><span class="n">EHVKT</span>
    <span class="n">H</span><span class="o">=</span><span class="p">(</span><span class="n">CONT</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">BOLT</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="n">CONT</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="n">BOLT</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">BOLTEX</span><span class="o">-</span><span class="n">EXLIM</span><span class="p">)</span><span class="o">*</span><span class="n">C</span><span class="o">+</span>
       <span class="n">COULFF</span><span class="p">(</span><span class="n">TLOG</span><span class="p">,</span><span class="n">FREQLG</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">FREET</span><span class="p">)</span><span class="o">*</span><span class="n">STIM</span>


    <span class="n">H</span> <span class="o">+=</span> <span class="p">(</span><span class="n">CONT</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">BOLT</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">EHVKT</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">H</span>

<span class="c1"># ----------------------------------------------------------------------------------------</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">HRAYOP</span><span class="p">(</span><span class="n">XH1</span><span class="p">,</span>  <span class="n">FREQ</span><span class="p">):</span>

    <span class="n">WAVE</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">FREQ</span><span class="p">,</span><span class="mf">2.463e15</span><span class="p">)</span>
    <span class="n">WAVE</span><span class="o">=</span><span class="mf">2.997925e18</span><span class="o">/</span><span class="n">WAVE</span>
    <span class="n">WW</span><span class="o">=</span><span class="n">WAVE</span><span class="o">*</span><span class="n">WAVE</span>
    <span class="n">WW2</span> <span class="o">=</span> <span class="n">WW</span><span class="o">*</span><span class="n">WW</span>
    <span class="n">SIG</span><span class="o">=</span><span class="p">(</span><span class="mf">5.799e-13</span><span class="o">+</span><span class="mf">1.422e-6</span><span class="o">/</span><span class="n">WW</span><span class="o">+</span><span class="mf">2.784</span><span class="o">/</span><span class="p">(</span><span class="n">WW2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">WW2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">SIG</span><span class="o">*</span><span class="n">XH1</span><span class="o">*</span><span class="mf">2.0</span>

<span class="c1"># ----------------------------------------------------------------------------------------</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">H2PLOP</span><span class="p">(</span><span class="n">XH1</span><span class="p">,</span> <span class="n">XH2</span><span class="p">,</span> <span class="n">FREQ</span><span class="p">,</span> <span class="n">FREQLG</span><span class="p">,</span> <span class="n">FREQ15</span><span class="p">,</span> <span class="n">TKEV</span><span class="p">,</span> <span class="n">STIM</span><span class="p">):</span>

  <span class="k">if</span><span class="p">(</span><span class="n">FREQ</span> <span class="o">&gt;</span> <span class="mf">3.28805E15</span><span class="p">):</span>
      <span class="k">return</span> <span class="mf">0.0</span>

  <span class="n">FR</span><span class="o">=-</span><span class="mf">3.0233E3</span><span class="o">+</span><span class="p">(</span><span class="mf">3.7797E2</span><span class="o">+</span><span class="p">(</span><span class="o">-</span><span class="mf">1.82496E1</span><span class="o">+</span><span class="p">(</span><span class="mf">3.9207E-1</span><span class="o">-</span><span class="mf">3.1672E-3</span><span class="o">*</span><span class="n">FREQLG</span><span class="p">)</span><span class="o">*</span>
			  <span class="n">FREQLG</span><span class="p">)</span><span class="o">*</span><span class="n">FREQLG</span><span class="p">)</span><span class="o">*</span><span class="n">FREQLG</span>
  <span class="n">ES</span><span class="o">=-</span><span class="mf">7.342E-3</span><span class="o">+</span><span class="p">(</span><span class="o">-</span><span class="mf">2.409</span><span class="o">+</span><span class="p">(</span><span class="mf">1.028</span><span class="o">+</span><span class="p">(</span><span class="o">-</span><span class="mf">0.4230</span><span class="o">+</span><span class="p">(</span><span class="mf">0.1224</span><span class="o">-</span><span class="mf">0.01351</span><span class="o">*</span><span class="n">FREQ15</span><span class="p">)</span><span class="o">*</span>
			       <span class="n">FREQ15</span><span class="p">)</span><span class="o">*</span><span class="n">FREQ15</span><span class="p">)</span><span class="o">*</span><span class="n">FREQ15</span><span class="p">)</span><span class="o">*</span><span class="n">FREQ15</span>
  <span class="k">return</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">ES</span><span class="o">/</span><span class="n">TKEV</span><span class="o">+</span><span class="n">FR</span><span class="p">)</span><span class="o">*</span><span class="mf">2.</span><span class="o">*</span><span class="n">XH1</span><span class="o">*</span><span class="n">XH2</span><span class="o">*</span><span class="n">STIM</span>


<span class="c1"># ----------------------------------------------------------------------------------------</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">HMINOP</span><span class="p">(</span> <span class="n">XH1</span><span class="p">,</span>  <span class="n">XHMIN</span><span class="p">,</span>  <span class="n">FREQ</span><span class="p">,</span>  <span class="n">T</span><span class="p">,</span> <span class="n">TKEV</span><span class="p">,</span>  <span class="n">XNE</span><span class="p">,</span>  <span class="n">EHVKT</span><span class="p">):</span>

    <span class="n">FREQ1</span><span class="o">=</span><span class="n">FREQ</span><span class="o">*</span><span class="mf">1.E-10</span>
    <span class="n">B</span><span class="o">=</span><span class="p">(</span><span class="mf">1.3727E-15</span><span class="o">+</span><span class="mf">4.3748</span><span class="o">/</span><span class="n">FREQ</span><span class="p">)</span><span class="o">/</span><span class="n">FREQ1</span>
    <span class="n">C</span><span class="o">=-</span><span class="mf">2.5993E-7</span><span class="o">/</span><span class="n">FREQ1</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">if</span><span class="p">(</span><span class="n">FREQ</span> <span class="o">&lt;=</span> <span class="mf">1.8259E14</span><span class="p">):</span> <span class="n">HMINBF</span><span class="o">=</span><span class="mf">0.</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">FREQ</span> <span class="o">&gt;=</span> <span class="mf">2.111E14</span><span class="p">):</span> <span class="n">HMINBF</span><span class="o">=</span><span class="mf">6.801E-10</span><span class="o">+</span><span class="p">(</span><span class="mf">5.358E-3</span><span class="o">+</span><span class="p">(</span><span class="mf">1.481E3</span><span class="o">+</span><span class="p">(</span><span class="o">-</span><span class="mf">5.519E7</span><span class="o">+</span><span class="mf">4.808E11</span><span class="o">/</span><span class="n">FREQ1</span><span class="p">)</span><span class="o">/</span><span class="n">FREQ1</span><span class="p">)</span><span class="o">/</span><span class="n">FREQ1</span><span class="p">)</span><span class="o">/</span><span class="n">FREQ1</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">HMINBF</span><span class="o">=</span><span class="mf">3.695E-6</span><span class="o">+</span><span class="p">(</span><span class="o">-</span><span class="mf">1.251E-1</span><span class="o">+</span><span class="mf">1.052E3</span><span class="o">/</span><span class="n">FREQ1</span><span class="p">)</span><span class="o">/</span><span class="n">FREQ1</span>

    <span class="n">HMINFF</span><span class="o">=</span><span class="p">(</span><span class="n">B</span><span class="o">+</span><span class="n">C</span><span class="o">/</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">XH1</span><span class="o">*</span><span class="n">XNE</span><span class="o">*</span><span class="mf">2.E-20</span>


    <span class="c1">#</span>
    <span class="c1"># We use the number density / partition function for H-.</span>
    <span class="c1"># The partition function for H- is 1</span>
    <span class="c1">#</span>
    <span class="k">if</span><span class="p">(</span><span class="n">T</span> <span class="o">&lt;</span> <span class="mf">7730.</span><span class="p">):</span> <span class="n">HMIN</span><span class="o">=</span><span class="n">XHMIN</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">HMIN</span><span class="o">=</span><span class="n">exp</span><span class="p">(</span><span class="mf">0.7552</span><span class="o">/</span><span class="n">TKEV</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="mf">2.4148E15</span><span class="o">*</span><span class="n">T</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">))</span><span class="o">*</span><span class="n">XH1</span><span class="o">*</span><span class="n">XNE</span>

    <span class="n">H</span><span class="o">=</span><span class="n">HMINBF</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">EHVKT</span><span class="p">)</span><span class="o">*</span><span class="n">HMIN</span><span class="o">*</span><span class="mf">1.E-10</span>
    <span class="k">return</span> <span class="n">H</span><span class="o">+</span><span class="n">HMINFF</span>

<span class="c1"># ----------------------------------------------------------------------------------------</span>

<span class="n">G0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">((</span><span class="mf">1.</span><span class="p">,</span><span class="mf">3.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="mf">9.</span><span class="p">,</span><span class="mf">3.</span><span class="p">,</span><span class="mf">3.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="mf">9.</span><span class="p">,</span><span class="mf">20.</span><span class="p">,</span><span class="mf">3.</span><span class="p">))</span>
<span class="n">HEFREQ0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">((</span><span class="mf">5.9452090e15</span><span class="p">,</span><span class="mf">1.1528440e15</span><span class="p">,</span><span class="mf">0.9803331e15</span><span class="p">,</span><span class="mf">.8761076e15</span><span class="p">,</span>
		      <span class="mf">0.8147100e15</span><span class="p">,</span><span class="mf">0.4519048e15</span><span class="p">,</span><span class="mf">0.4030971e15</span><span class="p">,</span><span class="mf">.8321191e15</span><span class="p">,</span>
		      <span class="mf">0.3660215e15</span><span class="p">,</span><span class="mf">0.3627891e15</span><span class="p">))</span>
<span class="n">CHI0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">((</span><span class="mf">0.</span><span class="p">,</span><span class="mf">19.819</span><span class="p">,</span><span class="mf">20.615</span><span class="p">,</span><span class="mf">20.964</span><span class="p">,</span><span class="mf">21.217</span><span class="p">,</span><span class="mf">22.718</span><span class="p">,</span><span class="mf">22.920</span><span class="p">,</span><span class="mf">23.006</span><span class="p">,</span>
		   <span class="mf">23.073</span><span class="p">,</span><span class="mf">23.086</span><span class="p">))</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">HE1OP</span><span class="p">(</span> <span class="n">XHE1</span><span class="p">,</span>  <span class="n">XHE2</span><span class="p">,</span>  <span class="n">XNE</span><span class="p">,</span>  <span class="n">FREQ</span><span class="p">,</span>  <span class="n">FREQLG</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span>  <span class="n">TKEV</span><span class="p">,</span>  <span class="n">TLOG</span><span class="p">,</span>  <span class="n">EHVKT</span><span class="p">,</span>  <span class="n">STIM</span><span class="p">):</span>

    <span class="n">TRANS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">BOLT</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">CHI0</span><span class="o">/</span><span class="n">TKEV</span><span class="p">)</span><span class="o">*</span><span class="n">G0</span><span class="o">*</span><span class="n">XHE1</span>

    <span class="n">FREET</span><span class="o">=</span><span class="n">XNE</span><span class="o">*</span><span class="mf">1.E-10</span><span class="o">*</span><span class="n">XHE2</span><span class="o">*</span><span class="mf">1.E-10</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="mf">1.E-10</span>
    <span class="n">XRLOG</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">XHE1</span><span class="o">*</span><span class="p">(</span><span class="mf">2.</span><span class="o">/</span><span class="mf">13.595</span><span class="p">)</span><span class="o">*</span><span class="n">TKEV</span><span class="p">)</span>
    <span class="n">BOLTEX</span><span class="o">=</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">23.730</span><span class="o">/</span><span class="n">TKEV</span><span class="o">+</span><span class="n">XRLOG</span><span class="p">)</span>
    <span class="n">EXLIM</span><span class="o">=</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">24.587</span><span class="o">/</span><span class="n">TKEV</span><span class="o">+</span><span class="n">XRLOG</span><span class="p">)</span>
    <span class="n">FREQ3</span><span class="o">=</span><span class="p">(</span><span class="n">FREQ</span><span class="o">*</span><span class="mf">1.E-10</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span>
    <span class="n">CFREE</span><span class="o">=</span><span class="mf">3.6919E8</span><span class="o">/</span><span class="n">FREQ3</span>
    <span class="n">C</span><span class="o">=</span><span class="mf">2.815E-1</span><span class="o">/</span><span class="n">FREQ3</span>

    <span class="k">for</span> <span class="n">NMIN</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="n">HEFREQ0</span><span class="p">[</span><span class="n">NMIN</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">FREQ</span><span class="p">):</span> <span class="k">break</span>

    <span class="n">dum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">((</span><span class="mf">33.32</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">FREQLG</span><span class="p">,</span> <span class="o">-</span><span class="mf">390.026</span><span class="o">+</span><span class="p">(</span><span class="mf">21.035</span><span class="o">-</span><span class="mf">0.318</span><span class="o">*</span><span class="n">FREQLG</span><span class="p">)</span><span class="o">*</span><span class="n">FREQLG</span><span class="p">,</span> <span class="mf">26.83</span><span class="o">-</span><span class="mf">1.91</span><span class="o">*</span><span class="n">FREQLG</span><span class="p">,</span> <span class="mf">61.21</span><span class="o">-</span><span class="mf">2.9</span><span class="o">*</span><span class="n">FREQLG</span><span class="p">,</span> <span class="mf">81.35</span><span class="o">-</span><span class="mf">3.5</span><span class="o">*</span><span class="n">FREQLG</span><span class="p">,</span> <span class="mf">12.69</span><span class="o">-</span><span class="mf">1.54</span><span class="o">*</span><span class="n">FREQLG</span><span class="p">,</span> <span class="mf">23.85</span><span class="o">-</span><span class="mf">1.86</span><span class="o">*</span><span class="n">FREQLG</span><span class="p">,</span> <span class="mf">49.30</span><span class="o">-</span><span class="mf">2.60</span><span class="o">*</span><span class="n">FREQLG</span><span class="p">,</span><span class="mf">85.20</span><span class="o">-</span><span class="mf">3.69</span><span class="o">*</span><span class="n">FREQLG</span><span class="p">,</span> <span class="mf">58.81</span><span class="o">-</span><span class="mf">2.89</span><span class="o">*</span><span class="n">FREQLG</span> <span class="p">))</span>

    <span class="n">TRANS</span><span class="p">[</span><span class="n">NMIN</span><span class="p">::]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">dum</span><span class="p">[</span><span class="n">NMIN</span><span class="p">::])</span>


    <span class="n">EX</span> <span class="o">=</span> <span class="n">BOLTEX</span>
    <span class="k">if</span><span class="p">(</span><span class="n">FREQ</span> <span class="o">&lt;</span> <span class="mf">2.055E14</span><span class="p">):</span> <span class="n">EX</span><span class="o">=</span><span class="n">EXLIM</span><span class="o">/</span><span class="n">EHVKT</span>

    <span class="n">HE1</span><span class="o">=</span><span class="p">(</span><span class="n">EX</span><span class="o">-</span><span class="n">EXLIM</span><span class="p">)</span><span class="o">*</span><span class="n">C</span><span class="p">;</span>
    <span class="n">HE1</span> <span class="o">+=</span> <span class="p">(</span><span class="n">TRANS</span><span class="o">*</span><span class="n">BOLT</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">HE1</span><span class="o">+</span><span class="n">COULFF</span><span class="p">(</span><span class="n">TLOG</span><span class="p">,</span><span class="n">FREQLG</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">FREET</span><span class="o">*</span><span class="n">CFREE</span><span class="p">)</span><span class="o">*</span><span class="n">STIM</span>

<span class="c1"># ----------------------------------------------------------------------------------------</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">HE2OP</span><span class="p">(</span>  <span class="n">XHE2</span><span class="p">,</span>  <span class="n">XHE3</span><span class="p">,</span>  <span class="n">XNE</span><span class="p">,</span>  <span class="n">FREQ</span><span class="p">,</span>  <span class="n">FREQLG</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span>  <span class="n">TKEV</span><span class="p">,</span>  <span class="n">TLOG</span><span class="p">,</span>  <span class="n">EHVKT</span><span class="p">,</span>  <span class="n">STIM</span><span class="p">):</span>

    <span class="c1">#</span>
    <span class="c1">#   REQUIRES FUNCTIONS COULX AND COULFF</span>
    <span class="c1">#   FREQUENCIES ARE 4X HYDROGEN,CHI ARE FOR ION POT=54.403</span>
    <span class="c1">#</span>
    <span class="n">CONT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>

    <span class="n">N12</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">+</span><span class="mf">1.0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">BOLT</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="mf">54.403</span><span class="o">-</span><span class="mf">54.403</span><span class="o">/</span><span class="n">N12</span><span class="p">)</span><span class="o">/</span><span class="n">TKEV</span><span class="p">)</span><span class="o">*</span><span class="mf">2.</span><span class="o">*</span><span class="n">N12</span><span class="o">*</span><span class="n">XHE2</span>

    <span class="n">FREET</span><span class="o">=</span><span class="n">XNE</span><span class="o">*</span><span class="n">XHE3</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
    <span class="n">XR</span><span class="o">=</span><span class="n">XHE2</span><span class="o">/</span><span class="mf">13.595</span><span class="o">*</span><span class="n">TKEV</span>
    <span class="n">BOLTEX</span><span class="o">=</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">53.859</span><span class="o">/</span><span class="n">TKEV</span><span class="p">)</span><span class="o">*</span><span class="n">XR</span>
    <span class="n">EXLIM</span><span class="o">=</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">54.403</span><span class="o">/</span><span class="n">TKEV</span><span class="p">)</span><span class="o">*</span><span class="n">XR</span>

    <span class="k">for</span> <span class="n">N</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">):</span> <span class="n">CONT</span><span class="p">[</span><span class="n">N</span><span class="p">]</span><span class="o">=</span><span class="n">COULX</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">FREQ</span><span class="p">,</span><span class="mf">2.0</span><span class="p">)</span>

    <span class="n">FREQ3</span><span class="o">=</span><span class="p">(</span><span class="n">FREQ</span><span class="o">*</span><span class="mf">1.E-5</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span>
    <span class="n">CFREE</span><span class="o">=</span><span class="mf">3.6919E-07</span><span class="o">/</span><span class="n">FREQ3</span><span class="o">*</span><span class="mf">4.0</span>
    <span class="n">C</span><span class="o">=</span><span class="mf">2.815E14</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="mf">2.0</span><span class="o">/</span><span class="n">FREQ3</span>
    <span class="n">EX</span><span class="o">=</span><span class="n">BOLTEX</span>

    <span class="k">if</span><span class="p">(</span><span class="n">FREQ</span> <span class="o">&lt;</span> <span class="mf">1.31522E14</span><span class="p">):</span> <span class="n">EX</span><span class="o">=</span><span class="n">EXLIM</span><span class="o">/</span><span class="n">EHVKT</span>
    <span class="n">HE2</span><span class="o">=</span><span class="p">(</span><span class="n">EX</span><span class="o">-</span><span class="n">EXLIM</span><span class="p">)</span><span class="o">*</span><span class="n">C</span>

    <span class="n">HE2</span> <span class="o">+=</span> <span class="p">(</span><span class="n">CONT</span><span class="o">*</span><span class="n">BOLT</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">HE2</span><span class="o">=</span><span class="p">(</span><span class="n">HE2</span><span class="o">+</span><span class="n">COULFF</span><span class="p">(</span><span class="n">TLOG</span><span class="p">,</span><span class="n">FREQLG</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">CFREE</span><span class="o">*</span><span class="n">FREET</span><span class="p">)</span><span class="o">*</span><span class="n">STIM</span>

    <span class="k">if</span><span class="p">(</span><span class="n">HE2</span> <span class="o">&gt;=</span> <span class="mf">1.E-20</span><span class="p">):</span> <span class="k">return</span> <span class="n">HE2</span>
    <span class="k">else</span><span class="p">:</span>              <span class="k">return</span> <span class="mf">0.0</span>


<span class="c1"># ----------------------------------------------------------------------------------------</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">HEMIOP</span><span class="p">(</span> <span class="n">XHE1</span><span class="p">,</span>  <span class="n">FREQ</span><span class="p">,</span>  <span class="n">T</span><span class="p">,</span>  <span class="n">XNE</span><span class="p">):</span>
    <span class="n">A</span><span class="o">=</span> <span class="mf">3.397E-26</span><span class="o">+</span><span class="p">(</span><span class="o">-</span><span class="mf">5.216E-11</span><span class="o">+</span><span class="mf">7.039E05</span><span class="o">/</span><span class="n">FREQ</span><span class="p">)</span><span class="o">/</span><span class="n">FREQ</span><span class="p">;</span>
    <span class="n">B</span><span class="o">=-</span><span class="mf">4.116E-22</span><span class="o">+</span><span class="p">(</span> <span class="mf">1.067E-06</span><span class="o">+</span><span class="mf">8.135E09</span><span class="o">/</span><span class="n">FREQ</span><span class="p">)</span><span class="o">/</span><span class="n">FREQ</span><span class="p">;</span>
    <span class="n">C</span><span class="o">=</span> <span class="mf">5.081E-17</span><span class="o">+</span><span class="p">(</span><span class="o">-</span><span class="mf">8.724E-03</span><span class="o">-</span><span class="mf">5.659E12</span><span class="o">/</span><span class="n">FREQ</span><span class="p">)</span><span class="o">/</span><span class="n">FREQ</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">T</span><span class="o">+</span><span class="n">B</span><span class="o">+</span><span class="n">C</span><span class="o">/</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">XNE</span><span class="o">*</span><span class="n">XHE1</span><span class="o">*</span><span class="mf">1.E-20</span><span class="p">;</span>

<span class="c1"># ----------------------------------------------------------------------------------------</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">HERAOP</span><span class="p">(</span><span class="n">XHE1</span><span class="p">,</span> <span class="n">FREQ</span><span class="p">):</span>
    <span class="n">WW</span><span class="o">=</span><span class="p">(</span><span class="mf">2.997925E+03</span><span class="o">/</span><span class="nb">min</span><span class="p">(</span><span class="n">FREQ</span><span class="o">*</span><span class="mf">1.E-15</span><span class="p">,</span><span class="mf">5.15</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">arg</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">+</span><span class="p">(</span><span class="mf">2.44E5</span><span class="o">+</span><span class="mf">5.94E10</span><span class="o">/</span><span class="p">(</span><span class="n">WW</span><span class="o">-</span><span class="mf">2.90E5</span><span class="p">))</span><span class="o">/</span><span class="n">WW</span>
    <span class="n">SIG</span><span class="o">=</span><span class="mf">5.484E-14</span><span class="o">/</span><span class="n">WW</span><span class="o">/</span><span class="n">WW</span><span class="o">*</span><span class="n">arg</span><span class="o">*</span><span class="n">arg</span>
    <span class="k">return</span> <span class="n">SIG</span><span class="o">*</span><span class="n">XHE1</span>

<span class="c1"># ----------------------------------------------------------------------------------------</span>

<span class="n">PEACH0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">((</span><span class="o">-</span><span class="mf">42.474</span><span class="p">,</span> <span class="o">-</span><span class="mf">42.350</span><span class="p">,</span> <span class="o">-</span><span class="mf">42.109</span><span class="p">,</span> <span class="o">-</span><span class="mf">41.795</span><span class="p">,</span> <span class="o">-</span><span class="mf">41.467</span><span class="p">,</span> <span class="o">-</span><span class="mf">41.159</span><span class="p">,</span> <span class="o">-</span><span class="mf">40.883</span><span class="p">,</span><span class="c1">#,/*  1500 */</span>
                     <span class="o">-</span><span class="mf">41.808</span><span class="p">,</span> <span class="o">-</span><span class="mf">41.735</span><span class="p">,</span> <span class="o">-</span><span class="mf">41.582</span><span class="p">,</span> <span class="o">-</span><span class="mf">41.363</span><span class="p">,</span> <span class="o">-</span><span class="mf">41.115</span><span class="p">,</span> <span class="o">-</span><span class="mf">40.866</span><span class="p">,</span> <span class="o">-</span><span class="mf">40.631</span><span class="p">,</span><span class="c1">#,/*  1550 */</span>
                     <span class="o">-</span><span class="mf">41.273</span><span class="p">,</span> <span class="o">-</span><span class="mf">41.223</span><span class="p">,</span> <span class="o">-</span><span class="mf">41.114</span><span class="p">,</span> <span class="o">-</span><span class="mf">40.951</span><span class="p">,</span> <span class="o">-</span><span class="mf">40.755</span><span class="p">,</span> <span class="o">-</span><span class="mf">40.549</span><span class="p">,</span> <span class="o">-</span><span class="mf">40.347</span><span class="p">,</span><span class="c1">#,/*  1621 */</span>
                     <span class="o">-</span><span class="mf">45.583</span><span class="p">,</span> <span class="o">-</span><span class="mf">44.008</span><span class="p">,</span> <span class="o">-</span><span class="mf">42.957</span><span class="p">,</span> <span class="o">-</span><span class="mf">42.205</span><span class="p">,</span> <span class="o">-</span><span class="mf">41.639</span><span class="p">,</span> <span class="o">-</span><span class="mf">41.198</span><span class="p">,</span> <span class="o">-</span><span class="mf">40.841</span><span class="p">,</span><span class="c1">#,/*  1622 */</span>
                     <span class="o">-</span><span class="mf">44.324</span><span class="p">,</span> <span class="o">-</span><span class="mf">42.747</span><span class="p">,</span> <span class="o">-</span><span class="mf">41.694</span><span class="p">,</span> <span class="o">-</span><span class="mf">40.939</span><span class="p">,</span> <span class="o">-</span><span class="mf">40.370</span><span class="p">,</span> <span class="o">-</span><span class="mf">39.925</span><span class="p">,</span> <span class="o">-</span><span class="mf">39.566</span><span class="p">,</span><span class="c1">#,/*  2513 */</span>
                     <span class="o">-</span><span class="mf">50.969</span><span class="p">,</span> <span class="o">-</span><span class="mf">48.388</span><span class="p">,</span> <span class="o">-</span><span class="mf">46.630</span><span class="p">,</span> <span class="o">-</span><span class="mf">45.344</span><span class="p">,</span> <span class="o">-</span><span class="mf">44.355</span><span class="p">,</span> <span class="o">-</span><span class="mf">43.568</span><span class="p">,</span> <span class="o">-</span><span class="mf">42.924</span><span class="p">,</span><span class="c1">#,/*  2514 */</span>
                     <span class="o">-</span><span class="mf">50.633</span><span class="p">,</span> <span class="o">-</span><span class="mf">48.026</span><span class="p">,</span> <span class="o">-</span><span class="mf">46.220</span><span class="p">,</span> <span class="o">-</span><span class="mf">44.859</span><span class="p">,</span> <span class="o">-</span><span class="mf">43.803</span><span class="p">,</span> <span class="o">-</span><span class="mf">42.957</span><span class="p">,</span> <span class="o">-</span><span class="mf">42.264</span><span class="p">,</span><span class="c1">#,/*  3756 */</span>
                     <span class="o">-</span><span class="mf">53.028</span><span class="p">,</span> <span class="o">-</span><span class="mf">49.643</span><span class="p">,</span> <span class="o">-</span><span class="mf">47.367</span><span class="p">,</span> <span class="o">-</span><span class="mf">45.729</span><span class="p">,</span> <span class="o">-</span><span class="mf">44.491</span><span class="p">,</span> <span class="o">-</span><span class="mf">43.520</span><span class="p">,</span> <span class="o">-</span><span class="mf">42.736</span><span class="p">,</span><span class="c1">#,/*  3757 */</span>
                     <span class="o">-</span><span class="mf">51.785</span><span class="p">,</span> <span class="o">-</span><span class="mf">48.352</span><span class="p">,</span> <span class="o">-</span><span class="mf">46.050</span><span class="p">,</span> <span class="o">-</span><span class="mf">44.393</span><span class="p">,</span> <span class="o">-</span><span class="mf">43.140</span><span class="p">,</span> <span class="o">-</span><span class="mf">42.157</span><span class="p">,</span> <span class="o">-</span><span class="mf">41.363</span><span class="p">,</span><span class="c1">#,/*  6549 */</span>
                     <span class="o">-</span><span class="mf">52.285</span><span class="p">,</span> <span class="o">-</span><span class="mf">48.797</span><span class="p">,</span> <span class="o">-</span><span class="mf">46.453</span><span class="p">,</span> <span class="o">-</span><span class="mf">44.765</span><span class="p">,</span> <span class="o">-</span><span class="mf">43.486</span><span class="p">,</span> <span class="o">-</span><span class="mf">42.480</span><span class="p">,</span> <span class="o">-</span><span class="mf">41.668</span><span class="p">,</span><span class="c1">#,/*  6550 */</span>
                     <span class="o">-</span><span class="mf">52.028</span><span class="p">,</span> <span class="o">-</span><span class="mf">48.540</span><span class="p">,</span> <span class="o">-</span><span class="mf">46.196</span><span class="p">,</span> <span class="o">-</span><span class="mf">44.507</span><span class="p">,</span> <span class="o">-</span><span class="mf">43.227</span><span class="p">,</span> <span class="o">-</span><span class="mf">42.222</span><span class="p">,</span> <span class="o">-</span><span class="mf">41.408</span><span class="p">,</span><span class="c1">#,/*  7234 */</span>
                     <span class="o">-</span><span class="mf">52.384</span><span class="p">,</span> <span class="o">-</span><span class="mf">48.876</span><span class="p">,</span> <span class="o">-</span><span class="mf">46.513</span><span class="p">,</span> <span class="o">-</span><span class="mf">44.806</span><span class="p">,</span> <span class="o">-</span><span class="mf">43.509</span><span class="p">,</span> <span class="o">-</span><span class="mf">42.488</span><span class="p">,</span> <span class="o">-</span><span class="mf">41.660</span><span class="p">,</span><span class="c1">#,/*  7235 */</span>
                     <span class="o">-</span><span class="mf">52.363</span><span class="p">,</span> <span class="o">-</span><span class="mf">48.856</span><span class="p">,</span> <span class="o">-</span><span class="mf">46.493</span><span class="p">,</span> <span class="o">-</span><span class="mf">44.786</span><span class="p">,</span> <span class="o">-</span><span class="mf">43.489</span><span class="p">,</span> <span class="o">-</span><span class="mf">42.467</span><span class="p">,</span> <span class="o">-</span><span class="mf">41.639</span><span class="p">,</span><span class="c1">#,/*  7291 */</span>
                     <span class="o">-</span><span class="mf">54.704</span><span class="p">,</span> <span class="o">-</span><span class="mf">50.772</span><span class="p">,</span> <span class="o">-</span><span class="mf">48.107</span><span class="p">,</span> <span class="o">-</span><span class="mf">46.176</span><span class="p">,</span> <span class="o">-</span><span class="mf">44.707</span><span class="p">,</span> <span class="o">-</span><span class="mf">43.549</span><span class="p">,</span> <span class="o">-</span><span class="mf">42.611</span><span class="p">,</span><span class="c1">#,/*  7292 */</span>
                     <span class="o">-</span><span class="mf">54.359</span><span class="p">,</span> <span class="o">-</span><span class="mf">50.349</span><span class="p">,</span> <span class="o">-</span><span class="mf">47.643</span><span class="p">,</span> <span class="o">-</span><span class="mf">45.685</span><span class="p">,</span> <span class="o">-</span><span class="mf">44.198</span><span class="p">,</span> <span class="o">-</span><span class="mf">43.027</span><span class="p">,</span> <span class="o">-</span><span class="mf">42.418</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">15</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">FREQMG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">((</span><span class="mf">1.9341452e15</span><span class="p">,</span><span class="mf">1.8488510e15</span><span class="p">,</span><span class="mf">1.1925797e15</span><span class="p">,</span> <span class="mf">7.9804046e14</span><span class="p">,</span><span class="mf">4.5772110e14</span><span class="p">,</span><span class="mf">4.1440977e14</span><span class="p">,</span>
                     <span class="mf">4.1113514e14</span><span class="p">))</span>
<span class="n">FLOG0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">((</span><span class="mf">35.32123</span><span class="p">,</span><span class="mf">35.19844</span><span class="p">,</span><span class="mf">35.15334</span><span class="p">,</span><span class="mf">34.71490</span><span class="p">,</span><span class="mf">34.31318</span><span class="p">,</span> <span class="mf">33.75728</span><span class="p">,</span><span class="mf">33.65788</span><span class="p">,</span><span class="mf">33.64994</span><span class="p">,</span><span class="mf">33.43947</span><span class="p">))</span>
<span class="n">TLG0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">((</span><span class="mf">8.29405</span><span class="p">,</span><span class="mf">8.51719</span><span class="p">,</span><span class="mf">8.69951</span><span class="p">,</span><span class="mf">8.85367</span><span class="p">,</span> <span class="mf">8.98720</span><span class="p">,</span><span class="mf">9.10498</span><span class="p">,</span><span class="mf">9.21034</span><span class="p">))</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">Mg1OP</span><span class="p">(</span><span class="n">FREQ</span><span class="p">,</span>  <span class="n">FREQLG</span><span class="p">,</span>  <span class="n">T</span><span class="p">,</span>  <span class="n">TLOG</span><span class="p">):</span>
    <span class="n">NT</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">T</span><span class="o">/</span><span class="mf">1000.</span><span class="p">))</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">NT</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">):</span> <span class="n">NT</span><span class="o">=</span><span class="mi">1</span>

    <span class="n">DT</span><span class="o">=</span><span class="p">(</span><span class="n">TLOG</span><span class="o">-</span><span class="n">TLG0</span><span class="p">[</span><span class="n">NT</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">TLG0</span><span class="p">[</span><span class="n">NT</span><span class="p">]</span><span class="o">-</span><span class="n">TLG0</span><span class="p">[</span><span class="n">NT</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">N</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="n">FREQ</span> <span class="o">&gt;</span> <span class="n">FREQMG</span><span class="p">[</span><span class="n">N</span><span class="p">]):</span> <span class="k">break</span>

    <span class="n">D</span><span class="o">=</span><span class="p">(</span><span class="n">FREQLG</span><span class="o">-</span><span class="n">FLOG0</span><span class="p">[</span><span class="n">N</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">FLOG0</span><span class="p">[</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">FLOG0</span><span class="p">[</span><span class="n">N</span><span class="p">])</span>
    <span class="k">if</span><span class="p">(</span><span class="n">N</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span> <span class="n">N</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">D1</span><span class="o">=</span><span class="mf">1.0</span><span class="o">-</span><span class="n">D</span>
    <span class="n">XWL1</span><span class="o">=</span><span class="n">PEACH0</span><span class="p">[</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">NT</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">D</span> <span class="o">+</span> <span class="n">PEACH0</span><span class="p">[</span><span class="n">N</span><span class="p">,</span><span class="n">NT</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">D1</span>
    <span class="n">XWL2</span><span class="o">=</span><span class="n">PEACH0</span><span class="p">[</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">NT</span>  <span class="p">]</span><span class="o">*</span><span class="n">D</span> <span class="o">+</span> <span class="n">PEACH0</span><span class="p">[</span><span class="n">N</span><span class="p">,</span><span class="n">NT</span>  <span class="p">]</span><span class="o">*</span><span class="n">D1</span>

    <span class="k">return</span> <span class="n">exp</span><span class="p">(</span><span class="n">XWL1</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">DT</span><span class="p">)</span><span class="o">+</span><span class="n">XWL2</span><span class="o">*</span><span class="n">DT</span><span class="p">)</span>

<span class="c1"># ----------------------------------------------------------------------------------------</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">C1OP</span><span class="p">(</span> <span class="n">FREQ</span><span class="p">,</span>  <span class="n">TKEV</span><span class="p">):</span>

  <span class="c1"># CROSS-SECTION TIMES THE PARTITION FUNCTION</span>
  <span class="n">C1240</span><span class="o">=</span><span class="mf">5.</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">1.264</span><span class="o">/</span><span class="n">TKEV</span><span class="p">)</span>
  <span class="n">C1444</span><span class="o">=</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">2.683</span><span class="o">/</span><span class="n">TKEV</span><span class="p">)</span>
  <span class="n">X1444</span><span class="o">=</span><span class="mf">0.0</span>
  <span class="n">X1240</span><span class="o">=</span><span class="mf">0.0</span>
  <span class="n">X1100</span><span class="o">=</span><span class="mf">0.0</span>

  <span class="k">if</span><span class="p">(</span><span class="n">FREQ</span> <span class="o">&gt;=</span> <span class="mf">2.7254E15</span><span class="p">):</span> <span class="n">X1100</span><span class="o">=</span><span class="n">SEATON</span><span class="p">(</span><span class="mf">2.7254E15</span><span class="p">,</span><span class="mf">1.219E-17</span><span class="p">,</span><span class="mf">2.0E0</span><span class="p">,</span><span class="mf">3.317E0</span><span class="p">,</span><span class="n">FREQ</span><span class="p">)</span>
  <span class="k">if</span><span class="p">(</span><span class="n">FREQ</span> <span class="o">&gt;=</span> <span class="mf">2.4196E15</span><span class="p">):</span> <span class="n">X1240</span><span class="o">=</span><span class="n">SEATON</span><span class="p">(</span><span class="mf">2.4196E15</span><span class="p">,</span><span class="mf">1.030E-17</span><span class="p">,</span><span class="mf">1.5E0</span><span class="p">,</span><span class="mf">2.789E0</span><span class="p">,</span><span class="n">FREQ</span><span class="p">)</span>
  <span class="k">if</span><span class="p">(</span><span class="n">FREQ</span> <span class="o">&gt;=</span> <span class="mf">2.0761E15</span><span class="p">):</span> <span class="n">X1444</span><span class="o">=</span><span class="n">SEATON</span><span class="p">(</span><span class="mf">2.0761E15</span><span class="p">,</span><span class="mf">9.590E-18</span><span class="p">,</span><span class="mf">1.5E0</span><span class="p">,</span><span class="mf">3.501E0</span><span class="p">,</span><span class="n">FREQ</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">X1100</span><span class="o">*</span><span class="mf">9.</span><span class="o">+</span><span class="n">X1240</span><span class="o">*</span><span class="n">C1240</span><span class="o">+</span><span class="n">X1444</span><span class="o">*</span><span class="n">C1444</span>

<span class="c1"># ----------------------------------------------------------------------------------------</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">Al1OP</span><span class="p">(</span><span class="n">FREQ</span><span class="p">):</span>
    <span class="k">if</span><span class="p">(</span><span class="n">FREQ</span> <span class="o">&gt;</span> <span class="mf">1.443E15</span><span class="p">):</span> <span class="k">return</span> <span class="mf">2.1E-17</span><span class="o">*</span><span class="p">((</span><span class="mf">1.443E15</span><span class="o">/</span><span class="n">FREQ</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="mf">6.0</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="mf">0.0</span>

<span class="c1"># ----------------------------------------------------------------------------------------</span>

<span class="n">PEACH1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">((</span> <span class="mf">38.136</span><span class="p">,</span><span class="mf">38.138</span><span class="p">,</span><span class="mf">38.140</span><span class="p">,</span><span class="mf">38.141</span><span class="p">,</span><span class="mf">38.143</span><span class="p">,</span><span class="mf">38.144</span><span class="p">,</span><span class="mf">38.144</span><span class="p">,</span><span class="mf">38.145</span><span class="p">,</span><span class="mf">38.145</span><span class="p">,</span><span class="c1">#/* 1200 */</span>
                      <span class="mf">37.834</span><span class="p">,</span><span class="mf">37.839</span><span class="p">,</span><span class="mf">37.843</span><span class="p">,</span><span class="mf">37.847</span><span class="p">,</span><span class="mf">37.850</span><span class="p">,</span><span class="mf">37.853</span><span class="p">,</span><span class="mf">37.855</span><span class="p">,</span><span class="mf">37.857</span><span class="p">,</span><span class="mf">37.858</span><span class="p">,</span><span class="c1">#/* 1400 */</span>
                      <span class="mf">37.898</span><span class="p">,</span><span class="mf">37.898</span><span class="p">,</span><span class="mf">37.897</span><span class="p">,</span><span class="mf">37.897</span><span class="p">,</span><span class="mf">37.897</span><span class="p">,</span><span class="mf">37.896</span><span class="p">,</span><span class="mf">37.895</span><span class="p">,</span><span class="mf">37.895</span><span class="p">,</span><span class="mf">37.894</span><span class="p">,</span><span class="c1">#/* 1519 */</span>
                      <span class="mf">40.737</span><span class="p">,</span><span class="mf">40.319</span><span class="p">,</span><span class="mf">40.047</span><span class="p">,</span><span class="mf">39.855</span><span class="p">,</span><span class="mf">39.714</span><span class="p">,</span><span class="mf">39.604</span><span class="p">,</span><span class="mf">39.517</span><span class="p">,</span><span class="mf">39.445</span><span class="p">,</span><span class="mf">39.385</span><span class="p">,</span><span class="c1">#/* 1520 */</span>
                      <span class="mf">40.581</span><span class="p">,</span><span class="mf">40.164</span><span class="p">,</span><span class="mf">39.893</span><span class="p">,</span><span class="mf">39.702</span><span class="p">,</span><span class="mf">39.561</span><span class="p">,</span><span class="mf">39.452</span><span class="p">,</span><span class="mf">39.366</span><span class="p">,</span><span class="mf">39.295</span><span class="p">,</span><span class="mf">39.235</span><span class="p">,</span><span class="c1">#/* 1676 */</span>
                      <span class="mf">45.521</span><span class="p">,</span><span class="mf">44.456</span><span class="p">,</span><span class="mf">43.753</span><span class="p">,</span><span class="mf">43.254</span><span class="p">,</span><span class="mf">42.878</span><span class="p">,</span><span class="mf">42.580</span><span class="p">,</span><span class="mf">42.332</span><span class="p">,</span><span class="mf">42.119</span><span class="p">,</span><span class="mf">41.930</span><span class="p">,</span><span class="c1">#/* 1677 */</span>
                      <span class="mf">45.520</span><span class="p">,</span><span class="mf">44.455</span><span class="p">,</span><span class="mf">43.752</span><span class="p">,</span><span class="mf">43.251</span><span class="p">,</span><span class="mf">42.871</span><span class="p">,</span><span class="mf">42.569</span><span class="p">,</span><span class="mf">42.315</span><span class="p">,</span><span class="mf">42.094</span><span class="p">,</span><span class="mf">41.896</span><span class="p">,</span><span class="c1">#/* 1978 */</span>
                      <span class="mf">55.068</span><span class="p">,</span><span class="mf">51.783</span><span class="p">,</span><span class="mf">49.553</span><span class="p">,</span><span class="mf">47.942</span><span class="p">,</span><span class="mf">46.723</span><span class="p">,</span><span class="mf">45.768</span><span class="p">,</span><span class="mf">44.997</span><span class="p">,</span><span class="mf">44.360</span><span class="p">,</span><span class="mf">43.823</span><span class="p">,</span><span class="c1">#/* 1979 */</span>
                      <span class="mf">53.868</span><span class="p">,</span><span class="mf">50.369</span><span class="p">,</span><span class="mf">48.031</span><span class="p">,</span><span class="mf">46.355</span><span class="p">,</span><span class="mf">45.092</span><span class="p">,</span><span class="mf">44.104</span><span class="p">,</span><span class="mf">43.308</span><span class="p">,</span><span class="mf">42.652</span><span class="p">,</span><span class="mf">42.100</span><span class="p">,</span><span class="c1">#/* 5379 */</span>
                      <span class="mf">54.133</span><span class="p">,</span><span class="mf">50.597</span><span class="p">,</span><span class="mf">48.233</span><span class="p">,</span><span class="mf">46.539</span><span class="p">,</span><span class="mf">45.261</span><span class="p">,</span><span class="mf">44.262</span><span class="p">,</span><span class="mf">43.456</span><span class="p">,</span><span class="mf">42.790</span><span class="p">,</span><span class="mf">42.230</span><span class="p">,</span><span class="c1">#/* 5380 */</span>
                      <span class="mf">54.051</span><span class="p">,</span><span class="mf">50.514</span><span class="p">,</span><span class="mf">48.150</span><span class="p">,</span><span class="mf">46.454</span><span class="p">,</span><span class="mf">45.176</span><span class="p">,</span><span class="mf">44.175</span><span class="p">,</span><span class="mf">43.368</span><span class="p">,</span><span class="mf">42.702</span><span class="p">,</span><span class="mf">42.141</span><span class="p">,</span><span class="c1">#/* 5624 */</span>
                      <span class="mf">54.442</span><span class="p">,</span><span class="mf">50.854</span><span class="p">,</span><span class="mf">48.455</span><span class="p">,</span><span class="mf">46.733</span><span class="p">,</span><span class="mf">45.433</span><span class="p">,</span><span class="mf">44.415</span><span class="p">,</span><span class="mf">43.592</span><span class="p">,</span><span class="mf">42.912</span><span class="p">,</span><span class="mf">42.340</span><span class="p">,</span><span class="c1">#/* 5625 */</span>
                      <span class="mf">54.320</span><span class="p">,</span><span class="mf">50.722</span><span class="p">,</span><span class="mf">48.313</span><span class="p">,</span><span class="mf">46.583</span><span class="p">,</span><span class="mf">45.277</span><span class="p">,</span><span class="mf">44.251</span><span class="p">,</span><span class="mf">43.423</span><span class="p">,</span><span class="mf">42.738</span><span class="p">,</span><span class="mf">42.160</span><span class="p">,</span><span class="c1">#/* 6260 */</span>
                      <span class="mf">55.691</span><span class="p">,</span><span class="mf">51.965</span><span class="p">,</span><span class="mf">49.444</span><span class="p">,</span><span class="mf">47.615</span><span class="p">,</span><span class="mf">46.221</span><span class="p">,</span><span class="mf">45.119</span><span class="p">,</span><span class="mf">44.223</span><span class="p">,</span><span class="mf">43.478</span><span class="p">,</span><span class="mf">42.848</span><span class="p">,</span><span class="c1">#/* 6261 */</span>
                      <span class="mf">55.661</span><span class="p">,</span><span class="mf">51.933</span><span class="p">,</span><span class="mf">49.412</span><span class="p">,</span><span class="mf">47.582</span><span class="p">,</span><span class="mf">46.188</span><span class="p">,</span><span class="mf">45.085</span><span class="p">,</span><span class="mf">44.189</span><span class="p">,</span><span class="mf">43.445</span><span class="p">,</span><span class="mf">42.813</span><span class="p">,</span><span class="c1">#/* 6349 */</span>
                      <span class="mf">55.973</span><span class="p">,</span><span class="mf">52.193</span><span class="p">,</span><span class="mf">49.630</span><span class="p">,</span><span class="mf">47.769</span><span class="p">,</span><span class="mf">46.349</span><span class="p">,</span><span class="mf">45.226</span><span class="p">,</span><span class="mf">44.314</span><span class="p">,</span><span class="mf">43.555</span><span class="p">,</span><span class="mf">42.913</span><span class="p">,</span><span class="c1">#/* 6350 */</span>
                      <span class="mf">55.922</span><span class="p">,</span><span class="mf">52.141</span><span class="p">,</span><span class="mf">49.577</span><span class="p">,</span><span class="mf">47.715</span><span class="p">,</span><span class="mf">46.295</span><span class="p">,</span><span class="mf">45.172</span><span class="p">,</span><span class="mf">44.259</span><span class="p">,</span><span class="mf">43.500</span><span class="p">,</span><span class="mf">42.858</span><span class="p">,</span><span class="c1">#/* 6491 */</span>
                      <span class="mf">56.828</span><span class="p">,</span><span class="mf">52.821</span><span class="p">,</span><span class="mf">50.110</span><span class="p">,</span><span class="mf">48.146</span><span class="p">,</span><span class="mf">46.654</span><span class="p">,</span><span class="mf">45.477</span><span class="p">,</span><span class="mf">44.522</span><span class="p">,</span><span class="mf">43.730</span><span class="p">,</span><span class="mf">43.061</span><span class="p">,</span><span class="c1">#/* 6492 */</span>
                      <span class="mf">56.657</span><span class="p">,</span><span class="mf">52.653</span><span class="p">,</span><span class="mf">49.944</span><span class="p">,</span><span class="mf">47.983</span><span class="p">,</span><span class="mf">46.491</span><span class="p">,</span><span class="mf">45.315</span><span class="p">,</span><span class="mf">44.360</span><span class="p">,</span><span class="mf">43.569</span><span class="p">,</span><span class="mf">42.901</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">19</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>
<span class="n">FREQSI1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">((</span><span class="mf">2.1413750e15</span><span class="p">,</span><span class="mf">1.97231650e15</span><span class="p">,</span><span class="mf">1.7879689e15</span><span class="p">,</span><span class="mf">1.5152920e15</span><span class="p">,</span><span class="mf">0.55723927e15</span><span class="p">,</span><span class="mf">5.3295914e14</span><span class="p">,</span><span class="mf">4.7886458e14</span><span class="p">,</span><span class="mf">4.72164220e14</span><span class="p">,</span><span class="mf">4.6185133e14</span><span class="p">))</span>
<span class="n">FLOG1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">((</span><span class="mf">35.45438</span><span class="p">,</span><span class="mf">35.30022</span><span class="p">,</span><span class="mf">35.21799</span><span class="p">,</span><span class="mf">35.11986</span><span class="p">,</span><span class="mf">34.95438</span><span class="p">,</span> <span class="mf">33.95402</span><span class="p">,</span><span class="mf">33.90947</span><span class="p">,</span><span class="mf">33.80244</span><span class="p">,</span><span class="mf">33.78835</span><span class="p">,</span><span class="mf">33.76626</span><span class="p">,</span> <span class="mf">33.70518</span><span class="p">))</span>
<span class="n">TLG1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">((</span><span class="mf">8.29405</span><span class="p">,</span><span class="mf">8.51719</span><span class="p">,</span><span class="mf">8.69951</span><span class="p">,</span><span class="mf">8.85367</span><span class="p">,</span><span class="mf">8.98720</span><span class="p">,</span><span class="mf">9.10498</span><span class="p">,</span><span class="mf">9.21034</span><span class="p">,</span><span class="mf">9.30565</span><span class="p">,</span><span class="mf">9.39266</span><span class="p">))</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">Si1OP</span><span class="p">(</span><span class="n">FREQ</span><span class="p">,</span> <span class="n">FREQLG</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">TLOG</span><span class="p">):</span>
    <span class="n">NT</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">T</span><span class="o">/</span><span class="mf">1000.</span><span class="p">))</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">NT</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">):</span> <span class="n">NT</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">DT</span><span class="o">=</span><span class="p">(</span><span class="n">TLOG</span><span class="o">-</span><span class="n">TLG1</span><span class="p">[</span><span class="n">NT</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">TLG1</span><span class="p">[</span><span class="n">NT</span><span class="p">]</span><span class="o">-</span><span class="n">TLG1</span><span class="p">[</span><span class="n">NT</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">N</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="n">FREQ</span> <span class="o">&gt;</span> <span class="n">FREQSI1</span><span class="p">[</span><span class="n">N</span><span class="p">]):</span> <span class="k">break</span>

    <span class="n">D</span><span class="o">=</span><span class="p">(</span><span class="n">FREQLG</span><span class="o">-</span><span class="n">FLOG1</span><span class="p">[</span><span class="n">N</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">FLOG1</span><span class="p">[</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">FLOG1</span><span class="p">[</span><span class="n">N</span><span class="p">])</span>

    <span class="k">if</span><span class="p">(</span><span class="n">N</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span> <span class="n">N</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">DD</span><span class="o">=</span><span class="mf">1.</span><span class="o">-</span><span class="n">D</span>
    <span class="n">XWL1</span><span class="o">=</span><span class="n">PEACH1</span><span class="p">[</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">NT</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">D</span><span class="o">+</span><span class="n">PEACH1</span><span class="p">[</span><span class="n">N</span><span class="p">,</span><span class="n">NT</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">DD</span>
    <span class="n">XWL2</span><span class="o">=</span><span class="n">PEACH1</span><span class="p">[</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">NT</span>  <span class="p">]</span><span class="o">*</span><span class="n">D</span><span class="o">+</span><span class="n">PEACH1</span><span class="p">[</span><span class="n">N</span><span class="p">,</span><span class="n">NT</span>  <span class="p">]</span><span class="o">*</span><span class="n">DD</span>

    <span class="k">return</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">XWL1</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">DT</span><span class="p">)</span><span class="o">+</span><span class="n">XWL2</span><span class="o">*</span><span class="n">DT</span><span class="p">))</span><span class="o">*</span><span class="mf">9.</span>

<span class="c1"># ----------------------------------------------------------------------------------------</span>


<span class="n">G1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">((</span><span class="mf">25.</span><span class="p">,</span><span class="mf">35.</span><span class="p">,</span><span class="mf">21.</span><span class="p">,</span><span class="mf">15.</span><span class="p">,</span> <span class="mf">9.</span><span class="p">,</span><span class="mf">35.</span><span class="p">,</span><span class="mf">33.</span><span class="p">,</span><span class="mf">21.</span><span class="p">,</span><span class="mf">27.</span><span class="p">,</span><span class="mf">49.</span><span class="p">,</span> <span class="mf">9.</span><span class="p">,</span><span class="mf">21.</span><span class="p">,</span>
                <span class="mf">27.</span><span class="p">,</span> <span class="mf">9.</span><span class="p">,</span> <span class="mf">9.</span><span class="p">,</span><span class="mf">25.</span><span class="p">,</span><span class="mf">33.</span><span class="p">,</span><span class="mf">15.</span><span class="p">,</span><span class="mf">35.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">,</span><span class="mf">11.</span><span class="p">,</span><span class="mf">15.</span><span class="p">,</span><span class="mf">13.</span><span class="p">,</span>
                <span class="mf">15.</span><span class="p">,</span> <span class="mf">9.</span><span class="p">,</span><span class="mf">21.</span><span class="p">,</span><span class="mf">15.</span><span class="p">,</span><span class="mf">21.</span><span class="p">,</span><span class="mf">25.</span><span class="p">,</span><span class="mf">35.</span><span class="p">,</span> <span class="mf">9.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">,</span><span class="mf">45.</span><span class="p">,</span><span class="mf">27.</span><span class="p">,</span><span class="mf">21.</span><span class="p">,</span>
                 <span class="mf">15.</span><span class="p">,</span><span class="mf">21.</span><span class="p">,</span><span class="mf">15.</span><span class="p">,</span><span class="mf">25.</span><span class="p">,</span><span class="mf">21.</span><span class="p">,</span><span class="mf">35.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">,</span><span class="mf">15.</span><span class="p">,</span><span class="mf">45.</span><span class="p">,</span><span class="mf">35.</span><span class="p">,</span><span class="mf">55.</span><span class="p">,</span><span class="mf">25.</span><span class="p">))</span>
<span class="n">E1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">((</span><span class="mf">500.</span><span class="p">,</span> <span class="mf">7500.</span><span class="p">,</span><span class="mf">12500.</span><span class="p">,</span><span class="mf">17500.</span><span class="p">,</span><span class="mf">19000.</span><span class="p">,</span><span class="mf">19500.</span><span class="p">,</span><span class="mf">19500.</span><span class="p">,</span>
		<span class="mf">21000.</span><span class="p">,</span><span class="mf">22000.</span><span class="p">,</span><span class="mf">23000.</span><span class="p">,</span><span class="mf">23000.</span><span class="p">,</span><span class="mf">24000.</span><span class="p">,</span><span class="mf">24000.</span><span class="p">,</span><span class="mf">24500.</span><span class="p">,</span>
		<span class="mf">24500.</span><span class="p">,</span><span class="mf">26000.</span><span class="p">,</span><span class="mf">26500.</span><span class="p">,</span><span class="mf">26500.</span><span class="p">,</span><span class="mf">27000.</span><span class="p">,</span><span class="mf">27500.</span><span class="p">,</span><span class="mf">28500.</span><span class="p">,</span>
		<span class="mf">29000.</span><span class="p">,</span><span class="mf">29500.</span><span class="p">,</span><span class="mf">29500.</span><span class="p">,</span><span class="mf">29500.</span><span class="p">,</span><span class="mf">30000.</span><span class="p">,</span><span class="mf">31500.</span><span class="p">,</span><span class="mf">31500.</span><span class="p">,</span>
		<span class="mf">33500.</span><span class="p">,</span><span class="mf">33500.</span><span class="p">,</span><span class="mf">34000.</span><span class="p">,</span><span class="mf">34500.</span><span class="p">,</span><span class="mf">34500.</span><span class="p">,</span><span class="mf">35000.</span><span class="p">,</span><span class="mf">35500.</span><span class="p">,</span>
		<span class="mf">37000.</span><span class="p">,</span><span class="mf">37000.</span><span class="p">,</span><span class="mf">37000.</span><span class="p">,</span><span class="mf">38500.</span><span class="p">,</span><span class="mf">40000.</span><span class="p">,</span><span class="mf">40000.</span><span class="p">,</span><span class="mf">41000.</span><span class="p">,</span>
		 <span class="mf">41000.</span><span class="p">,</span><span class="mf">43000.</span><span class="p">,</span><span class="mf">43000.</span><span class="p">,</span><span class="mf">43000.</span><span class="p">,</span><span class="mf">43000.</span><span class="p">,</span><span class="mf">44000.</span><span class="p">))</span>
<span class="n">WNO1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">((</span><span class="mf">63500.</span><span class="p">,</span><span class="mf">58500.</span><span class="p">,</span><span class="mf">53500.</span><span class="p">,</span><span class="mf">59500.</span><span class="p">,</span><span class="mf">45000.</span><span class="p">,</span><span class="mf">44500.</span><span class="p">,</span><span class="mf">44500.</span><span class="p">,</span>
                  <span class="mf">43000.</span><span class="p">,</span><span class="mf">58000.</span><span class="p">,</span><span class="mf">41000.</span><span class="p">,</span><span class="mf">54000.</span><span class="p">,</span><span class="mf">40000.</span><span class="p">,</span><span class="mf">40000.</span><span class="p">,</span><span class="mf">57500.</span><span class="p">,</span>
                  <span class="mf">55500.</span><span class="p">,</span><span class="mf">38000.</span><span class="p">,</span><span class="mf">57500.</span><span class="p">,</span><span class="mf">57500.</span><span class="p">,</span><span class="mf">37000.</span><span class="p">,</span><span class="mf">54500.</span><span class="p">,</span><span class="mf">53500.</span><span class="p">,</span>
                  <span class="mf">55000.</span><span class="p">,</span><span class="mf">34500.</span><span class="p">,</span><span class="mf">34500.</span><span class="p">,</span><span class="mf">34500.</span><span class="p">,</span><span class="mf">34000.</span><span class="p">,</span><span class="mf">32500.</span><span class="p">,</span><span class="mf">32500.</span><span class="p">,</span>
                  <span class="mf">32500.</span><span class="p">,</span><span class="mf">32500.</span><span class="p">,</span><span class="mf">32000.</span><span class="p">,</span><span class="mf">29500.</span><span class="p">,</span><span class="mf">29500.</span><span class="p">,</span><span class="mf">31000.</span><span class="p">,</span><span class="mf">30500.</span><span class="p">,</span>
                  <span class="mf">29000.</span><span class="p">,</span><span class="mf">27000.</span><span class="p">,</span><span class="mf">54000.</span><span class="p">,</span><span class="mf">27500.</span><span class="p">,</span><span class="mf">24000.</span><span class="p">,</span><span class="mf">47000.</span><span class="p">,</span><span class="mf">23000.</span><span class="p">,</span>
                   <span class="mf">44000.</span><span class="p">,</span><span class="mf">42000.</span><span class="p">,</span><span class="mf">42000.</span><span class="p">,</span><span class="mf">21000.</span><span class="p">,</span><span class="mf">42000.</span><span class="p">,</span><span class="mf">42000.</span><span class="p">))</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">Fe1OP</span><span class="p">(</span><span class="n">FREQ</span><span class="p">,</span> <span class="n">HKT</span><span class="p">):</span>
    <span class="n">WAVENO</span><span class="o">=</span><span class="n">FREQ</span><span class="o">/</span><span class="mf">2.99792458E10</span>
    <span class="k">if</span><span class="p">(</span><span class="n">WAVENO</span> <span class="o">&lt;</span> <span class="mf">21000.</span><span class="p">):</span> <span class="k">return</span> <span class="mf">0.0</span>
    <span class="n">BOLT</span><span class="o">=</span><span class="n">G1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">E1</span><span class="o">*</span><span class="mf">2.99792458e10</span><span class="o">*</span><span class="n">HKT</span><span class="p">);</span>
    <span class="n">XXX</span><span class="o">=</span><span class="p">((</span><span class="n">WNO1</span><span class="o">+</span><span class="mf">3000.</span><span class="o">-</span><span class="n">WAVENO</span><span class="p">)</span><span class="o">/</span><span class="n">WNO1</span><span class="o">/</span><span class="mf">.1</span><span class="p">)</span>


    <span class="n">XSECT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">48</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">WNO1</span> <span class="o">&lt;</span><span class="n">WAVENO</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">XSECT</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.e-18</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">XXX</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">XSECT</span><span class="o">*</span><span class="n">BOLT</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="c1"># ----------------------------------------------------------------------------------------</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">COOLOP</span><span class="p">(</span><span class="n">XC1</span><span class="p">,</span><span class="n">XMg1</span><span class="p">,</span><span class="n">XAl1</span><span class="p">,</span><span class="n">XSi1</span><span class="p">,</span><span class="n">XFe1</span><span class="p">,</span><span class="n">STIM</span><span class="p">,</span><span class="n">FREQ</span><span class="p">,</span><span class="n">FREQLG</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">TLOG</span><span class="p">,</span><span class="n">TKEV</span><span class="p">,</span><span class="n">HKT</span><span class="p">):</span>
    <span class="c1">#     Si I, Mg I, Al I, C I, Fe I</span>

    <span class="k">return</span> <span class="p">(</span> <span class="n">C1OP</span><span class="p">(</span><span class="n">FREQ</span><span class="p">,</span><span class="n">TKEV</span>          <span class="p">)</span><span class="o">*</span><span class="n">XC1</span> <span class="o">+</span>
	     <span class="n">Mg1OP</span><span class="p">(</span><span class="n">FREQ</span><span class="p">,</span><span class="n">FREQLG</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">TLOG</span><span class="p">)</span><span class="o">*</span><span class="n">XMg1</span><span class="o">+</span>
	     <span class="n">Al1OP</span><span class="p">(</span><span class="n">FREQ</span>              <span class="p">)</span><span class="o">*</span><span class="n">XAl1</span><span class="o">+</span>
	     <span class="n">Si1OP</span><span class="p">(</span><span class="n">FREQ</span><span class="p">,</span><span class="n">FREQLG</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">TLOG</span><span class="p">)</span><span class="o">*</span><span class="n">XSi1</span><span class="o">+</span>
             <span class="n">Fe1OP</span><span class="p">(</span><span class="n">FREQ</span><span class="p">,</span><span class="n">HKT</span>          <span class="p">)</span><span class="o">*</span><span class="n">XFe1</span><span class="p">)</span><span class="o">*</span><span class="n">STIM</span>

<span class="c1"># ----------------------------------------------------------------------------------------</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">N1OP</span><span class="p">(</span> <span class="n">FREQ</span><span class="p">,</span>  <span class="n">TKEV</span><span class="p">):</span>

    <span class="c1"># CROSS-SECTION TIMES PARTITION FUNCTION</span>

  <span class="n">C1130</span><span class="o">=</span><span class="mf">6.</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">3.575</span><span class="o">/</span><span class="n">TKEV</span><span class="p">)</span>
  <span class="n">C1020</span><span class="o">=</span><span class="mf">10.</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">2.384</span><span class="o">/</span><span class="n">TKEV</span><span class="p">)</span>
  <span class="n">X1130</span><span class="o">=</span><span class="mf">0.</span>
  <span class="n">X1020</span><span class="o">=</span><span class="mf">0.</span>
  <span class="n">X853</span><span class="o">=</span><span class="mf">0.</span>

  <span class="k">if</span><span class="p">(</span><span class="n">FREQ</span> <span class="o">&gt;=</span> <span class="mf">3.517915E15</span><span class="p">):</span> <span class="n">X853</span> <span class="o">=</span><span class="n">SEATON</span><span class="p">(</span><span class="mf">3.517915E15</span><span class="p">,</span><span class="mf">1.142E-17</span><span class="p">,</span><span class="mf">2.0E0</span><span class="p">,</span><span class="mf">4.29E0</span><span class="p">,</span><span class="n">FREQ</span><span class="p">)</span>
  <span class="k">if</span><span class="p">(</span><span class="n">FREQ</span> <span class="o">&gt;=</span> <span class="mf">2.941534E15</span><span class="p">):</span> <span class="n">X1020</span><span class="o">=</span><span class="n">SEATON</span><span class="p">(</span><span class="mf">2.941534E15</span><span class="p">,</span><span class="mf">4.410E-18</span><span class="p">,</span><span class="mf">1.5E0</span><span class="p">,</span><span class="mf">3.85E0</span><span class="p">,</span><span class="n">FREQ</span><span class="p">)</span>
  <span class="k">if</span><span class="p">(</span><span class="n">FREQ</span> <span class="o">&gt;=</span> <span class="mf">2.653317E15</span><span class="p">):</span> <span class="n">X1130</span><span class="o">=</span><span class="n">SEATON</span><span class="p">(</span><span class="mf">2.653317E15</span><span class="p">,</span><span class="mf">4.200E-18</span><span class="p">,</span><span class="mf">1.5E0</span><span class="p">,</span><span class="mf">4.34E0</span><span class="p">,</span><span class="n">FREQ</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">X853</span><span class="o">*</span><span class="mf">4.</span><span class="o">+</span><span class="n">X1020</span><span class="o">*</span><span class="n">C1020</span><span class="o">+</span><span class="n">X1130</span><span class="o">*</span><span class="n">C1130</span>

<span class="c1"># ----------------------------------------------------------------------------------------</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">O1OP</span><span class="p">(</span> <span class="n">FREQ</span><span class="p">):</span>
    <span class="k">if</span><span class="p">(</span><span class="n">FREQ</span> <span class="o">&gt;=</span> <span class="mf">3.28805E15</span><span class="p">):</span> <span class="k">return</span> <span class="mf">9.</span><span class="o">*</span><span class="n">SEATON</span><span class="p">(</span><span class="mf">3.28805E15</span><span class="p">,</span><span class="mf">2.94E-18</span><span class="p">,</span><span class="mf">1.E0</span><span class="p">,</span><span class="mf">2.66E0</span><span class="p">,</span><span class="n">FREQ</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="mf">0.0</span>

<span class="c1"># ----------------------------------------------------------------------------------------</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">Mg2OP</span><span class="p">(</span> <span class="n">FREQ</span><span class="p">,</span>  <span class="n">TKEV</span><span class="p">):</span>

  <span class="c1">#    CROSS-SECTION TIMES PARTITION FUNCTION</span>

  <span class="n">C1169</span><span class="o">=</span><span class="mf">6.</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">4.43</span><span class="o">/</span><span class="n">TKEV</span><span class="p">)</span>
  <span class="n">X1169</span><span class="o">=</span><span class="mf">0.0</span>
  <span class="n">X824</span><span class="o">=</span><span class="mf">0.0</span>

  <span class="k">if</span><span class="p">(</span><span class="n">FREQ</span> <span class="o">&gt;=</span> <span class="mf">3.635492E15</span><span class="p">):</span> <span class="n">X824</span> <span class="o">=</span><span class="n">SEATON</span><span class="p">(</span><span class="mf">3.635492E15</span><span class="p">,</span><span class="mf">1.40E-19</span><span class="p">,</span><span class="mf">4.E0</span><span class="p">,</span><span class="mf">6.7E0</span><span class="p">,</span><span class="n">FREQ</span><span class="p">)</span>
  <span class="k">if</span><span class="p">(</span><span class="n">FREQ</span> <span class="o">&gt;=</span> <span class="mf">2.564306E15</span><span class="p">):</span> <span class="n">X1169</span><span class="o">=</span><span class="mf">5.11E-19</span><span class="o">*</span><span class="p">(</span><span class="mf">2.564306E15</span><span class="o">/</span><span class="n">FREQ</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span>

  <span class="k">return</span> <span class="n">X824</span><span class="o">*</span><span class="mf">2.</span><span class="o">+</span><span class="n">X1169</span><span class="o">*</span><span class="n">C1169</span>

<span class="c1"># ----------------------------------------------------------------------------------------</span>

<span class="n">PEACH2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">((</span><span class="o">-</span><span class="mf">43.8941</span><span class="p">,</span> <span class="o">-</span><span class="mf">43.8941</span><span class="p">,</span> <span class="o">-</span><span class="mf">43.8941</span><span class="p">,</span> <span class="o">-</span><span class="mf">43.8941</span><span class="p">,</span> <span class="o">-</span><span class="mf">43.8941</span><span class="p">,</span> <span class="o">-</span><span class="mf">43.8941</span><span class="p">,</span><span class="c1">#/*    500 */</span>
                     <span class="o">-</span><span class="mf">42.2444</span><span class="p">,</span> <span class="o">-</span><span class="mf">42.2444</span><span class="p">,</span> <span class="o">-</span><span class="mf">42.2444</span><span class="p">,</span> <span class="o">-</span><span class="mf">42.2444</span><span class="p">,</span> <span class="o">-</span><span class="mf">42.2444</span><span class="p">,</span> <span class="o">-</span><span class="mf">42.2444</span><span class="p">,</span><span class="c1">#/*    600 */</span>
                     <span class="o">-</span><span class="mf">40.6054</span><span class="p">,</span> <span class="o">-</span><span class="mf">40.6054</span><span class="p">,</span> <span class="o">-</span><span class="mf">40.6054</span><span class="p">,</span> <span class="o">-</span><span class="mf">40.6054</span><span class="p">,</span> <span class="o">-</span><span class="mf">40.6054</span><span class="p">,</span> <span class="o">-</span><span class="mf">40.6054</span><span class="p">,</span><span class="c1">#/*    759 */</span>
                     <span class="o">-</span><span class="mf">54.2389</span><span class="p">,</span> <span class="o">-</span><span class="mf">52.2906</span><span class="p">,</span> <span class="o">-</span><span class="mf">50.8799</span><span class="p">,</span> <span class="o">-</span><span class="mf">49.8033</span><span class="p">,</span> <span class="o">-</span><span class="mf">48.9485</span><span class="p">,</span> <span class="o">-</span><span class="mf">48.2490</span><span class="p">,</span><span class="c1">#/*    760 */</span>
                     <span class="o">-</span><span class="mf">50.4108</span><span class="p">,</span> <span class="o">-</span><span class="mf">48.4892</span><span class="p">,</span> <span class="o">-</span><span class="mf">47.1090</span><span class="p">,</span> <span class="o">-</span><span class="mf">46.0672</span><span class="p">,</span> <span class="o">-</span><span class="mf">45.2510</span><span class="p">,</span> <span class="o">-</span><span class="mf">44.5933</span><span class="p">,</span><span class="c1">#/*   1905 */</span>
                     <span class="o">-</span><span class="mf">52.0936</span><span class="p">,</span> <span class="o">-</span><span class="mf">50.0741</span><span class="p">,</span> <span class="o">-</span><span class="mf">48.5999</span><span class="p">,</span> <span class="o">-</span><span class="mf">47.4676</span><span class="p">,</span> <span class="o">-</span><span class="mf">46.5649</span><span class="p">,</span> <span class="o">-</span><span class="mf">45.8246</span><span class="p">,</span><span class="c1">#/*   1906 */</span>
                     <span class="o">-</span><span class="mf">51.9548</span><span class="p">,</span> <span class="o">-</span><span class="mf">49.9371</span><span class="p">,</span> <span class="o">-</span><span class="mf">48.4647</span><span class="p">,</span> <span class="o">-</span><span class="mf">47.3340</span><span class="p">,</span> <span class="o">-</span><span class="mf">46.4333</span><span class="p">,</span> <span class="o">-</span><span class="mf">45.6947</span><span class="p">,</span><span class="c1">#/*   1975 */</span>
                     <span class="o">-</span><span class="mf">54.2407</span><span class="p">,</span> <span class="o">-</span><span class="mf">51.7319</span><span class="p">,</span> <span class="o">-</span><span class="mf">49.9178</span><span class="p">,</span> <span class="o">-</span><span class="mf">48.5395</span><span class="p">,</span> <span class="o">-</span><span class="mf">47.4529</span><span class="p">,</span> <span class="o">-</span><span class="mf">46.5709</span><span class="p">,</span><span class="c1">#/*   1976 */</span>
                     <span class="o">-</span><span class="mf">52.7355</span><span class="p">,</span> <span class="o">-</span><span class="mf">50.2218</span><span class="p">,</span> <span class="o">-</span><span class="mf">48.4059</span><span class="p">,</span> <span class="o">-</span><span class="mf">47.0267</span><span class="p">,</span> <span class="o">-</span><span class="mf">45.9402</span><span class="p">,</span> <span class="o">-</span><span class="mf">45.0592</span><span class="p">,</span><span class="c1">#/*   3245 */</span>
                     <span class="o">-</span><span class="mf">53.5387</span><span class="p">,</span> <span class="o">-</span><span class="mf">50.9189</span><span class="p">,</span> <span class="o">-</span><span class="mf">49.0200</span><span class="p">,</span> <span class="o">-</span><span class="mf">47.5750</span><span class="p">,</span> <span class="o">-</span><span class="mf">46.4341</span><span class="p">,</span> <span class="o">-</span><span class="mf">45.5082</span><span class="p">,</span><span class="c1">#/*   3246 */</span>
                     <span class="o">-</span><span class="mf">53.2417</span><span class="p">,</span> <span class="o">-</span><span class="mf">50.6234</span><span class="p">,</span> <span class="o">-</span><span class="mf">48.7252</span><span class="p">,</span> <span class="o">-</span><span class="mf">47.2810</span><span class="p">,</span> <span class="o">-</span><span class="mf">46.1410</span><span class="p">,</span> <span class="o">-</span><span class="mf">45.2153</span><span class="p">,</span><span class="c1">#/*   3576 */</span>
                     <span class="o">-</span><span class="mf">53.5097</span><span class="p">,</span> <span class="o">-</span><span class="mf">50.8535</span><span class="p">,</span> <span class="o">-</span><span class="mf">48.9263</span><span class="p">,</span> <span class="o">-</span><span class="mf">47.4586</span><span class="p">,</span> <span class="o">-</span><span class="mf">46.2994</span><span class="p">,</span> <span class="o">-</span><span class="mf">45.3581</span><span class="p">,</span><span class="c1">#/*   3577 */</span>
                     <span class="o">-</span><span class="mf">54.0561</span><span class="p">,</span> <span class="o">-</span><span class="mf">51.2365</span><span class="p">,</span> <span class="o">-</span><span class="mf">49.1980</span><span class="p">,</span> <span class="o">-</span><span class="mf">47.6497</span><span class="p">,</span> <span class="o">-</span><span class="mf">46.4302</span><span class="p">,</span> <span class="o">-</span><span class="mf">45.4414</span><span class="p">,</span><span class="c1">#/*   3900 */</span>
                     <span class="o">-</span><span class="mf">53.8469</span><span class="p">,</span> <span class="o">-</span><span class="mf">51.0256</span><span class="p">,</span> <span class="o">-</span><span class="mf">48.9860</span><span class="p">,</span> <span class="o">-</span><span class="mf">47.4368</span><span class="p">,</span> <span class="o">-</span><span class="mf">46.2162</span><span class="p">,</span> <span class="o">-</span><span class="mf">45.2266</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">14</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="n">FREQSI2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">((</span><span class="mf">4.9965417e15</span><span class="p">,</span><span class="mf">3.9466738e15</span><span class="p">,</span><span class="mf">1.5736321e15</span><span class="p">,</span><span class="mf">1.5171539e15</span><span class="p">,</span><span class="mf">9.2378947e14</span><span class="p">,</span><span class="mf">8.3825004e14</span><span class="p">,</span><span class="mf">7.6869872e14</span><span class="p">))</span>
<span class="n">FLOG2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">((</span><span class="mf">36.32984</span><span class="p">,</span><span class="mf">36.14752</span><span class="p">,</span><span class="mf">35.91165</span><span class="p">,</span><span class="mf">34.99216</span><span class="p">,</span><span class="mf">34.95561</span><span class="p">,</span><span class="mf">34.45941</span><span class="p">,</span><span class="mf">34.36234</span><span class="p">,</span><span class="mf">34.27572</span><span class="p">,</span><span class="mf">34.20161</span><span class="p">))</span>
<span class="n">TLG2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">((</span><span class="mf">9.21034</span><span class="p">,</span><span class="mf">9.39266</span><span class="p">,</span><span class="mf">9.54681</span><span class="p">,</span><span class="mf">9.68034</span><span class="p">,</span><span class="mf">9.79813</span><span class="p">,</span><span class="mf">9.90349</span><span class="p">))</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">Si2OP</span><span class="p">(</span> <span class="n">FREQ</span><span class="p">,</span>  <span class="n">FREQLG</span><span class="p">,</span>  <span class="n">T</span><span class="p">,</span>  <span class="n">TLOG</span><span class="p">):</span>

    <span class="n">NT</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">T</span><span class="o">/</span><span class="mf">2000.</span><span class="p">))</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">NT</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">):</span> <span class="n">NT</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">DT</span><span class="o">=</span><span class="p">(</span><span class="n">TLOG</span><span class="o">-</span><span class="n">TLG2</span><span class="p">[</span><span class="n">NT</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">TLG2</span><span class="p">[</span><span class="n">NT</span><span class="p">]</span><span class="o">-</span><span class="n">TLG2</span><span class="p">[</span><span class="n">NT</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">N</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="n">FREQ</span><span class="o">&gt;</span><span class="n">FREQSI2</span><span class="p">[</span><span class="n">N</span><span class="p">]):</span>
            <span class="k">break</span>

    <span class="n">D</span><span class="o">=</span><span class="p">(</span><span class="n">FREQLG</span><span class="o">-</span><span class="n">FLOG2</span><span class="p">[</span><span class="n">N</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">FLOG2</span><span class="p">[</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">FLOG2</span><span class="p">[</span><span class="n">N</span><span class="p">])</span>

    <span class="k">if</span><span class="p">(</span><span class="n">N</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span> <span class="n">N</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span>
    <span class="k">if</span><span class="p">(</span><span class="n">N</span><span class="o">==</span><span class="mi">13</span><span class="p">):</span> <span class="n">N</span><span class="o">=</span><span class="mi">12</span>

    <span class="n">D1</span><span class="o">=</span><span class="mf">1.</span><span class="o">-</span><span class="n">D</span>
    <span class="n">XWL1</span><span class="o">=</span><span class="n">PEACH2</span><span class="p">[</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">NT</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">D</span><span class="o">+</span><span class="n">PEACH2</span><span class="p">[</span><span class="n">N</span><span class="p">,</span><span class="n">NT</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">D1</span>
    <span class="n">XWL2</span><span class="o">=</span><span class="n">PEACH2</span><span class="p">[</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">NT</span>  <span class="p">]</span><span class="o">*</span><span class="n">D</span><span class="o">+</span><span class="n">PEACH2</span><span class="p">[</span><span class="n">N</span><span class="p">,</span><span class="n">NT</span>  <span class="p">]</span><span class="o">*</span><span class="n">D1</span>

    <span class="k">return</span> <span class="n">exp</span><span class="p">(</span><span class="n">XWL1</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">DT</span><span class="p">)</span><span class="o">+</span><span class="n">XWL2</span><span class="o">*</span><span class="n">DT</span><span class="p">)</span><span class="o">*</span><span class="mf">6.</span>

<span class="c1"># ----------------------------------------------------------------------------------------</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">Ca2OP</span><span class="p">(</span> <span class="n">FREQ</span><span class="p">,</span>  <span class="n">TKEV</span><span class="p">):</span>

    <span class="n">C1218</span><span class="o">=</span><span class="mf">10.</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">1.697</span><span class="o">/</span><span class="n">TKEV</span><span class="p">)</span>
    <span class="n">C1420</span><span class="o">=</span><span class="mf">6.</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">3.142</span><span class="o">/</span><span class="n">TKEV</span><span class="p">)</span>
    <span class="n">X1044</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span> <span class="n">X1218</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span> <span class="n">X1420</span><span class="o">=</span><span class="mf">0.</span>

    <span class="k">if</span><span class="p">(</span><span class="n">FREQ</span><span class="o">&gt;=</span><span class="mf">2.870454e15</span><span class="p">):</span>
        <span class="n">XXX</span><span class="o">=</span><span class="p">(</span><span class="mf">2.870454e15</span><span class="o">/</span><span class="n">FREQ</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span>
        <span class="n">X1044</span><span class="o">=</span><span class="mf">1.08e-19</span><span class="o">*</span><span class="n">XXX</span>

    <span class="k">if</span><span class="p">(</span><span class="n">FREQ</span><span class="o">&gt;=</span><span class="mf">2.460127e15</span><span class="p">):</span> <span class="n">X1218</span><span class="o">=</span><span class="mf">1.64e-17</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.460127e15</span><span class="o">/</span><span class="n">FREQ</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">FREQ</span><span class="o">&gt;=</span><span class="mf">2.110779e15</span><span class="p">):</span> <span class="n">X1420</span><span class="o">=</span><span class="n">SEATON</span><span class="p">(</span><span class="mf">2.110779e15</span><span class="p">,</span><span class="mf">4.13e-18</span><span class="p">,</span><span class="mf">3.</span><span class="p">,</span><span class="mf">0.69</span><span class="p">,</span> <span class="n">FREQ</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">X1044</span><span class="o">+</span><span class="n">X1218</span><span class="o">*</span><span class="n">C1218</span><span class="o">+</span><span class="n">X1420</span><span class="o">*</span><span class="n">C1420</span>

<span class="c1"># ----------------------------------------------------------------------------------------</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">LUKEOP</span><span class="p">(</span> <span class="n">XN1</span><span class="p">,</span>  <span class="n">XO1</span><span class="p">,</span>  <span class="n">XMg2</span><span class="p">,</span>  <span class="n">XSi2</span><span class="p">,</span>  <span class="n">XCa2</span><span class="p">,</span> <span class="n">STIM</span><span class="p">,</span>  <span class="n">FREQ</span><span class="p">,</span>  <span class="n">FREQLG</span><span class="p">,</span>  <span class="n">T</span><span class="p">,</span>  <span class="n">TLOG</span><span class="p">,</span>  <span class="n">TKEV</span><span class="p">):</span>

    <span class="c1">#    N I, O I, Si II, Mg II, Ca II</span>

    <span class="k">return</span> <span class="p">(</span> <span class="n">N1OP</span><span class="p">(</span><span class="n">FREQ</span><span class="p">,</span><span class="n">TKEV</span>          <span class="p">)</span><span class="o">*</span><span class="n">XN1</span> <span class="o">+</span>
	     <span class="n">O1OP</span><span class="p">(</span><span class="n">FREQ</span>               <span class="p">)</span><span class="o">*</span><span class="n">XO1</span> <span class="o">+</span>
	     <span class="n">Mg2OP</span><span class="p">(</span><span class="n">FREQ</span><span class="p">,</span><span class="n">TKEV</span>         <span class="p">)</span><span class="o">*</span><span class="n">XMg2</span><span class="o">+</span>
	     <span class="n">Si2OP</span><span class="p">(</span><span class="n">FREQ</span><span class="p">,</span><span class="n">FREQLG</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">TLOG</span><span class="p">)</span><span class="o">*</span><span class="n">XSi2</span><span class="o">+</span>
	     <span class="n">Ca2OP</span><span class="p">(</span><span class="n">FREQ</span><span class="p">,</span><span class="n">TKEV</span>         <span class="p">)</span><span class="o">*</span><span class="n">XCa2</span><span class="p">)</span><span class="o">*</span><span class="n">STIM</span>

<span class="c1"># ----------------------------------------------------------------------------------------</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">HOTOP</span><span class="p">():</span>
    <span class="k">return</span> <span class="mf">0.0</span> <span class="c1"># dummy function, should fill this</span>

<span class="c1"># ----------------------------------------------------------------------------------------</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ELECOP</span><span class="p">(</span> <span class="n">XNE</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">0.6653E-24</span><span class="o">*</span><span class="n">XNE</span>

<span class="c1"># ----------------------------------------------------------------------------------------</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">H2RAOP</span><span class="p">(</span>  <span class="n">XH1</span><span class="p">,</span>  <span class="n">FREQ</span><span class="p">,</span>  <span class="n">T</span><span class="p">,</span>  <span class="n">TKEV</span><span class="p">,</span>  <span class="n">TLOG</span><span class="p">):</span>


  <span class="n">WW</span><span class="o">=</span><span class="p">(</span><span class="mf">2.997925E18</span><span class="o">/</span><span class="nb">min</span><span class="p">(</span><span class="n">FREQ</span><span class="p">,</span><span class="mf">2.922E15</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
  <span class="n">WW2</span> <span class="o">=</span> <span class="n">WW</span><span class="o">*</span><span class="n">WW</span>

  <span class="n">SIG</span><span class="o">=</span><span class="p">(</span><span class="mf">8.14E-13</span><span class="o">+</span><span class="mf">1.28e-6</span><span class="o">/</span><span class="n">WW</span><span class="o">+</span><span class="mf">1.61e0</span><span class="o">/</span><span class="n">WW2</span><span class="p">)</span><span class="o">/</span><span class="n">WW2</span>
  <span class="n">ARG</span><span class="o">=</span><span class="mf">4.477</span><span class="o">/</span><span class="n">TKEV</span><span class="o">-</span><span class="mf">4.6628E1</span><span class="o">+</span><span class="p">(</span><span class="mf">1.8031E-3</span><span class="o">+</span><span class="p">(</span><span class="o">-</span><span class="mf">5.023E-7</span><span class="o">+</span><span class="p">(</span><span class="mf">8.1424E-11</span><span class="o">-</span><span class="mf">5.0501E-15</span><span class="o">*</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">T</span><span class="o">-</span><span class="mf">1.5</span><span class="o">*</span><span class="n">TLOG</span>
  <span class="n">H1</span><span class="o">=</span><span class="n">XH1</span><span class="o">*</span><span class="mf">2.0</span>

  <span class="k">if</span><span class="p">(</span><span class="n">ARG</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">80.0</span><span class="p">):</span> <span class="k">return</span> <span class="n">exp</span><span class="p">(</span><span class="n">ARG</span><span class="p">)</span><span class="o">*</span><span class="n">H1</span><span class="o">*</span><span class="n">H1</span><span class="o">*</span><span class="n">SIG</span>
  <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="mf">0.0</span>

<span class="c1"># ----------------------------------------------------------------------------------------</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cop</span><span class="p">(</span> <span class="n">T</span><span class="p">,</span>  <span class="n">TKEV</span><span class="p">,</span>  <span class="n">TK</span><span class="p">,</span>  <span class="n">HKT</span><span class="p">,</span>  <span class="n">TLOG</span><span class="p">,</span> <span class="n">XNA</span><span class="p">,</span>  <span class="n">XNE</span><span class="p">,</span>  <span class="n">WLGRID</span><span class="p">,</span> <span class="n">H1</span><span class="p">,</span>  <span class="n">H2</span><span class="p">,</span>  <span class="n">HMIN</span><span class="p">,</span>  <span class="n">HE1</span><span class="p">,</span>  <span class="n">HE2</span><span class="p">,</span>
	 <span class="n">HE3</span><span class="p">,</span>  <span class="n">C1</span><span class="p">,</span>  <span class="n">AL1</span><span class="p">,</span>  <span class="n">SI1</span><span class="p">,</span>  <span class="n">SI2</span><span class="p">,</span><span class="n">CA1</span><span class="p">,</span>  <span class="n">CA2</span><span class="p">,</span>  <span class="n">MG1</span><span class="p">,</span>  <span class="n">MG2</span><span class="p">,</span>  <span class="n">FE1</span><span class="p">,</span> <span class="n">N1</span><span class="p">,</span>  <span class="n">O1</span><span class="p">):</span>

    <span class="n">nW</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">WLGRID</span><span class="p">)</span>
    <span class="n">OPACITY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nW</span><span class="p">)</span>
    <span class="n">SCATTER</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nW</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">iWL</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nW</span><span class="p">):</span>
        <span class="n">FREQ</span><span class="o">=</span><span class="mf">2.997925E18</span><span class="o">/</span><span class="n">WLGRID</span><span class="p">[</span><span class="n">iWL</span><span class="p">]</span>
        <span class="n">FREQLG</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">FREQ</span><span class="p">)</span>
        <span class="n">FREQ15</span><span class="o">=</span><span class="n">FREQ</span><span class="o">*</span><span class="mf">1.E-15</span>
        <span class="n">EHVKT</span><span class="o">=</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">FREQ</span><span class="o">*</span><span class="n">HKT</span><span class="p">)</span>
        <span class="n">STIM</span><span class="o">=</span><span class="mf">1.0</span><span class="o">-</span><span class="n">EHVKT</span>

        <span class="n">ACOOL</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span> <span class="n">ALUKE</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">AHYD</span> <span class="o">=</span> <span class="n">HOP</span><span class="p">(</span><span class="n">XNE</span><span class="p">,</span><span class="n">H1</span><span class="p">,</span><span class="n">H2</span><span class="p">,</span><span class="n">FREQ</span><span class="p">,</span><span class="n">FREQLG</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">TLOG</span><span class="p">,</span><span class="n">TKEV</span><span class="p">,</span><span class="n">STIM</span><span class="p">,</span><span class="n">EHVKT</span><span class="p">)</span>
        <span class="n">AH2P</span> <span class="o">=</span> <span class="n">H2PLOP</span><span class="p">(</span><span class="n">H1</span><span class="p">,</span><span class="n">H2</span><span class="p">,</span><span class="n">FREQ</span><span class="p">,</span><span class="n">FREQLG</span><span class="p">,</span><span class="n">FREQ15</span><span class="p">,</span><span class="n">TKEV</span><span class="p">,</span><span class="n">STIM</span><span class="p">)</span>
        <span class="n">AHMIN</span> <span class="o">=</span> <span class="n">HMINOP</span><span class="p">(</span><span class="n">H1</span><span class="p">,</span><span class="n">HMIN</span><span class="p">,</span><span class="n">FREQ</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">TKEV</span><span class="p">,</span><span class="n">XNE</span><span class="p">,</span><span class="n">EHVKT</span><span class="p">)</span>
        <span class="n">SIGH</span> <span class="o">=</span> <span class="n">HRAYOP</span><span class="p">(</span><span class="n">H1</span><span class="p">,</span><span class="n">FREQ</span><span class="p">)</span>
        <span class="n">AHE1</span> <span class="o">=</span> <span class="n">HE1OP</span><span class="p">(</span><span class="n">HE1</span><span class="p">,</span><span class="n">HE2</span><span class="p">,</span><span class="n">XNE</span><span class="p">,</span><span class="n">FREQ</span><span class="p">,</span><span class="n">FREQLG</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">TKEV</span><span class="p">,</span><span class="n">TLOG</span><span class="p">,</span><span class="n">EHVKT</span><span class="p">,</span><span class="n">STIM</span><span class="p">)</span>
        <span class="n">AHE2</span> <span class="o">=</span> <span class="n">HE2OP</span><span class="p">(</span><span class="n">HE2</span><span class="p">,</span> <span class="n">HE3</span><span class="p">,</span><span class="n">XNE</span><span class="p">,</span><span class="n">FREQ</span><span class="p">,</span><span class="n">FREQLG</span><span class="p">,</span><span class="n">T</span><span class="p">,</span> <span class="n">TKEV</span><span class="p">,</span> <span class="n">TLOG</span><span class="p">,</span> <span class="n">EHVKT</span><span class="p">,</span><span class="n">STIM</span><span class="p">)</span>
        <span class="n">AHEMIN</span> <span class="o">=</span> <span class="n">HEMIOP</span><span class="p">(</span><span class="n">HE1</span><span class="p">,</span><span class="n">FREQ</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">XNE</span><span class="p">)</span>
        <span class="n">SIGHE</span> <span class="o">=</span> <span class="n">HERAOP</span><span class="p">(</span><span class="n">HE1</span><span class="p">,</span><span class="n">FREQ</span><span class="p">)</span>

        <span class="k">if</span><span class="p">(</span><span class="n">T</span> <span class="o">&lt;</span> <span class="mf">12000.</span><span class="p">):</span>
            <span class="n">ACOOL</span> <span class="o">=</span> <span class="n">COOLOP</span><span class="p">(</span><span class="n">C1</span> <span class="p">,</span><span class="n">MG1</span><span class="p">,</span> <span class="n">AL1</span><span class="p">,</span><span class="n">SI1</span><span class="p">,</span> <span class="n">FE1</span><span class="p">,</span><span class="n">STIM</span><span class="p">,</span><span class="n">FREQ</span><span class="p">,</span><span class="n">FREQLG</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">TLOG</span><span class="p">,</span><span class="n">TKEV</span><span class="p">,</span><span class="n">HKT</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">T</span> <span class="o">&lt;</span> <span class="mf">30000.</span><span class="p">):</span>
            <span class="n">ALUKE</span> <span class="o">=</span> <span class="n">LUKEOP</span><span class="p">(</span> <span class="n">N1</span><span class="p">,</span> <span class="n">O1</span><span class="p">,</span> <span class="n">MG2</span><span class="p">,</span> <span class="n">SI2</span><span class="p">,</span> <span class="n">CA2</span><span class="p">,</span><span class="n">STIM</span><span class="p">,</span><span class="n">FREQ</span><span class="p">,</span><span class="n">FREQLG</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">TLOG</span><span class="p">,</span><span class="n">TKEV</span><span class="p">)</span>

        <span class="n">AHOT</span> <span class="o">=</span> <span class="n">HOTOP</span><span class="p">()</span>
        <span class="n">SIGEL</span> <span class="o">=</span> <span class="n">ELECOP</span><span class="p">(</span><span class="n">XNE</span><span class="p">)</span>
        <span class="n">SIGH2</span> <span class="o">=</span> <span class="n">H2RAOP</span><span class="p">(</span><span class="n">H1</span><span class="p">,</span><span class="n">FREQ</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">TKEV</span><span class="p">,</span><span class="n">TLOG</span><span class="p">)</span>

        <span class="n">A</span><span class="o">=</span><span class="n">AHYD</span><span class="o">+</span><span class="n">AHMIN</span><span class="o">+</span><span class="n">AH2P</span><span class="o">+</span><span class="n">AHE1</span><span class="o">+</span><span class="n">AHE2</span><span class="o">+</span><span class="n">AHEMIN</span><span class="o">+</span><span class="n">ACOOL</span><span class="o">+</span><span class="n">ALUKE</span><span class="o">+</span><span class="n">AHOT</span>
        <span class="n">B</span><span class="o">=</span><span class="n">SIGH</span><span class="o">+</span><span class="n">SIGHE</span><span class="o">+</span><span class="n">SIGEL</span><span class="o">+</span><span class="n">SIGH2</span>

        <span class="n">OPACITY</span><span class="p">[</span><span class="n">iWL</span><span class="p">]</span><span class="o">=</span><span class="n">A</span><span class="o">+</span><span class="n">B</span>
        <span class="n">SCATTER</span><span class="p">[</span><span class="n">iWL</span><span class="p">]</span><span class="o">=</span><span class="n">B</span>

    <span class="k">return</span> <span class="n">OPACITY</span><span class="p">,</span> <span class="n">SCATTER</span>

<span class="c1"># ----------------------------------------------------------------------------------------</span>

</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, C. Osborne.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>